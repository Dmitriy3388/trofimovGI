{% extends "mebel/base.html" %}
{% load static %}

{% block title %}{{ material.name }}{% endblock %}

{% block extra_css %}
<style>
.material-detail-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.material-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
}

.material-title {
    color: #2c3e50;
    font-weight: 600;
    margin: 0;
}

.material-content {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
    margin-bottom: 30px;
}

@media (max-width: 768px) {
    .material-content {
        grid-template-columns: 1fr;
    }

    .material-header {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
    }
}

.status-badge {
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: 500;
    font-size: 0.9rem;
}

.status-available {
    background: linear-gradient(135deg, #4ade80, #16a34a);
    color: white;
}

.status-warning {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    color: white;
}

.status-danger {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
}

.operations-table {
    width: 100%;
    border-collapse: collapse;
}

.operations-table th {
    background: #f8f9fa;
    padding: 12px 15px;
    text-align: left;
    font-weight: 600;
    color: #5f6368;
    border-bottom: 2px solid #e9ecef;
}

.operations-table td {
    padding: 12px 15px;
    border-bottom: 1px solid #f1f3f4;
}

.operations-table tr:hover {
    background-color: #f8f9fa;
}

.image-container {
    text-align: center;
    padding: 20px;
}

.material-image {
    max-width: 100%;
    max-height: 400px;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}
</style>
{% endblock %}

{% block content %}
<div class="material-detail-container">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="material-header">
        <h1 class="material-title">üì¶ {{ material.name }}</h1>
        <span class="status-badge {% if material.availability_status == 'green' %}status-available{% elif material.availability_status == 'yellow' %}status-warning{% else %}status-danger{% endif %}">
            {% if material.availability_status == 'green' %}
                ‚úÖ –í –Ω–∞–ª–∏—á–∏–∏
            {% elif material.availability_status == 'yellow' %}
                ‚ö†Ô∏è –ú–∞–ª–æ –æ—Å—Ç–∞–ª–æ—Å—å
            {% else %}
                ‚ùå –ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏
            {% endif %}
        </span>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div class="material-content">
        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="card-modern">
            <div class="card-modern-header">
                <h2 class="card-modern-title">üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–∞—Ç–µ—Ä–∏–∞–ª–µ</h2>
            </div>

            <div class="card-modern-body">
                <div class="detail-row">
                    <span class="detail-label">üè∑Ô∏è –ö–∞—Ç–µ–≥–æ—Ä–∏—è:</span>
                    <span class="detail-value">{{ material.category.name }}</span>
                </div>

                <div class="detail-row">
                    <span class="detail-label">üí∞ –¶–µ–Ω–∞:</span>
                    <span class="detail-value">{{ material.price }} ‚ÇΩ</span>
                </div>

                <div class="detail-row">
                    <span class="detail-label">üìä –ë–∞–ª–∞–Ω—Å –Ω–∞ —Å–∫–ª–∞–¥–µ:</span>
                    <span class="detail-value">{{ material.balance }} —à—Ç.</span>
                </div>

                <div class="detail-row">
                    <span class="detail-label">üîí –ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ:</span>
                    <span class="detail-value">{{ material.reserved }} —à—Ç.</span>
                </div>

                <div class="detail-row">
                    <span class="detail-label">‚úÖ –î–æ—Å—Ç—É–ø–Ω–æ:</span>
                    <span class="detail-value" style="color: {% if material.availability_status == 'green' %}#16a34a{% elif material.availability_status == 'yellow' %}#d97706{% else %}#dc2626{% endif %}; font-weight: 600;">
                        {{ material.available }} —à—Ç.
                    </span>
                </div>

                <div class="detail-row">
                    <span class="detail-label">‚ö†Ô∏è –ù–µ—Ö–≤–∞—Ç–∫–∞:</span>
                    <span class="detail-value" style="color: {% if material.lack > 0 %}#dc2626{% else %}#16a34a{% endif %}; font-weight: 600;">
                        {{ material.lack }} —à—Ç.
                    </span>
                </div>

                <div class="detail-row">
                    <span class="detail-label">üè¢ –ü–æ—Å—Ç–∞–≤—â–∏–∫:</span>
                    <span class="detail-value">
                        {% if material.supplier %}
                            {{ material.supplier.name }}
                            {% if material.supplier.phone %}
                                <br><small style="color: #6b7280;">üìû {{ material.supplier.phone }}</small>
                            {% endif %}
                        {% else %}
                            <span style="color: #9ca3af;">–ù–µ —É–∫–∞–∑–∞–Ω</span>
                        {% endif %}
                    </span>
                </div>

                {% if material.description %}
                <div class="detail-row">
                    <span class="detail-label">üìù –û–ø–∏—Å–∞–Ω–∏–µ:</span>
                    <span class="detail-value">{{ material.description }}</span>
                </div>
                {% endif %}
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
            <div class="card-actions">
                {% if user.groups.all.0.name == '–û—Ç–¥–µ–ª –ú–¢–û' or user.is_superuser %}
                <button type="button" class="btn-modern btn-danger-modern" data-bs-toggle="modal" data-bs-target="#writeOffModal">
                    <i class="bi bi-arrow-up-circle"></i>
                    –°–ø–∏—Å–∞—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã
                </button>

                <button type="button" class="btn-modern btn-primary-gradient" data-bs-toggle="modal" data-bs-target="#receiptModal">
                    <i class="bi bi-arrow-down-circle"></i>
                    –ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
                </button>

                <a href="{% url 'mebel:material_edit' material.id %}" class="btn-modern btn-outline-modern">
                    <i class="bi bi-pencil-square"></i>
                    –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                </a>
                {% endif %}
            </div>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ -->
        <div class="card-modern">
            <div class="card-modern-header">
                <h2 class="card-modern-title">üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</h2>
            </div>

            <div class="image-container">
                <img src="{% if material.image %}{{ material.image.url }}{% else %}{% static 'img/no_image.png' %}{% endif %}"
                     alt="{{ material.name }}"
                     class="material-image">
            </div>
        </div>
    </div>

    <!-- –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π -->
    <div class="card-modern">
        <div class="card-modern-header">
            <h2 class="card-modern-title">üìä –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</h2>
        </div>

        <div class="card-modern-body">
            {% if operations %}
            <div class="table-responsive">
                <table class="operations-table">
                    <thead>
                        <tr>
                            <th>üìÖ –î–∞—Ç–∞</th>
                            <th>üîß –¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏</th>
                            <th>üì¶ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                            <th>üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</th>
                            <th>üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for op in operations %}
                        <tr>
                            <td>{{ op.created|date:"d.m.Y H:i" }}</td>
                            <td>
                                <span class="badge {% if op.operation_type == 'receipt' %}bg-success{% else %}bg-danger{% endif %}">
                                    {{ op.get_operation_type_display }}
                                </span>
                            </td>
                            <td>{{ op.quantity }} —à—Ç.</td>
                            <td>{{ op.notes|default:"-" }}</td>
                            <td>{{ op.user.username|default:"–°–∏—Å—Ç–µ–º–∞" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-4">
                <p style="color: #6b7280; font-size: 1.1rem;">üì≠ –û–ø–µ—Ä–∞—Ü–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ -->
    <div class="card-actions" style="justify-content: flex-start; padding: 0; margin-top: 20px;">
        <a href="{% url 'mebel:material_list' %}" class="btn-modern btn-outline-modern">
            <i class="bi bi-arrow-left"></i>
            –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
        </a>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ (–æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) -->
<div class="modal fade" id="writeOffModal" tabindex="-1" aria-labelledby="writeOffModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="writeOffModalLabel">
                    <i class="bi bi-arrow-up-circle me-2"></i>
                    –°–ø–∏—Å–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞: {{ material.name }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    </div>
                    <p class="mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ä–º—ã...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="receiptModal" tabindex="-1" aria-labelledby="receiptModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="receiptModalLabel">
                    <i class="bi bi-arrow-down-circle me-2"></i>
                    –ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞: {{ material.name }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    </div>
                    <p class="mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ä–º—ã...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block domready %}
<script>
// –î–ª—è –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è
$('#receiptModal').on('show.bs.modal', function (event) {
    var modal = $(this);
    $.ajax({
        url: "{% url 'mebel:material_receipt' material.id %}",
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            if (response.html) {
                modal.find('.modal-content').html(response.html);

                // –í–µ—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ —Ñ–æ—Ä–º—É
                modal.find('form').on('submit', function(e) {
                    e.preventDefault();
                    var form = $(this);

                    $.ajax({
                        type: 'POST',
                        url: form.attr('action'),
                        data: form.serialize(),
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        success: function(data) {
                            if (data.success) {
                                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                                showAlert('success', data.message);
                                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                                modal.modal('hide');
                                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
                                setTimeout(function() {
                                    location.reload();
                                }, 1000);
                            } else {
                                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
                                showFormErrors(form, data.errors);
                            }
                        },
                        error: function() {
                            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ä–º—ã');
                        }
                    });
                });
            }
        },
        error: function() {
            modal.find('.modal-content').html(
                '<div class="modal-header"><h5 class="modal-title">–û—à–∏–±–∫–∞</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>' +
                '<div class="modal-body"><p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ä–º—É –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è.</p></div>'
            );
        }
    });
});

// –î–ª—è —Å–ø–∏—Å–∞–Ω–∏—è - –¢–ê–ö–ñ–ï –ò–°–ü–†–ê–í–ò–¢–¨
$('#writeOffModal').on('show.bs.modal', function (event) {
    var modal = $(this);
    $.ajax({
        url: "{% url 'mebel:material_write_off' material.id %}",
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            if (response.html) {
                modal.find('.modal-content').html(response.html);

                // –í–µ—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ —Ñ–æ—Ä–º—É
                modal.find('form').on('submit', function(e) {
                    e.preventDefault();
                    var form = $(this);

                    $.ajax({
                        type: 'POST',
                        url: form.attr('action'),
                        data: form.serialize(),
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        success: function(data) {
                            if (data.success) {
                                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                                showAlert('success', data.message);
                                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                                modal.modal('hide');
                                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
                                setTimeout(function() {
                                    location.reload();
                                }, 1000);
                            } else {
                                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
                                showFormErrors(form, data.errors);
                            }
                        },
                        error: function() {
                            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ä–º—ã');
                        }
                    });
                });
            }
        },
        error: function() {
            modal.find('.modal-content').html(
                '<div class="modal-header"><h5 class="modal-title">–û—à–∏–±–∫–∞</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>' +
                '<div class="modal-body"><p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ä–º—É —Å–ø–∏—Å–∞–Ω–∏—è.</p></div>'
            );
        }
    });
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
function showAlert(type, message) {
    // –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –Ω–∞—Ö–æ–¥–∏–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∞–ª–µ—Ä—Ç–æ–≤
    var alertContainer = $('.alert-container');
    if (alertContainer.length === 0) {
        alertContainer = $('<div class="alert-container" style="position: fixed; top: 20px; right: 20px; z-index: 1060;"></div>');
        $('body').append(alertContainer);
    }

    var alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    var alertHtml = '<div class="alert ' + alertClass + ' alert-dismissible fade show" role="alert">' +
                    message +
                    '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                    '</div>';

    alertContainer.append(alertHtml);

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(function() {
        alertContainer.find('.alert').first().alert('close');
    }, 5000);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –æ—à–∏–±–æ–∫ —Ñ–æ—Ä–º—ã
function showFormErrors(form, errors) {
    // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ—à–∏–±–∫–∏
    form.find('.error-text').remove();
    form.find('.is-invalid').removeClass('is-invalid');

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–æ–≤—ã–µ –æ—à–∏–±–∫–∏
    $.each(errors, function(field, messages) {
        var fieldInput = form.find('[name="' + field + '"]');
        fieldInput.addClass('is-invalid');
        fieldInput.after('<div class="error-text text-danger small">' + messages.join(', ') + '</div>');
    });
}
</script>
{% endblock %}