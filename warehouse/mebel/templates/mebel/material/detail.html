{% extends "mebel/base.html" %}
{% load static %}

{% block title %}{{ material.name }}{% endblock %}

{% block content %}
  <h1>{{ material.name }}</h1>

  <div class="row">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h5>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–∞—Ç–µ—Ä–∏–∞–ª–µ</h5>
        </div>
        <div class="card-body">
          <p><strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong> {{ material.category.name }}</p>
          <p><strong>–¶–µ–Ω–∞:</strong> {{ material.price }} ‚ÇΩ</p>
          <p><strong>–ë–∞–ª–∞–Ω—Å –Ω–∞ —Å–∫–ª–∞–¥–µ:</strong> {{ material.balance }}</p>
          <p><strong>–ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ:</strong> {{ material.reserved }}</p>
          <p><strong>–î–æ—Å—Ç—É–ø–Ω–æ:</strong> <span style="color: {{ material.availability_status }}; font-weight: bold;">{{ material.available }}</span></p>
          <p><strong>–ù–µ—Ö–≤–∞—Ç–∫–∞:</strong> <span style="color: {% if material.lack > 0 %}red{% else %}green{% endif %}; font-weight: bold;">{{ material.lack }}</span></p>
          {% if material.description %}
          <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> {{ material.description }}</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- –°–µ–∫—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è - –≤—Å–µ–≥–¥–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</h5>
            </div>
            <div class="card-body text-center">
                <!-- –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ –Ω–µ—Ç —Å–≤–æ–µ–≥–æ -->
                <img src="{% if material.image %}{{ material.image.url }}{% else %}{% static 'img/no_image.png' %}{% endif %}"
                     alt="{{ material.name }}" class="img-fluid" style="max-height: 300px;">
            </div>
        </div>
    </div>
  </div>

  <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
  <div class="mt-4">
      <div class="btn-group" role="group">
          <!-- –ö–Ω–æ–ø–∫–∞ —Å–ø–∏—Å–∞–Ω–∏—è -->
          <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#writeOffModal">
              üìâ –°–ø–∏—Å–∞—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã
          </button>

          <!-- –ö–Ω–æ–ø–∫–∞ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è -->
          <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#receiptModal">
              üìà –ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
          </button>

          <!-- –ù–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
          <a href="{% url 'mebel:material_edit' material.id %}" class="btn btn-warning">
              ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª
          </a>
      </div>
  </div>

  <!-- –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π -->
  <div class="mt-4">
    <div class="card">
      <div class="card-header">
        <h5>üìä –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</h5>
      </div>
      <div class="card-body">
        {% if operations %}
          <div class="table-responsive">
            <table class="table table-sm table-hover">
              <thead class="table-light">
                <tr>
                  <th>–î–∞—Ç–∞</th>
                  <th>–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏</th>
                  <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                  <th>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</th>
                  <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                </tr>
              </thead>
              <tbody>
                {% for op in operations %}
                <tr>
                  <td>{{ op.created|date:"d.m.Y H:i" }}</td>
                  <td>
                    <span class="badge {% if op.operation_type == 'receipt' %}bg-success{% else %}bg-danger{% endif %}">
                      {{ op.get_operation_type_display }}
                    </span>
                  </td>
                  <td>{{ op.quantity }} —à—Ç.</td>
                  <td>{{ op.notes|default:"-" }}</td>
                  <td>{{ op.user.username|default:"–°–∏—Å—Ç–µ–º–∞" }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted text-center">–û–ø–µ—Ä–∞—Ü–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è -->
  {% with modal_id="writeOffModal" modal_ajax_url=material.get_write_off_url %}
  {% include "includes/modal.html" %}
  {% endwith %}

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è -->
  {% with modal_id="receiptModal" modal_ajax_url=material.get_receipt_url %}
  {% include "includes/modal.html" %}
  {% endwith %}

{% endblock %}

{% block domready %}
<script>
// –î–ª—è —Å–ø–∏—Å–∞–Ω–∏—è
$('#writeOffModal').on('show.bs.modal', function (event) {
    var modal = $(this);
    $.ajax({
        url: "{% url 'mebel:material_write_off' material.id %}",
        context: document.body,
        success: function(response) {
            modal.find('.modal-content').html(response);

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã —á–µ—Ä–µ–∑ AJAX
            modal.find('form').on('submit', function(e) {
                e.preventDefault();
                var form = $(this);

                $.ajax({
                    type: 'POST',
                    url: form.attr('action'),
                    data: form.serialize(),
                    success: function(data) {
                        // –ü—Ä–æ—Å—Ç–æ –∑–∞–º–µ–Ω—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                        modal.find('.modal-content').html(data);
                    },
                    error: function() {
                        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ä–º—ã');
                    }
                });
            });
        },
        error: function() {
            modal.find('.modal-content').html('<div class="modal-header"><h5 class="modal-title">–û—à–∏–±–∫–∞</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body"><p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ä–º—É —Å–ø–∏—Å–∞–Ω–∏—è.</p></div>');
        }
    });
});

// –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è
$('#receiptModal').on('show.bs.modal', function (event) {
    var modal = $(this);
    $.ajax({
        url: "{% url 'mebel:material_receipt' material.id %}",
        context: document.body,
        success: function(response) {
            modal.find('.modal-content').html(response);

            modal.find('form').on('submit', function(e) {
                e.preventDefault();
                var form = $(this);

                $.ajax({
                    type: 'POST',
                    url: form.attr('action'),
                    data: form.serialize(),
                    success: function(data) {
                        modal.find('.modal-content').html(data);
                    },
                    error: function() {
                        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ä–º—ã');
                    }
                });
            });
        },
        error: function() {
            modal.find('.modal-content').html('<div class="modal-header"><h5 class="modal-title">–û—à–∏–±–∫–∞</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body"><p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ä–º—É –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è.</p></div>');
        }
    });
});
</script>
{% endblock %}