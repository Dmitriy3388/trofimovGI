{% extends "mebel/base.html" %}

{% block content %}
<h1>{% if category %}{{ category.name }}{% else %}Все материалы{% endif %}</h1>

<!-- Сообщения об успехе/ошибках -->
{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endfor %}
{% endif %}

<div class="categories mb-4">
    <h3>Категории</h3>
    <div class="d-flex flex-wrap gap-2">
        <a href="{% url 'mebel:material_list' %}" class="btn {% if not category %}btn-primary{% else %}btn-outline-primary{% endif %}">
            Все
        </a>
        {% for c in categories %}
        <a href="{{ c.get_absolute_url }}" class="btn {% if category.slug == c.slug %}btn-primary{% else %}btn-outline-primary{% endif %}">
            {{ c.name }}
        </a>
        {% endfor %}
    </div>
</div>



{% block contents %}
<div class="container mt-4">
  <h2 class="mb-4">Список материалов</h2>
  <div>
    <table>
      <thead>
        <tr>
          <th>
              <a href="?sort=name&order={% if current_sort == 'name' and current_order == 'asc' %}desc{% else %}asc{% endif %}{% if category %}&category={{ category.slug }}{% endif %}" class="sort-link"
              style="text-decoration: none; color: inherit;">
                Название
                {% if current_sort == 'name' %}
                    {% if current_order == 'asc' %}↑{% else %}↓{% endif %}
                {% endif %}
              </a>
          </th>
          <th>
              <a href="?sort=price&order={% if current_sort == 'price' and current_order == 'asc' %}desc{% else %}asc{% endif %}{% if category %}&category={{ category.slug }}{% endif %}" class="sort-link"
              style="text-decoration: none; color: inherit;">
                Цена
                {% if current_sort == 'price' %}
                    {% if current_order == 'asc' %}↑{% else %}↓{% endif %}
                {% endif %}
              </a>
          </th>
          <th>
              <a href="?sort=balance&order={% if current_sort == 'balance' and current_order == 'asc' %}desc{% else %}asc{% endif %}{% if category %}&category={{ category.slug }}{% endif %}" class="sort-link"
              style="text-decoration: none; color: inherit;">
                Баланс
                {% if current_sort == 'balance' %}
                    {% if current_order == 'asc' %}↑{% else %}↓{% endif %}
                {% endif %}
              </a>
          </th>
          <th>
              <a href="?sort=reserved&order={% if current_sort == 'reserved' and current_order == 'asc' %}desc{% else %}asc{% endif %}{% if category %}&category={{ category.slug }}{% endif %}" class="sort-link"
              style="text-decoration: none; color: inherit;">
                Зарезервировано
                {% if current_sort == 'reserved' %}
                    {% if current_order == 'asc' %}↑{% else %}↓{% endif %}
                {% endif %}
              </a>
          </th>
          <th>
              <a href="?sort=available&order={% if current_sort == 'available' and current_order == 'asc' %}desc{% else %}asc{% endif %}{% if category %}&category={{ category.slug }}{% endif %}" class="sort-link"
              style="text-decoration: none; color: inherit;">
                Доступно
                {% if current_sort == 'available' %}
                    {% if current_order == 'asc' %}↑{% else %}↓{% endif %}
                {% endif %}
              </a>
          </th>
          <th>
            <a href="?sort=lack&order={% if current_sort == 'lack' and current_order == 'asc' %}desc{% else %}asc{% endif %}{% if category %}&category={{ category.slug }}{% endif %}"
               style="text-decoration: none; color: inherit;">
              Нехватка
              {% if current_sort == 'lack' %}
                {% if current_order == 'asc' %}↑{% else %}↓{% endif %}
              {% endif %}
            </a>
          </th>
          <th>
            <a href="?sort=supplier&order={% if current_sort == 'supplier' and current_order == 'asc' %}desc{% else %}asc{% endif %}{% if category %}&category={{ category.slug }}{% endif %}"
               style="text-decoration: none; color: inherit;">
                Поставщик
                {% if current_sort == 'supplier' %}
                    {% if current_order == 'asc' %}↑{% else %}↓{% endif %}
                {% endif %}
            </a>
          </th>
        </tr>
      </thead>
      <tbody>
        {% for material in materials %}
        <tr class="clickable-row" data-href="{{ material.get_absolute_url }}">
          <td><strong>{{ material.name }}</strong></td>
          <td>{{ material.price }} ₽</td>
          <td>{{ material.balance }}</td>
          <td>{{ material.reserved }}</td>
          <td>
            <span style="color: {{ material.availability_status }}; font-weight: bold;">
              {{ material.available }}
            </span>
          </td>
          <td>
            <span style="color: {% if material.lack > 0 %}red{% else %}green{% endif %}; font-weight: bold;">
              {{ material.lack }}
            </span>
          </td>
          <td>
            {% if material.supplier %}
                {{ material.supplier.name }}
            {% else %}
                <span class="text-muted">Не указан</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

<!-- Пагинация -->
{% include "pagination.html" %}

<style>
  .table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .table th {
    background: #f8f9fa;
    padding: 1rem;
    font-weight: 600;
    text-align: left;
    border-bottom: 2px solid #dee2e6;
  }

  .table td {
    padding: 1rem;
    border-bottom: 1px solid #dee2e6;
  }

  .table tr:last-child td {
    border-bottom: none;
  }

  .clickable-row {
    cursor: pointer;
    transition: background-color 0.2s ease;
  }

  .clickable-row:hover {
    background-color: #f8f9fa;
  }

  .btn-group .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const rows = document.querySelectorAll('.clickable-row');
    rows.forEach(row => {
      row.addEventListener('click', function(e) {
        // Игнорируем клики по кнопкам действий
        if (!e.target.closest('.btn-group')) {
          window.location.href = this.dataset.href;
        }
      });
    });
  });
</script>
{% endblock %}