{% extends "mebel/base.html" %}
{% load static %}

{% block extra_css %}
<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
.chart-container {
    background: white;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 30px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    width: 50%;
    height: 500px;
    float: left;
    margin-right: 20px;
    position: relative; /* –î–æ–±–∞–≤–ª—è–µ–º */
    overflow: hidden; /* –û–±—Ä–µ–∑–∞–µ–º –≤—ã—Ö–æ–¥—è—â–µ–µ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã */
}

.search-container {
    margin-bottom: 20px;
    position: relative;
}

#materialSearch {
    width: 100%;
    padding: 10px;
    border: 2px solid #e9ecef;
    border-radius: 6px;
    font-size: 14px;
}

.autocomplete-results {
    position: absolute;
    background: white;
    border: 1px solid #ddd;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    width: 100%;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    border-radius: 0 0 6px 6px;
    display: none;
}

.chart-wrapper {
    width: 100%;
    height: 200px; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ */
    position: relative;
}

#materialChart {
    width: 100% !important;
    height: 100% !important;
    display: block;
}

.autocomplete-item.active {
    background-color: #007bff !important;
    color: white !important;
}

.autocomplete-item.active small {
    color: #e6f3ff !important;
}

/* –£–ª—É—á—à–∏–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ */
.search-container {
    position: relative;
    margin-bottom: 15px;
}

#materialSearch {
    width: 100%;
    padding: 10px 15px;
    border: 2px solid #e9ecef;
    border-radius: 25px;
    font-size: 14px;
    outline: none;
    transition: border-color 0.3s;
}

#materialSearch:focus {
    border-color: #007bff;
}

.autocomplete-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-top: none;
    border-radius: 0 0 10px 10px;
    max-height: 250px;
    overflow-y: auto;
    z-index: 1000;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    display: none;
}

.material-info {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
    font-size: 14px;
}

.chart-controls {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    align-items: center;
    flex-wrap: wrap;
}

.period-select {
    padding: 6px 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.materials-table-container {
    width: calc(50% - 20px);
    float: right;
}

.table {
    font-size: 14px;
}

.btn-sm {
    padding: 4px 8px;
    font-size: 12px;
}

.action-buttons {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
}

.clearfix::after {
    content: "";
    clear: both;
    display: table;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
@media (max-width: 768px) {
    .chart-container,
    .materials-table-container {
        width: 100%;
        float: none;
        margin-right: 0;
        margin-bottom: 20px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>{% if category %}{{ category.name }}{% else %}–í—Å–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã{% endif %}</h1>

    <div class="clearfix">
        <!-- –ë–ª–æ–∫ —Å –≥—Ä–∞—Ñ–∏–∫–æ–º -->
        <!-- –í –±–ª–æ–∫–µ —Å –≥—Ä–∞—Ñ–∏–∫–æ–º –æ–±–Ω–æ–≤–∏–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É -->
        <div class="chart-container">
            <h5>üìä –ì—Ä–∞—Ñ–∏–∫ –Ω–∞–ª–∏—á–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</h5>

            <div class="search-container">
                <input type="text" id="materialSearch" placeholder="üîç –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞...">
                <div id="autocompleteResults" class="autocomplete-results"></div>
            </div>

            <div class="material-info" id="materialInfo" style="display: none;">
                <h6 id="materialName"></h6>
                <div class="row">
                    <div class="col-6">
                        <small>–ë–∞–ª–∞–Ω—Å: <strong id="currentBalance"></strong></small>
                    </div>
                    <div class="col-6">
                        <small>–î–æ—Å—Ç—É–ø–Ω–æ: <strong id="currentAvailable"></strong></small>
                    </div>
                </div>
            </div>

            <div class="chart-controls">
                <label for="periodSelect" class="small">–ü–µ—Ä–∏–æ–¥:</label>
                <select id="periodSelect" class="period-select">
                    <option value="3">3 –º–µ—Å</option>
                    <option value="6">6 –º–µ—Å</option>
                    <option value="12" selected>1 –≥–æ–¥</option>
                </select>
                <button id="refreshChart" class="btn btn-outline-secondary btn-sm">üîÑ</button>
            </div>

            <!-- –û–±–µ—Ä–Ω–µ–º canvas –≤ div —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –≤—ã—Å–æ—Ç–æ–π -->
            <div class="chart-wrapper">
                <canvas id="materialChart"></canvas>
            </div>
        </div>

        <!-- –¢–∞–±–ª–∏—Ü–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ -->
        <div class="materials-table-container">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5>–°–ø–∏—Å–æ–∫ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</h5>
                <div>
                    {% if user.groups.all.0.name == '–û—Ç–¥–µ–ª –ú–¢–û' or user.is_superuser %}
                    <a href="{% url 'mebel:material_create' %}" class="btn btn-primary btn-sm">+ –î–æ–±–∞–≤–∏—Ç—å</a>
                    {% endif %}
                </div>
            </div>

            <!-- –°–æ–æ–±—â–µ–Ω–∏—è –æ–± —É—Å–ø–µ—Ö–µ/–æ—à–∏–±–∫–∞—Ö -->
            {% if messages %}
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
            {% endif %}

            <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
            <div class="categories mb-3">
                <div class="d-flex flex-wrap gap-1">
                    <a href="{% url 'mebel:material_list' %}" class="btn {% if not category %}btn-primary{% else %}btn-outline-primary{% endif %} btn-sm">
                        –í—Å–µ
                    </a>
                    {% for c in categories %}
                    <a href="{{ c.get_absolute_url }}" class="btn {% if category.slug == c.slug %}btn-primary{% else %}btn-outline-primary{% endif %} btn-sm">
                        {{ c.name }}
                    </a>
                    {% endfor %}
                </div>
            </div>

            <!-- –¢–∞–±–ª–∏—Ü–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ -->
            <div class="table-responsive">
                <table class="table table-sm table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                            <th>–¶–µ–Ω–∞</th>
                            <th>–ë–∞–ª–∞–Ω—Å</th>
                            <th>–î–æ—Å—Ç—É–ø–Ω–æ</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for material in materials %}
                        <tr data-material-id="{{ material.id }}">
                            <td>
                                <strong>{{ material.name }}</strong>
                                {% if material.supplier %}
                                <br><small class="text-muted">{{ material.supplier.name }}</small>
                                {% endif %}
                            </td>
                            <td>{{ material.price }} ‚ÇΩ</td>
                            <td>{{ material.balance }}</td>
                            <td>
                                <span class="badge {% if material.availability_status == 'green' %}bg-success{% elif material.availability_status == 'yellow' %}bg-warning{% else %}bg-danger{% endif %}">
                                    {{ material.available }}
                                </span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-info btn-sm show-chart"
                                            data-material-id="{{ material.id }}"
                                            data-material-name="{{ material.name }}"
                                            title="–ü–æ–∫–∞–∑–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫">
                                        üìä
                                    </button>
                                    <a href="{{ material.get_absolute_url }}" class="btn btn-primary btn-sm" title="–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏">
                                        üëÅÔ∏è
                                    </a>
                                    {% if user.groups.all.0.name == '–û—Ç–¥–µ–ª –ú–¢–û' or user.is_superuser %}
                                    <a href="{% url 'mebel:material_edit' material.id %}" class="btn btn-warning btn-sm" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                        ‚úèÔ∏è
                                    </a>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
            {% include "pagination.html" %}
        </div>
    </div>
</div>
{% endblock %}

{% block domready %}
<script>
let materialChart = null;
let currentMaterialId = null;

// –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–ø–∏—Å–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è
function setupAutocomplete() {
    const searchInput = document.getElementById('materialSearch');
    const resultsContainer = document.getElementById('autocompleteResults');
    let timeoutId = null;

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞
    function performSearch(query) {
        if (!query || query.length < 2) {
            resultsContainer.style.display = 'none';
            return;
        }

        // –§–æ—Ä–º–∏—Ä—É–µ–º URL –ø—Ä–∞–≤–∏–ª—å–Ω–æ
        const url = `{% url 'mebel:material_autocomplete' %}?q=${encodeURIComponent(query)}`;
        console.log('Search URL:', url);

        fetch(url, {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(materials => {
            console.log('Received materials:', materials);
            displayResults(materials);
        })
        .catch(error => {
            console.error('Search error:', error);
            displayError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    function displayResults(materials) {
        resultsContainer.innerHTML = '';

        if (materials && materials.length > 0) {
            materials.forEach(material => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                item.innerHTML = `
                    <div><strong>${this.escapeHtml(material.name)}</strong></div>
                    <small>–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${this.escapeHtml(material.category)} | –ë–∞–ª–∞–Ω—Å: ${material.balance}</small>
                `;
                item.addEventListener('click', () => {
                    this.selectMaterial(material);
                });
                resultsContainer.appendChild(item);
            });
            resultsContainer.style.display = 'block';
        } else {
            this.displayNoResults();
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—à–∏–±–∫–∏
    function displayError(message) {
        resultsContainer.innerHTML = `<div class="autocomplete-item text-danger">${message}</div>`;
        resultsContainer.style.display = 'block';
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è "–Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
    function displayNoResults() {
        resultsContainer.innerHTML = '<div class="autocomplete-item text-muted">–ú–∞—Ç–µ—Ä–∏–∞–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
        resultsContainer.style.display = 'block';
    }

    // –§—É–Ω–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–∞
    function selectMaterial(material) {
        searchInput.value = material.name;
        resultsContainer.style.display = 'none';
        loadMaterialChart(material.id);

        // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –≥—Ä–∞—Ñ–∏–∫—É
        document.querySelector('.chart-container').scrollIntoView({
            behavior: 'smooth',
            block: 'start'
        });
    }

    // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
    searchInput.addEventListener('input', function(e) {
        const query = e.target.value.trim();

        // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä
        if (timeoutId) {
            clearTimeout(timeoutId);
        }

        // –°–∫—Ä—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π
        if (query.length < 2) {
            resultsContainer.style.display = 'none';
            return;
        }

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–¥–µ—Ä–∂–∫—É 400 –º—Å
        timeoutId = setTimeout(() => {
            performSearch(query);
        }, 400);
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∞–≤–∏—à
    searchInput.addEventListener('keydown', function(e) {
        const items = resultsContainer.querySelectorAll('.autocomplete-item');
        const activeItem = resultsContainer.querySelector('.autocomplete-item.active');
        let nextActive = null;

        switch(e.key) {
            case 'ArrowDown':
                e.preventDefault();
                if (!activeItem && items.length > 0) {
                    nextActive = items[0];
                } else if (activeItem && activeItem.nextElementSibling) {
                    nextActive = activeItem.nextElementSibling;
                }
                break;

            case 'ArrowUp':
                e.preventDefault();
                if (activeItem && activeItem.previousElementSibling) {
                    nextActive = activeItem.previousElementSibling;
                }
                break;

            case 'Enter':
                e.preventDefault();
                if (activeItem) {
                    activeItem.click();
                }
                break;

            case 'Escape':
                resultsContainer.style.display = 'none';
                break;
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç
        if (activeItem) {
            activeItem.classList.remove('active');
        }
        if (nextActive) {
            nextActive.classList.add('active');
        }
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –æ–±–ª–∞—Å—Ç–∏
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.search-container')) {
            resultsContainer.style.display = 'none';
        }
    });

    // –ü—Ä–∏ —Ñ–æ–∫—É—Å–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –µ—Å–ª–∏ –µ—Å—Ç—å
    searchInput.addEventListener('focus', function() {
        if (this.value.length >= 2 && resultsContainer.children.length > 0) {
            resultsContainer.style.display = 'block';
        }
    });

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –æ–±—ä–µ–∫—Ç–µ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑–≤–Ω–µ
    window.autocomplete = {
        performSearch,
        displayResults,
        displayError,
        displayNoResults,
        selectMaterial,
        escapeHtml
    };
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–∞
function loadMaterialChart(materialId) {
    showLoading(true);

    fetch(`{% url 'mebel:material_chart_data' 0 %}`.replace('0', materialId))
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            currentMaterialId = materialId;

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–∞—Ç–µ—Ä–∏–∞–ª–µ
            const materialInfo = document.getElementById('materialInfo');
            materialInfo.style.display = 'block';
            document.getElementById('materialName').textContent = data.material_name;
            document.getElementById('currentBalance').textContent = data.current_balance;
            document.getElementById('currentAvailable').textContent = data.current_available;

            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—ã –¥–ª—è –ª—É—á—à–µ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const formattedDates = data.dates.map(date => {
                const d = new Date(date);
                return d.toLocaleDateString('ru-RU', {
                    month: 'short',
                    day: 'numeric'
                });
            });

            // –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫
            updateChart(formattedDates, data.quantities, data.material_name);
        })
        .catch(error => {
            console.error('Error loading chart data:', error);
            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–∞');
        })
        .finally(() => {
            showLoading(false);
        });
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
function showLoading(show) {
    const refreshBtn = document.getElementById('refreshChart');
    if (show) {
        refreshBtn.innerHTML = '‚è≥';
        refreshBtn.disabled = true;
    } else {
        refreshBtn.innerHTML = 'üîÑ';
        refreshBtn.disabled = false;
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
function updateChart(dates, quantities, materialName) {
    const ctx = document.getElementById('materialChart').getContext('2d');

    if (materialChart) {
        materialChart.destroy();
    }

    // –û—á–∏—â–∞–µ–º canvas –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞
    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);

    materialChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: [{
                label: `–ù–∞–ª–∏—á–∏–µ: ${materialName}`,
                data: quantities,
                borderColor: '#4CAF50',
                backgroundColor: 'rgba(76, 175, 80, 0.2)', // –£–º–µ–Ω—å—à–∏–º –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å
                borderWidth: 2,
                fill: true,
                tension: 0.2,
                pointBackgroundColor: '#4CAF50',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 1,
                pointRadius: 2,
                pointHoverRadius: 4,
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∑–∞–ª–∏–≤–∫—É —Ç–æ–ª—å–∫–æ –æ–±–ª–∞—Å—Ç—å—é –¥–∞–Ω–Ω—ã—Ö
                segment: {
                    backgroundColor: (ctx) => {
                        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∑–∞–ª–∏–≤–∫—É –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –≥—Ä–∞—Ñ–∏–∫–∞
                        const chart = ctx.chart;
                        const {ctx: chartCtx, chartArea} = chart;

                        if (!chartArea) {
                            return;
                        }

                        const gradient = chartCtx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
                        gradient.addColorStop(0, 'rgba(76, 175, 80, 0.2)');
                        gradient.addColorStop(1, 'rgba(76, 175, 80, 0.05)');
                        return gradient;
                    }
                }
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false, // –í–∞–∂–Ω–æ –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è —Ä–∞–∑–º–µ—Ä–æ–≤
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        boxWidth: 12,
                        font: {
                            size: 10
                        }
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    bodyFont: {
                        size: 10
                    },
                    titleFont: {
                        size: 10
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grace: '5%', // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à–æ–π –æ—Ç—Å—Ç—É–ø –æ—Ç –∫—Ä–∞–µ–≤
                    grid: {
                        drawBorder: true,
                        color: 'rgba(0,0,0,0.1)'
                    },
                    ticks: {
                        font: {
                            size: 9
                        },
                        maxTicksLimit: 6
                    }
                },
                x: {
                    grid: {
                        drawBorder: true,
                        color: 'rgba(0,0,0,0.1)'
                    },
                    ticks: {
                        font: {
                            size: 9
                        },
                        maxTicksLimit: 8
                    }
                }
            },
            elements: {
                line: {
                    tension: 0.2
                },
                point: {
                    hitRadius: 10 // –£–≤–µ–ª–∏—á–∏–º –æ–±–ª–∞—Å—Ç—å –∫–ª–∏–∫–∞ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
                }
            },
            layout: {
                padding: {
                    left: 5,
                    right: 5,
                    top: 5,
                    bottom: 5
                }
            }
        }
    });

    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
    setTimeout(() => {
        if (materialChart) {
            materialChart.resize();
        }
    }, 100);
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    setupAutocomplete();

    // –ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    const firstMaterialRow = document.querySelector('tr[data-material-id]');
    if (firstMaterialRow) {
        const materialId = firstMaterialRow.dataset.materialId;
        const materialName = firstMaterialRow.querySelector('strong').textContent;

        loadMaterialChart(materialId);
        document.getElementById('materialSearch').value = materialName;
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ "–ü–æ–∫–∞–∑–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫"
    document.querySelectorAll('.show-chart').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const materialId = this.dataset.materialId;
            const materialName = this.dataset.materialName;

            document.getElementById('materialSearch').value = materialName;
            loadMaterialChart(materialId);
        });
    });

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–µ—Ä–∏–æ–¥–∞
    document.getElementById('periodSelect').addEventListener('change', function() {
        if (currentMaterialId) {
            loadMaterialChart(currentMaterialId);
        }
    });

    // –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
    document.getElementById('refreshChart').addEventListener('click', function() {
        if (currentMaterialId) {
            loadMaterialChart(currentMaterialId);
        }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å—Ç—Ä–æ–∫ —Ç–∞–±–ª–∏—Ü—ã (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± –≤—ã–±–æ—Ä–∞)
    document.querySelectorAll('tr[data-material-id]').forEach(row => {
        row.addEventListener('click', function(e) {
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–ª–∏–∫–∏ –ø–æ –∫–Ω–æ–ø–∫–∞–º
            if (!e.target.closest('.action-buttons')) {
                const materialId = this.dataset.materialId;
                const materialName = this.querySelector('strong').textContent;

                document.getElementById('materialSearch').value = materialName;
                loadMaterialChart(materialId);
            }
        });
    });
});
</script>
{% endblock %}