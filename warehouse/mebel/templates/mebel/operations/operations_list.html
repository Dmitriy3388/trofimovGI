{% extends "mebel/base.html" %}
{% load static %}

{% block title %}–û–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º{% endblock %}

{% block extra_css %}
<style>
/* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
.dashboard-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}

.page-header {
    text-align: center;
    margin-bottom: 30px;
}

.page-header h1 {
    color: #2c3e50;
    font-weight: 700;
    font-size: 2.5rem;
    margin-bottom: 10px;
}

.page-header p {
    color: #6b7280;
    font-size: 1.2rem;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ */
.card-modern {
    background: white;
    border-radius: 16px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.08);
    border: none;
    overflow: hidden;
    margin-bottom: 25px;
}

.card-modern-header {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    padding: 20px 25px;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.card-modern-title {
    color: #2c3e50;
    font-weight: 600;
    margin: 0;
    font-size: 1.3rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã */
.operations-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 12px;
    overflow: hidden;
    font-size: 0.85rem;
}

.operations-table thead {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.operations-table th {
    color: white;
    font-weight: 600;
    padding: 15px 12px;
    text-align: left;
    border: none;
    font-size: 0.9rem;
    white-space: nowrap;
}

.operations-table tbody tr {
    border-bottom: 1px solid #f1f5f9;
    transition: all 0.3s;
    cursor: pointer;
}

.operations-table tbody tr:hover {
    background-color: #f8fafc;
    transform: translateX(5px);
}

.operations-table td {
    padding: 12px;
    vertical-align: middle;
    border: none;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ –æ–ø–µ—Ä–∞—Ü–∏–π */
.operation-badge {
    font-weight: bold;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    white-space: nowrap;
    display: inline-block;
    text-align: center;
    min-width: 100px;
}

.receipt-badge {
    background: #d1fae5;
    color: #065f46;
    border: 1px solid #a7f3d0;
}

.writeoff-badge {
    background: #fee2e2;
    color: #991b1b;
    border: 1px solid #fca5a5;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–æ–ª–∏—á–µ—Å—Ç–≤ */
.quantity-cell {
    font-family: 'Courier New', monospace;
    font-weight: 600;
    text-align: right;
    color: #2c3e50;
    font-size: 0.9rem;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –¥–∞—Ç */
.date-cell {
    white-space: nowrap;
    font-size: 0.8rem;
    color: #6b7280;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –Ω–∞–∑–≤–∞–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–∞ */
.material-name {
    font-weight: 600;
    color: #2c3e50;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π */
.action-buttons {
    display: flex !important;
    gap: 5px !important;
    flex-wrap: nowrap !important;
    justify-content: center !important;
}

.action-btn {
    padding: 6px 8px !important;
    border-radius: 6px !important;
    font-size: 0.75rem !important;
    min-width: 30px !important;
    height: 28px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    transition: all 0.3s !important;
    text-decoration: none !important;
    border: none !important;
}

.action-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 3px 8px rgba(0,0,0,0.15);
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ */
.filters-modern {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 20px;
}

.filter-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    align-items: end;
}

.filter-group {
    display: flex;
    flex-direction: column;
}

.filter-label {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 8px;
    font-size: 0.9rem;
}

.filter-select {
    padding: 10px 12px;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    font-size: 0.9rem;
    outline: none;
    transition: all 0.3s;
    background: white;
}

.filter-select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.filter-input {
    padding: 10px 12px;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    font-size: 0.9rem;
    outline: none;
    transition: all 0.3s;
}

.filter-input:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

/* –ö–Ω–æ–ø–∫–∏ */
.btn-modern {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
}

.btn-modern:hover {
    background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    color: white;
    text-decoration: none;
}

.btn-warning-modern {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
}

.btn-warning-modern:hover {
    background: linear-gradient(135deg, #e0900a 0%, #b45309 100%);
}

/* –ê–Ω–∏–º–∞—Ü–∏–∏ */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.card-modern {
    animation: fadeInUp 0.6s ease-out;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –ø—É—Å—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è */
.no-data {
    text-align: center;
    padding: 60px 20px;
    color: #9ca3af;
}

.no-data p {
    margin: 0;
    font-size: 1.1rem;
}

/* –ë–µ–π–¥–∂ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ */
.count-badge {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.9rem;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 768px) {
    .dashboard-container {
        padding: 10px;
    }

    .page-header h1 {
        font-size: 2rem;
    }

    .filter-grid {
        grid-template-columns: 1fr;
    }

    .operations-table {
        font-size: 0.75rem;
    }

    .operations-table th,
    .operations-table td {
        padding: 10px 8px;
    }

    .operations-table th:nth-child(5), /* –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å */
    .operations-table td:nth-child(5) {
        display: none;
    }
}

@media (max-width: 576px) {
    .page-header h1 {
        font-size: 1.8rem;
    }

    .operations-table th:nth-child(6), /* –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ */
    .operations-table td:nth-child(6) {
        display: none;
    }

    .action-buttons {
        flex-direction: column !important;
        gap: 3px !important;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
    <div class="page-header">
        <h1>üìä –û–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º</h1>
        <p>–ò—Å—Ç–æ—Ä–∏—è –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–π –∏ —Å–ø–∏—Å–∞–Ω–∏–π –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</p>
    </div>

    <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ -->
    <div class="card-modern">
        <div class="card-modern-header">
            <h5 class="card-modern-title">
                üîç –§–∏–ª—å—Ç—Ä—ã –æ–ø–µ—Ä–∞—Ü–∏–π
            </h5>
        </div>
        <div class="card-modern-body">
            <form method="get" class="filters-modern">
                <div class="filter-grid">
                    <div class="filter-group">
                        <label class="filter-label">–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏</label>
                        <select name="type" class="filter-select">
                            <option value="">–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</option>
                            <option value="receipt" {% if operation_type == 'receipt' %}selected{% endif %}>–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è</option>
                            <option value="write_off" {% if operation_type == 'write_off' %}selected{% endif %}>–°–ø–∏—Å–∞–Ω–∏—è</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">–ú–∞—Ç–µ—Ä–∏–∞–ª</label>
                        <select name="material" class="filter-select">
                            <option value="">–í—Å–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã</option>
                            {% for material in materials %}
                            <option value="{{ material.id }}" {% if selected_material == material.id|stringformat:"i" %}selected{% endif %}>
                                {{ material.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">–° –¥–∞—Ç—ã</label>
                        <input type="date" name="date_from" class="filter-input" value="{{ date_from }}">
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">–ü–æ –¥–∞—Ç—É</label>
                        <input type="date" name="date_to" class="filter-input" value="{{ date_to }}">
                    </div>

                    <div class="filter-group" style="grid-column: 1 / -1;">
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button type="submit" class="btn-modern">
                                üîç –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                            </button>
                            <a href="{% url 'mebel:operations_list' %}" class="btn-modern" style="background: #6b7280;">
                                üóëÔ∏è –°–±—Ä–æ—Å–∏—Ç—å
                            </a>
                        </div>
                    </div>
                </div>
            </form>

            <!-- –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ—Å—á–µ—Ç–∞ –±–∞–ª–∞–Ω—Å–æ–≤ -->
            <div style="display: flex; align-items: center; gap: 15px; margin-top: 15px; padding: 15px; background: #fffbeb; border-radius: 8px; border: 1px solid #fcd34d;">
                <a href="{% url 'mebel:recalculate_balances' %}" class="btn-modern btn-warning-modern">
                    üîÑ –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –≤—Å–µ –±–∞–ª–∞–Ω—Å—ã
                </a>
                <small style="color: #92400e; font-size: 0.8rem;">
                    –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –µ—Å–ª–∏ –±–∞–ª–∞–Ω—Å—ã –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏
                </small>
            </div>
        </div>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ –æ–ø–µ—Ä–∞—Ü–∏–π -->
    <div class="card-modern">
        <div class="card-modern-header">
            <h5 class="card-modern-title">
                üìã –°–ø–∏—Å–æ–∫ –æ–ø–µ—Ä–∞—Ü–∏–π
            </h5>
            <span class="count-badge">–í—Å–µ–≥–æ: {{ page_obj.paginator.count }}</span>
        </div>
        <div class="card-modern-body">
            {% if page_obj %}
            <div class="table-responsive">
                <table class="operations-table">
                    <thead>
                        <tr>
                            <th>–î–∞—Ç–∞</th>
                            <th>–¢–∏–ø</th>
                            <th>–ú–∞—Ç–µ—Ä–∏–∞–ª</th>
                            <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                            <th>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for operation in page_obj %}
                        <tr onclick="window.location='{% url 'mebel:operation_detail' operation.id %}';">
                            <td class="date-cell">{{ operation.created|date:"d.m.Y H:i" }}</td>
                            <td>
                                {% if operation.operation_type == 'receipt' %}
                                    <span class="operation-badge receipt-badge">üìà –ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ</span>
                                {% else %}
                                    <span class="operation-badge writeoff-badge">üìâ –°–ø–∏—Å–∞–Ω–∏–µ</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="material-name">{{ operation.material.name|truncatechars:25 }}</div>
                            </td>
                            <td class="quantity-cell">{{ operation.quantity }} —à—Ç.</td>
                            <td>{{ operation.user.get_full_name|default:operation.user.username }}</td>
                            <td>{{ operation.notes|default:"-"|truncatewords:3 }}</td>
                            <td>
                                <div class="action-buttons">
                                    <a href="{% url 'mebel:operation_detail' operation.id %}"
                                       class="action-btn"
                                       title="–ü–æ–¥—Ä–æ–±–Ω–µ–µ"
                                       style="background: #10b981; color: white;">
                                        üëÅÔ∏è
                                    </a>
                                    {% if operation.can_edit %}
                                    <a href="{% url 'mebel:operation_edit' operation.id %}"
                                       class="action-btn"
                                       title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"
                                       style="background: #f59e0b; color: white;">
                                        ‚úèÔ∏è
                                    </a>
                                    {% else %}
                                    <button class="action-btn"
                                            title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ"
                                            disabled
                                            style="background: #9ca3af; color: white;">
                                        ‚è≥
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
            <div style="margin-top: 25px;">
                {% include 'pagination.html' %}
            </div>

            {% else %}
            <div class="no-data">
                <p>üì≠ –û–ø–µ—Ä–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                <p style="font-size: 0.9rem; margin-top: 10px;">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–æ–≤</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}