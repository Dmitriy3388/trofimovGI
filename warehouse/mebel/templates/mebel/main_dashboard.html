{% extends "mebel/base.html" %}
{% load static %}

{% block title %}–ú–æ–π —Å–∫–ª–∞–¥{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'mebel/css/dashboard.css' %}">
<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="dashboard-container">
  <h1>–ú–æ–π –°–∫–ª–∞–¥</h1>
  <div class="profile-actions">
    <p>
      –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Å–∏—Å—Ç–µ–º—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∫–ª–∞–¥–æ–º.
    </p>
  </div>
<div class="row mt-4">
        <!-- –ì—Ä–∞—Ñ–∏–∫ –¥–∏–Ω–∞–º–∏–∫–∏ –∑–∞–∫–∞–∑–æ–≤ -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">–î–∏–Ω–∞–º–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤</h5>
                    <div class="btn-group">
                        <a href="?period=week" class="btn btn-sm {% if period == 'week' %}btn-primary{% else %}btn-outline-primary{% endif %}">–ù–µ–¥–µ–ª—è</a>
                        <a href="?period=month" class="btn btn-sm {% if period == 'month' %}btn-primary{% else %}btn-outline-primary{% endif %}">–ú–µ—Å—è—Ü</a>
                        <a href="?period=year" class="btn btn-sm {% if period == 'year' %}btn-primary{% else %}btn-outline-primary{% endif %}">–ì–æ–¥</a>
                    </div>
                </div>
                <div class="card-body">
                    {% if has_data %}
                        <canvas id="ordersChart" width="400" height="200"></canvas>
                    {% else %}
                        <p class="text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- –ú–∞—Ç–µ—Ä–∏–∞–ª—ã —Å –Ω–µ—Ö–≤–∞—Ç–∫–æ–π -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">–ù–µ—Ö–≤–∞—Ç–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</h5>
                </div>
                <div class="card-body">
                    <!-- –¢–µ–∫—É—â–∞—è –Ω–µ—Ö–≤–∞—Ç–∫–∞ -->
                    <h6>–¢–µ–∫—É—â–∞—è –Ω–µ—Ö–≤–∞—Ç–∫–∞</h6>
                    <ul class="list-group list-group-flush">
                        {% for material in current_shortage %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <a href="{{ material.get_absolute_url }}">{{ material.name }}</a>
                            <span class="badge bg-danger rounded-pill">{{ material.lack }} —à—Ç.</span>
                        </li>
                        {% empty %}
                        <li class="list-group-item">–ù–µ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ —Å —Ç–µ–∫—É—â–µ–π –Ω–µ—Ö–≤–∞—Ç–∫–æ–π</li>
                        {% endfor %}
                    </ul>

                    <!-- –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º–∞—è –Ω–µ—Ö–≤–∞—Ç–∫–∞ -->
                    <h6 class="mt-3">–ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º–∞—è –Ω–µ—Ö–≤–∞—Ç–∫–∞</h6>
                    <ul class="list-group list-group-flush">
                        {% for material in predicted_shortage %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <a href="{{ material.get_absolute_url }}">{{ material.name }}</a>
                            <span class="badge bg-warning rounded-pill">
                                {{ material.balance|add:"-"|add:material.reserved }} –∏–∑ {{ material.balance }} —à—Ç.
                            </span>
                        </li>
                        {% empty %}
                        <li class="list-group-item">–ù–µ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ —Å –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º–æ–π –Ω–µ—Ö–≤–∞—Ç–∫–æ–π</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
  <div class="main-actions">
    <div class="action-card">
      <a href="{% url 'account:profile' %}" class="btn btn-primary">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</a>
    </div>
    {% if user.groups.all.0.name == '–ú–µ–Ω–µ–¥–∂–µ—Ä—ã' or user.is_superuser %}
      <div class="action-card">
        <a href="{% url 'orders:order_create' %}" class="btn btn-primary">–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞</a>
      </div>
    {% endif %}
      <div class="action-card">
        <a href="{% url 'mebel:material_list' %}" class="btn btn-primary">–ü—Ä–æ—Å–º–æ—Ç—Ä –ú–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</a>
      </div>

    {% if user.groups.all.0.name == '–û—Ç–¥–µ–ª –ú–¢–û' or user.is_superuser %}
    <div class="action-card">
        <a href="{% url 'mebel:operations_list' %}" class="btn btn-info">
            üìä –û–ø–µ—Ä–∞—Ü–∏–∏ —Å–ø–∏—Å–∞–Ω–∏—è/–ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è
        </a>
    </div>
    {% endif %}
      <!-- –î–æ–±–∞–≤–∏—Ç—å —ç—Ç–æ—Ç –±–ª–æ–∫ –≤ —Ä–∞–∑–¥–µ–ª —Å –æ—Å–Ω–æ–≤–Ω—ã–º–∏ –¥–µ–π—Å—Ç–≤–∏—è–º–∏ -->
    {% if user.groups.all.0.name == '–û—Ç–¥–µ–ª –ú–¢–û' or user.is_superuser %}
    <div class="action-card">
        <a href="{% url 'mebel:material_create' %}" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª</a>
    </div>
    {% endif %}
    <div class="action-card">
      <a href="{% url 'orders:order_list' %}" class="btn btn-primary">–ü—Ä–æ—Å–º–æ—Ç—Ä –ó–∞–∫–∞–∑–æ–≤</a>
    </div>

  </div>

</div>
{% endblock %}

{% block domready %}
{% if has_data %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
    const ctx = document.getElementById('ordersChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: {{ dates_json|safe }},
            datasets: [{
                label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤',
                data: {{ counts_json|safe }},
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 2,
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
    function updateChart(dates, counts) {
        chart.data.labels = dates;
        chart.data.datasets[0].data = counts;
        chart.update();
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏
    function updateActiveButton(period) {
        // –£–¥–∞–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
        document.querySelectorAll('.period-btn').forEach(btn => {
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-outline-primary');
        });
        // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–Ω–æ–ø–∫–µ
        const activeBtn = document.querySelector(`.period-btn[href="?period=${period}"]`);
        if (activeBtn) {
            activeBtn.classList.remove('btn-outline-primary');
            activeBtn.classList.add('btn-primary');
        }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –ø–µ—Ä–∏–æ–¥–∞
    document.querySelectorAll('.period-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const url = new URL(this.href);
            const period = url.searchParams.get('period');

            // AJAX-–∑–∞–ø—Ä–æ—Å
            fetch(window.location.pathname, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json',
                },
                data: { period: period }
            })
            .then(response => response.json())
            .then(data => {
                if (data.has_data) {
                    updateChart(data.dates, data.counts);
                } else {
                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –¥–∞–Ω–Ω—ã—Ö
                    updateChart([], []);
                }
                updateActiveButton(data.period);
            })
            .catch(error => console.error('Error:', error));
        });
    });
});
</script>
{% endif %}
{% endblock %}
