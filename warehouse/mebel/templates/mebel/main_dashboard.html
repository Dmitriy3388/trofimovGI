{% extends "mebel/base.html" %}
{% load static %}

{% block title %}–ú–æ–π —Å–∫–ª–∞–¥{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'mebel/css/dashboard.css' %}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
.dashboard-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
    display: grid;
    grid-template-columns: 1fr 400px;
    gap: 25px;
    align-items: start;
}

.main-content {
    display: flex;
    flex-direction: column;
    gap: 25px;
}

.sidebar-content {
    display: flex;
    flex-direction: column;
    gap: 25px;
    position: sticky;
    top: 20px;
}

.welcome-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 16px;
    padding: 25px;
    margin-bottom: 0;
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
}

.welcome-card h5 {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 10px;
}

.welcome-card p {
    opacity: 0.9;
    margin: 0;
    font-size: 1.1rem;
}

.full-width-chart {
    width: 100%;
    margin-bottom: 0;
}

.shortage-card {
    min-height: 200px;
    transition: transform 0.3s ease;
    height: 100%;
}

.shortage-card:hover {
    transform: translateY(-5px);
}

.card-modern {
    background: white;
    border-radius: 16px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.08);
    border: none;
    overflow: hidden;
    height: 100%;
}

.card-modern-header {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    padding: 20px 25px;
    border-bottom: 1px solid #e2e8f0;
}

.card-modern-title {
    color: #2c3e50;
    font-weight: 600;
    margin: 0;
    font-size: 1.3rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

.card-modern-body {
    padding: 25px;
    height: calc(100% - 80px);
    display: flex;
    flex-direction: column;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –ø–µ—Ä–∏–æ–¥–∞ */
.period-buttons {
    display: flex;
    gap: 10px;
}

.btn-period {
    padding: 8px 16px;
    border: 2px solid #667eea;
    background: transparent;
    color: #667eea;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
    text-decoration: none;
    font-size: 0.9rem;
}

.btn-period:hover {
    background: #667eea;
    color: white;
    transform: translateY(-2px);
}

.btn-period.active {
    background: #667eea;
    color: white;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Å–ø–∏—Å–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ */
.material-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
    flex: 1;
}

.material-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    background: #f8fafc;
    border-radius: 12px;
    border-left: 4px solid;
    transition: all 0.3s;
    text-decoration: none;
    color: inherit;
}

.material-item:hover {
    background: #f1f5f9;
    transform: translateX(5px);
}

.material-item.current {
    border-left-color: #ef4444;
}

.material-item.predicted {
    border-left-color: #f59e0b;
}

.material-name {
    font-weight: 500;
    color: #2c3e50;
    flex: 1;
}

.material-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.85rem;
}

.badge-danger {
    background: #fee2e2;
    color: #dc2626;
}

.badge-warning {
    background: #fef3c7;
    color: #d97706;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ */
.chart-container {
    position: relative;
    height: 300px;
    width: 100%;
}

.no-data {
    text-align: center;
    padding: 40px 20px;
    color: #9ca3af;
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
}

.no-data p {
    margin: 0;
    font-size: 1.1rem;
}

/* –ê–Ω–∏–º–∞—Ü–∏–∏ */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.card-modern {
    animation: fadeInUp 0.6s ease-out;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 1200px) {
    .dashboard-container {
        grid-template-columns: 1fr;
        gap: 20px;
    }

    .sidebar-content {
        position: static;
    }

    .shortage-cards {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }
}

@media (max-width: 768px) {
    .dashboard-container {
        padding: 10px;
        gap: 15px;
    }

    .shortage-cards {
        grid-template-columns: 1fr;
        gap: 15px;
    }

    .welcome-card {
        padding: 20px;
    }

    .card-modern-body {
        padding: 20px;
    }

    .period-buttons {
        flex-wrap: wrap;
        justify-content: center;
    }

    .btn-period {
        flex: 1;
        min-width: 80px;
        text-align: center;
    }

    .material-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
}

@media (max-width: 480px) {
    .welcome-card h5 {
        font-size: 1.3rem;
    }

    .card-modern-title {
        font-size: 1.1rem;
    }

    .chart-container {
        height: 250px;
    }

    .dashboard-container {
        grid-template-columns: 1fr;
    }
}

/* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –≤—ã—Å–æ—Ç—ã –¥–ª—è –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ */
.sidebar-content .shortage-card {
    flex: 1;
}

.sidebar-content .shortage-card:first-child {
    margin-bottom: 0;
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div class="main-content">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="text-center mb-4">
            <h1 style="color: #2c3e50; font-weight: 700; font-size: 2.5rem; margin-bottom: 10px;">üìä –ú–æ–π —Å–∫–ª–∞–¥</h1>
            <p style="color: #6b7280; font-size: 1.2rem;">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∫–ª–∞–¥–æ–º –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</p>
        </div>

        <!-- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ -->
        <div class="welcome-card">
            <h5>üéâ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Å–∏—Å—Ç–µ–º—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∫–ª–∞–¥–æ–º!</h5>
            <p>–ó–¥–µ—Å—å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –æ–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –∑–∞–∫–∞–∑–∞–º –∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.</p>
        </div>

        <!-- –ì—Ä–∞—Ñ–∏–∫ –¥–∏–Ω–∞–º–∏–∫–∏ –∑–∞–∫–∞–∑–æ–≤ -->
        <div class="full-width-chart">
            <div class="card-modern">
                <div class="card-modern-header d-flex justify-content-between align-items-center">
                    <h5 class="card-modern-title">
                        üìà –î–∏–Ω–∞–º–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤
                    </h5>
                    <div class="period-buttons">
                        <a href="?period=week" class="btn-period {% if period == 'week' %}active{% endif %}">–ù–µ–¥–µ–ª—è</a>
                        <a href="?period=month" class="btn-period {% if period == 'month' %}active{% endif %}">–ú–µ—Å—è—Ü</a>
                        <a href="?period=year" class="btn-period {% if period == 'year' %}active{% endif %}">–ì–æ–¥</a>
                    </div>
                </div>
                <div class="card-modern-body">
                    {% if has_data %}
                    <div class="chart-container">
                        <canvas id="ordersChart"></canvas>
                    </div>
                    {% else %}
                    <div class="no-data">
                        <p>üì≠ –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏ –Ω–µ—Ö–≤–∞—Ç–∫–∏ -->
    <div class="sidebar-content">
        <!-- –¢–µ–∫—É—â–∞—è –Ω–µ—Ö–≤–∞—Ç–∫–∞ -->
        <div class="card-modern shortage-card">
            <div class="card-modern-header">
                <h5 class="card-modern-title">üî¥ –¢–µ–∫—É—â–∞—è –Ω–µ—Ö–≤–∞—Ç–∫–∞</h5>
            </div>
            <div class="card-modern-body">
                {% if current_shortage %}
                <div class="material-list">
                    {% for material in current_shortage %}
                    <a href="{{ material.get_absolute_url }}" class="material-item current">
                        <span class="material-name">{{ material.name }}</span>
                        <span class="material-badge badge-danger">–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç: {{ material.lack }} —à—Ç.</span>
                    </a>
                    {% endfor %}
                </div>
                {% else %}
                <div class="no-data">
                    <p>‚úÖ –ù–µ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ —Å —Ç–µ–∫—É—â–µ–π –Ω–µ—Ö–≤–∞—Ç–∫–æ–π</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º–∞—è –Ω–µ—Ö–≤–∞—Ç–∫–∞ -->
        <div class="card-modern shortage-card">
            <div class="card-modern-header">
                <h5 class="card-modern-title">üü° –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º–∞—è –Ω–µ—Ö–≤–∞—Ç–∫–∞</h5>
            </div>
            <div class="card-modern-body">
                {% if predicted_shortage %}
                <div class="material-list">
                    {% for material in predicted_shortage %}
                    <a href="{{ material.get_absolute_url }}" class="material-item predicted">
                        <span class="material-name">{{ material.name }}</span>
                        <span class="material-badge badge-warning">{{ material.balance }} –∏–∑ {{ material.reserved }} —à—Ç.</span>
                    </a>
                    {% endfor %}
                </div>
                {% else %}
                <div class="no-data">
                    <p>‚úÖ –ù–µ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ —Å –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º–æ–π –Ω–µ—Ö–≤–∞—Ç–∫–æ–π</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block domready %}
{% if has_data %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('ordersChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: {{ dates_json|safe }},
            datasets: [{
                label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤',
                data: {{ counts_json|safe }},
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                borderColor: 'rgba(102, 126, 234, 1)',
                borderWidth: 3,
                tension: 0.3,
                fill: true,
                pointBackgroundColor: '#667eea',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointRadius: 5,
                pointHoverRadius: 7
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        font: {
                            size: 14,
                            family: "'Inter', sans-serif"
                        },
                        color: '#2c3e50'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(44, 62, 80, 0.9)',
                    titleFont: {
                        size: 13,
                        family: "'Inter', sans-serif"
                    },
                    bodyFont: {
                        size: 13,
                        family: "'Inter', sans-serif"
                    },
                    padding: 12,
                    cornerRadius: 8
                }
            },
            scales: {
                x: {
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        font: {
                            family: "'Inter', sans-serif"
                        },
                        color: '#6b7280'
                    }
                },
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        font: {
                            family: "'Inter', sans-serif"
                        },
                        color: '#6b7280'
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            },
            animations: {
                tension: {
                    duration: 1000,
                    easing: 'linear'
                }
            }
        }
    });
});
</script>
{% endif %}
{% endblock %}