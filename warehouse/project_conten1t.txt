============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\account\templates\account\edit.html
============================================================

{% extends "mebel/base.html" %}
{% load static %}

{% block title %}Редактирование профиля{% endblock %}

{% block extra_css %}
<style>
/* Основные стили контейнера */
.dashboard-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

.page-header {
    text-align: center;
    margin-bottom: 40px;
}

.page-header h1 {
    color: #2c3e50;
    font-weight: 700;
    font-size: 2.5rem;
    margin-bottom: 10px;
}

.page-header p {
    color: #6b7280;
    font-size: 1.2rem;
}

/* Стили для карточек */
.card-modern {
    background: white;
    border-radius: 16px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.08);
    border: none;
    overflow: hidden;
    margin-bottom: 25px;
}

.card-modern-header {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    padding: 20px 25px;
    border-bottom: 1px solid #e2e8f0;
}

.card-modern-title {
    color: #2c3e50;
    font-weight: 600;
    margin: 0;
    font-size: 1.3rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

.card-modern-body {
    padding: 25px;
}

/* Стили для форм */
.form-modern {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.form-label {
    font-weight: 600;
    color: #2c3e50;
    font-size: 0.9rem;
}

.form-input {
    padding: 12px 15px;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    font-size: 0.9rem;
    outline: none;
    transition: all 0.3s;
    background: white;
}

.form-input:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.form-textarea {
    min-height: 100px;
    resize: vertical;
    font-family: inherit;
}

.form-file {
    padding: 10px;
    border: 2px dashed #e2e8f0;
    border-radius: 8px;
    background: #f8fafc;
    cursor: pointer;
}

.form-file:hover {
    border-color: #667eea;
    background: #f0f9ff;
}

/* Кнопки */
.btn-modern {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 12px 30px;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
    margin-top: 10px;
}

.btn-modern:hover {
    background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    color: white;
    text-decoration: none;
}

/* Стили для ошибок */
.form-errors {
    background: #fef2f2;
    border: 1px solid #fecaca;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
}

.form-error {
    color: #dc2626;
    font-size: 0.8rem;
    margin: 5px 0;
}

.form-error ul {
    margin: 0;
    padding-left: 20px;
}

/* Анимации */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.card-modern {
    animation: fadeInUp 0.6s ease-out;
}

/* Стили для разделов формы */
.form-section {
    border-bottom: 1px solid #e2e8f0;
    padding-bottom: 20px;
    margin-bottom: 20px;
}

.form-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.section-title {
    color: #2c3e50;
    font-weight: 600;
    margin-bottom: 15px;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    gap: 8px;
}

/* Адаптивность */
@media (max-width: 768px) {
    .dashboard-container {
        padding: 15px;
    }

    .page-header h1 {
        font-size: 2rem;
    }

    .card-modern-body {
        padding: 20px;
    }

    .form-group {
        gap: 6px;
    }

    .form-input {
        padding: 10px 12px;
    }
}

@media (max-width: 576px) {
    .page-header h1 {
        font-size: 1.8rem;
    }

    .page-header p {
        font-size: 1rem;
    }

    .card-modern-header {
        padding: 15px 20px;
    }

    .btn-modern {
        width: 100%;
        justify-content: center;
    }
}

/* Стили для текущего аватара */
.current-avatar {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
}

.avatar-preview {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid #e2e8f0;
}

.avatar-info {
    color: #6b7280;
    font-size: 0.8rem;
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Заголовок страницы -->
    <div class="page-header">
        <h1>👤 Редактирование профиля</h1>
        <p>Обновите информацию вашего аккаунта</p>
    </div>

    <!-- Карточка с формой -->
    <div class="card-modern">
        <div class="card-modern-header">
            <h5 class="card-modern-title">
                ✏️ Личная информация
            </h5>
        </div>
        <div class="card-modern-body">
            <form method="post" enctype="multipart/form-data" class="form-modern">
                {% csrf_token %}

                <!-- Ошибки форм -->
                {% include "includes/form_errors.html" with form=user_form %}
                {% include "includes/form_errors.html" with form=profile_form %}

                <!-- Секция пользователя -->
                <div class="form-section">
                    <div class="section-title">
                        👤 Основная информация
                    </div>

                    {% for field in user_form %}
                    <div class="form-group">
                        <label for="{{ field.id_for_label }}" class="form-label">
                            {{ field.label }}
                        </label>
                        {{ field }}
                        {% if field.errors %}
                        <div class="form-error">
                            {{ field.errors }}
                        </div>
                        {% endif %}
                        {% if field.help_text %}
                        <small style="color: #6b7280; font-size: 0.8rem;">
                            {{ field.help_text }}
                        </small>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>

                <!-- Секция профиля -->
                <div class="form-section">
                    <div class="section-title">
                        📝 Дополнительная информация
                    </div>

                    <!-- Поле аватара с превью -->
                    {% for field in profile_form %}
                    <div class="form-group">
                        {% if field.name == 'photo' %}
                            <!-- Специальная обработка для поля фото -->
                            <label for="{{ field.id_for_label }}" class="form-label">
                                {{ field.label }}
                            </label>

                            {% if profile_form.instance.photo %}
                            <div class="current-avatar">
                                <img src="{{ profile_form.instance.photo.url }}"
                                     alt="Текущий аватар"
                                     class="avatar-preview">
                                <div class="avatar-info">
                                    Текущее изображение
                                </div>
                            </div>
                            {% endif %}

                            <input type="file"
                                   name="{{ field.name }}"
                                   id="{{ field.id_for_label }}"
                                   class="form-input form-file"
                                   accept="image/*">
                        {% else %}
                            <label for="{{ field.id_for_label }}" class="form-label">
                                {{ field.label }}
                            </label>
                            {{ field }}
                        {% endif %}

                        {% if field.errors %}
                        <div class="form-error">
                            {{ field.errors }}
                        </div>
                        {% endif %}

                        {% if field.help_text %}
                        <small style="color: #6b7280; font-size: 0.8rem;">
                            {{ field.help_text }}
                        </small>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>

                <!-- Кнопка отправки -->
                <button type="submit" class="btn-modern">
                    💾 Сохранить изменения
                </button>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Добавляем классы к полям формы
    const inputs = document.querySelectorAll('input:not([type="file"]), textarea, select');
    inputs.forEach(input => {
        if (!input.classList.contains('form-input')) {
            input.classList.add('form-input');
        }
    });

    // Добавляем специальный класс для textarea
    const textareas = document.querySelectorAll('textarea');
    textareas.forEach(textarea => {
        textarea.classList.add('form-textarea');
    });

    // Обработка превью для нового файла аватара
    const fileInput = document.querySelector('input[type="file"]');
    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Создаем или обновляем превью
                    let preview = document.querySelector('.avatar-preview');
                    if (!preview) {
                        const currentAvatar = document.querySelector('.current-avatar');
                        if (currentAvatar) {
                            preview = currentAvatar.querySelector('.avatar-preview');
                        }
                    }

                    if (preview) {
                        preview.src = e.target.result;
                    } else {
                        // Создаем новое превью если его не было
                        const fileInputContainer = fileInput.parentElement;
                        const previewDiv = document.createElement('div');
                        previewDiv.className = 'current-avatar';
                        previewDiv.innerHTML = `
                            <img src="${e.target.result}" alt="Новый аватар" class="avatar-preview">
                            <div class="avatar-info">Новое изображение</div>
                        `;
                        fileInput.parentNode.insertBefore(previewDiv, fileInput);
                    }
                };
                reader.readAsDataURL(file);
            }
        });
    }
});
</script>
{% endblock %}


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\account\templates\account\login.html
============================================================

{% extends "mebel/base.html" %}
{% load static %}

{% block title %}Авторизация{% endblock %}

{% block content %}
<div class="container" style="max-width: 500px; margin: 0 auto; padding: 20px;">
    <div class="card-modern">
        <!-- Заголовок формы -->
        <div class="card-modern-header">
            <h2 class="card-modern-title">🔐 Авторизация</h2>
            <p class="card-modern-subtitle">Пожалуйста, заполните форму для входа в систему</p>
        </div>

        <!-- Тело формы -->
        <div class="card-modern-body">
            <form method="post" class="auth-form">
                {% csrf_token %}

                <!-- Вывод ошибок формы -->
                {% if form.errors %}
                <div class="alert-danger" style="background: #fee; border: 1px solid #fcc; color: #c33; padding: 12px; border-radius: 8px; margin-bottom: 20px;">
                    <strong>Пожалуйста, исправьте следующие ошибки:</strong>
                    <ul style="margin: 10px 0 0 20px;">
                        {% for field, errors in form.errors.items %}
                            {% for error in errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                <!-- Поля формы -->
                <div class="mb-4">
                    <label for="id_username" class="form-label" style="display: block; margin-bottom: 8px; font-weight: 500; color: #2c3e50;">
                        👤 Имя пользователя
                    </label>
                    <input type="text"
                           name="username"
                           id="id_username"
                           class="form-control"
                           style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; transition: border-color 0.3s;"
                           placeholder="Введите ваше имя пользователя"
                           required>
                </div>

                <div class="mb-4">
                    <label for="id_password" class="form-label" style="display: block; margin-bottom: 8px; font-weight: 500; color: #2c3e50;">
                        🔒 Пароль
                    </label>
                    <input type="password"
                           name="password"
                           id="id_password"
                           class="form-control"
                           style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; transition: border-color 0.3s;"
                           placeholder="Введите ваш пароль"
                           required>
                </div>

                <!-- Дополнительные опции -->
                <div class="mb-4">
                    <div class="form-check" style="display: flex; align-items: center; gap: 8px;">
                        <input class="form-check-input" type="checkbox" id="rememberMe" name="remember_me" style="width: 18px; height: 18px;">
                        <label class="form-check-label" for="rememberMe" style="color: #2c3e50;">
                            Запомнить меня
                        </label>
                    </div>
                </div>

                <!-- Кнопка отправки -->
                <div class="card-actions">
                    <button type="submit" class="btn-modern btn-primary-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; font-weight: 500; cursor: pointer; transition: transform 0.2s; width: 100%;">
                        <i class="bi bi-box-arrow-in-right"></i>
                        Войти в систему
                    </button>
                </div>
            </form>
        </div>

        <!-- Дополнительные ссылки -->
        <div class="card-actions" style="flex-direction: column; gap: 10px; margin-top: 20px;">
            <div class="text-center">
                <a href="{% url 'password_reset' %}" class="btn-modern btn-outline-modern" style="display: inline-block; padding: 10px 20px; border: 2px solid #667eea; color: #667eea; border-radius: 8px; text-decoration: none; font-weight: 500; transition: all 0.3s;">
                    <i class="bi bi-key"></i>
                    Забыли пароль?
                </a>
            </div>
        </div>
    </div>
</div>

<style>
/* Стили для карточки */
.card-modern {
    background: white;
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    padding: 30px;
    margin: 20px 0;
}

.card-modern-header {
    text-align: center;
    margin-bottom: 30px;
}

.card-modern-title {
    color: #2c3e50;
    font-weight: 600;
    margin-bottom: 8px;
    font-size: 1.5rem;
}

.card-modern-subtitle {
    color: #6b7280;
    font-size: 0.95rem;
}

.card-modern-body {
    margin-bottom: 20px;
}

/* Стили для полей ввода при фокусе */
.form-control:focus {
    outline: none;
    border-color: #667eea !important;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

/* Стили для кнопок */
.card-actions {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.btn-modern:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.btn-primary-gradient:hover {
    background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%) !important;
}

.btn-outline-modern:hover {
    background: #667eea;
    color: white;
}

/* Адаптивность для мобильных */
@media (max-width: 768px) {
    .container {
        padding: 10px;
    }

    .card-modern {
        padding: 20px;
        margin: 10px 0;
    }

    .card-actions {
        flex-direction: column;
    }
}
</style>
{% endblock %}


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\account\templates\account\profile.html
============================================================

{% extends "mebel/base.html" %}
{% load static %}

{% block title %}Мой профиль{% endblock %}

{% block content %}
<div class="container" style="max-width: 800px; margin: 0 auto; padding: 20px;">
    <h1 class="text-center mb-4" style="color: #2c3e50; font-weight: 600;">👤 Мой профиль</h1>

    <div class="card-modern">
        <!-- Заголовок профиля с аватаром -->
        <div class="card-modern-header">
            <div class="text-center mb-4">
                {% if profile.photo and profile.photo.url %}
                    <img src="{{ profile.photo.url }}"
                         alt="Фото {{ profile.user.username }}"
                         class="profile-avatar"
                         style="width: 150px; height: 150px; object-fit: cover; border-radius: 50%; border: 5px solid rgba(255,255,255,0.3); box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
                {% else %}
                    <img src="{% static 'img/no_image.png' %}"
                         alt="Фото отсутствует"
                         class="profile-avatar"
                         style="width: 150px; height: 150px; object-fit: cover; border-radius: 50%; border: 5px solid rgba(255,255,255,0.3); box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
                {% endif %}
            </div>

            <div class="text-center">
                <h2 class="card-modern-title" style="margin-bottom: 5px;">{{ profile.user.get_full_name|default:profile.user.username }}</h2>
                <p class="card-modern-subtitle">@{{ profile.user.username }}</p>
                <div class="online-status" style="display: inline-flex; align-items: center; gap: 5px; font-size: 0.9rem; opacity: 0.8;">
                    <span class="status-dot" style="width: 8px; height: 8px; background: #4ade80; border-radius: 50%; animation: pulse 2s infinite;"></span>
                    В сети
                </div>
            </div>
        </div>

        <!-- Детали профиля -->
        <div class="card-modern-body">
            <div class="detail-row">
                <span class="detail-label">👤 Логин:</span>
                <span class="detail-value">{{ profile.user.username }}</span>
            </div>

            <div class="detail-row">
                <span class="detail-label">📧 Email:</span>
                <span class="detail-value">
                    {% if profile.user.email %}
                        {{ profile.user.email }}
                    {% else %}
                        <span style="color: #999;">Не указан</span>
                    {% endif %}
                </span>
            </div>

            <div class="detail-row">
                <span class="detail-label">🎂 Дата рождения:</span>
                <span class="detail-value">
                    {% if profile.date_of_birth %}
                        {{ profile.date_of_birth|date:"d.m.Y" }}
                    {% else %}
                        <span style="color: #999;">Не указана</span>
                    {% endif %}
                </span>
            </div>

            <div class="detail-row">
                <span class="detail-label">🏢 Роль:</span>
                <span class="detail-value">
                    {% if user.groups.all %}
                        {{ user.groups.all.0.name }}
                    {% else %}
                        {% if user.is_staff %}
                            <span style="color: #e74c3c;">👑 Администратор</span>
                        {% else %}
                            <span style="color: #999;">👤 Пользователь</span>
                        {% endif %}
                    {% endif %}
                </span>
            </div>

            <div class="detail-row">
                <span class="detail-label">📅 Дата регистрации:</span>
                <span class="detail-value">{{ profile.user.date_joined|date:"d.m.Y" }}</span>
            </div>
        </div>

        <!-- Действия профиля -->
        <div class="card-actions">
            <a href="{% url 'account:edit' %}" class="btn-modern btn-primary-gradient">
                <i class="bi bi-pencil-square"></i>
                Редактировать профиль
            </a>

            <a href="{% url 'account:password_change' %}" class="btn-modern btn-outline-modern">
                <i class="bi bi-shield-lock"></i>
                Сменить пароль
            </a>

            <a href="{% url 'account:logout' %}" class="btn-modern btn-danger-modern">
                <i class="bi bi-box-arrow-right"></i>
                Выйти
            </a>
        </div>
    </div>
</div>

<style>
/* Анимация пульсации для статуса */
@keyframes pulse {
    0% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7);
    }
    70% {
        transform: scale(1);
        box-shadow: 0 0 0 5px rgba(74, 222, 128, 0);
    }
    100% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(74, 222, 128, 0);
    }
}

/* Адаптивность для мобильных */
@media (max-width: 768px) {
    .container {
        padding: 10px;
    }

    .profile-avatar {
        width: 120px !important;
        height: 120px !important;
    }

    .card-actions {
        flex-direction: column;
    }

    .detail-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
    }

    .detail-value {
        text-align: left;
    }
}
</style>
{% endblock %}


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\account\templates\account\register.html
============================================================

{% extends "mebel/base.html" %}

{% block title %}Create an account{% endblock %}

{% block content %}
  <h1>Create an account</h1>
  <p>Please, sign up using the following form:</p>
  <form method="post">
      {% csrf_token %}
      {% include "includes/form_errors.html" with form=user_form %}
      {{ user_form.as_p }}
      <p><input type="submit" value="Create my account"></p>
  </form>
{% endblock %}


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\account\templates\account\register_done.html
============================================================

{% extends "mebel/base.html" %}

{% block title %}Welcome{% endblock %}

{% block content %}
  <h1>Welcome {{ new_user.first_name }}!</h1>
  <p>
    Your account has been successfully created.
    Now you can <a href="{% url "account:login" %}">log in</a>.
  </p>
{% endblock %}


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\account\templates\registration\logged_out.html
============================================================

{% extends "mebel/base.html" %}
{% load static %}

{% block title %}Выход из системы{% endblock %}

{% block extra_css %}
<style>
/* Основные стили контейнера */
.dashboard-container {
    max-width: 600px;
    margin: 0 auto;
    padding: 40px 20px;
    text-align: center;
}

.page-header {
    text-align: center;
    margin-bottom: 40px;
}

.page-header h1 {
    color: #2c3e50;
    font-weight: 700;
    font-size: 2.5rem;
    margin-bottom: 20px;
}

.page-header p {
    color: #6b7280;
    font-size: 1.2rem;
    line-height: 1.6;
}

/* Стили для карточек */
.card-modern {
    background: white;
    border-radius: 16px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.08);
    border: none;
    overflow: hidden;
    margin-bottom: 25px;
    padding: 40px;
}

/* Иконка выхода */
.logout-icon {
    font-size: 4rem;
    margin-bottom: 20px;
    color: #667eea;
}

/* Кнопки */
.btn-modern {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 12px 30px;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
    margin: 10px;
}

.btn-modern:hover {
    background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    color: white;
    text-decoration: none;
}

.btn-secondary-modern {
    background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
}

.btn-secondary-modern:hover {
    background: linear-gradient(135deg, #5a6170 0%, #424b5c 100%);
}

/* Анимации */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.card-modern {
    animation: fadeInUp 0.6s ease-out;
}

@keyframes bounce {
    0%, 20%, 50%, 80%, 100% {
        transform: translateY(0);
    }
    40% {
        transform: translateY(-10px);
    }
    60% {
        transform: translateY(-5px);
    }
}

.logout-icon {
    animation: bounce 2s infinite;
}

/* Дополнительные стили */
.action-buttons {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-top: 30px;
    flex-wrap: wrap;
}

.message-text {
    color: #6b7280;
    font-size: 1.1rem;
    line-height: 1.6;
    margin-bottom: 10px;
}

/* Адаптивность */
@media (max-width: 768px) {
    .dashboard-container {
        padding: 20px 15px;
    }

    .page-header h1 {
        font-size: 2rem;
    }

    .card-modern {
        padding: 30px 20px;
    }

    .logout-icon {
        font-size: 3rem;
    }

    .action-buttons {
        flex-direction: column;
        align-items: center;
    }

    .btn-modern {
        width: 200px;
        justify-content: center;
    }
}

@media (max-width: 576px) {
    .page-header h1 {
        font-size: 1.8rem;
    }

    .page-header p {
        font-size: 1rem;
    }

    .message-text {
        font-size: 1rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Заголовок страницы -->
    <div class="page-header">
        <h1>👋 Выход выполнен</h1>
        <p>Вы успешно вышли из системы</p>
    </div>

    <!-- Карточка с сообщением -->
    <div class="card-modern">
        <div class="logout-icon">✅</div>

        <div class="message-text">
            <p>Вы были успешно вышли из вашего аккаунта.</p>
            <p>Благодарим за использование нашей системы!</p>
        </div>

        <!-- Кнопки действий -->
        <div class="action-buttons">
            <a href="{% url 'account:login' %}" class="btn-modern">
                🔐 Войти снова
            </a>
        </div>
    </div>
</div>
{% endblock %}


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\account\templates\registration\login.html
============================================================

{% extends "mebel/base.html" %}
{% load static %}

{% block title %}Авторизация{% endblock %}

{% block content %}
<div class="container" style="max-width: 500px; margin: 0 auto; padding: 20px;">
    <h1 class="text-center mb-4" style="color: #2c3e50; font-weight: 600;">🔐 Авторизация</h1>

    <div class="card-modern">
        <!-- Информационное сообщение -->
        <div class="card-modern-header">
            {% if form.errors %}
                <div class="alert-danger" style="background: #fee; border: 1px solid #fcc; color: #c33; padding: 12px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
                    <strong>Ошибка в имени пользователя или неверный пароль</strong>
                </div>
            {% else %}
                <p class="card-modern-subtitle text-center" style="color: #9ca3af; margin-bottom: 20px;">
                    Пожалуйста, введите данные авторизации, выданные вам администратором:
                </p>
            {% endif %}
        </div>

        <!-- Форма авторизации -->
        <div class="card-modern-body">
            <form action="{% url 'account:login' %}" method="post" class="auth-form">
                {% csrf_token %}
                <input type="hidden" name="next" value="{{ next }}" />

                <!-- Поле имени пользователя -->
                <div class="form-group mb-4">
                    <label for="id_username" class="form-label" style="display: block; margin-bottom: 8px; font-weight: 500; color: #2c3e50;">
                        👤 Имя пользователя
                    </label>
                    <input type="text"
                           name="username"
                           id="id_username"
                           class="form-control"
                           style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; transition: border-color 0.3s;"
                           placeholder="Введите имя пользователя"
                           required>
                </div>

                <!-- Поле пароля -->
                <div class="form-group mb-4">
                    <label for="id_password" class="form-label" style="display: block; margin-bottom: 8px; font-weight: 500; color: #2c3e50;">
                        🔒 Пароль
                    </label>
                    <input type="password"
                           name="password"
                           id="id_password"
                           class="form-control"
                           style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; transition: border-color 0.3s;"
                           placeholder="Введите пароль"
                           required>
                </div>

                <!-- Кнопка отправки -->
                <div class="card-actions">
                    <button type="submit" class="btn-modern btn-primary-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; font-weight: 500; cursor: pointer; transition: all 0.3s; width: 100%;">
                        Войти в систему
                    </button>
                </div>
            </form>
        </div>

        <!-- Ссылка на восстановление пароля -->
        <div class="card-actions" style="flex-direction: column; gap: 10px; margin-top: 20px;">
            <div class="text-center">
                <a href="{% url 'account:password_reset' %}" class="btn-modern btn-outline-modern" style="display: inline-block; padding: 10px 20px; border: 2px solid #667eea; color: #667eea; border-radius: 8px; text-decoration: none; font-weight: 500; transition: all 0.3s;">
                    Забыли свой пароль?
                </a>
            </div>
        </div>
    </div>
</div>

<style>
/* Стили для карточки */
.card-modern {
    background: white;
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    padding: 30px;
    margin: 20px 0;
}

.card-modern-header {
    margin-bottom: 20px;
}

.card-modern-title {
    color: #2c3e50;
    font-weight: 600;
    margin-bottom: 8px;
    font-size: 1.5rem;
}

.card-modern-subtitle {
    color: #6b7280;
    font-size: 0.95rem;
    line-height: 1.5;
}

.card-modern-body {
    margin-bottom: 20px;
}

/* Стили для полей ввода */
.form-control {
    width: 100%;
    padding: 12px;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    font-size: 16px;
    transition: border-color 0.3s;
}

.form-control:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

/* Стили для кнопок */
.card-actions {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.btn-modern {
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
    text-decoration: none;
    display: inline-block;
    text-align: center;
}

.btn-primary-gradient {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.btn-primary-gradient:hover {
    background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.btn-outline-modern {
    background: transparent;
    border: 2px solid #667eea;
    color: #667eea;
}

.btn-outline-modern:hover {
    background: #667eea;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

/* Текст по центру */
.text-center {
    text-align: center;
}

/* Адаптивность для мобильных */
@media (max-width: 768px) {
    .container {
        padding: 10px;
    }

    .card-modern {
        padding: 20px;
        margin: 10px 0;
    }

    .card-actions {
        flex-direction: column;
    }

    .btn-modern {
        width: 100%;
    }
}

/* Анимация появления */
.card-modern {
    animation: fadeInUp 0.6s ease-out;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>
{% endblock %}


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\account\templates\registration\password_ change_done.html
============================================================

{% extends "mebel/base.html" %}

{% block title %}Password changed{% endblock %}

{% block content %}
  <h1>Password changed</h1>
  <p>Your password has been successfully changed.</p>
{% endblock %}


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\account\templates\registration\password_ reset_email.html
============================================================

Someone asked for password reset for email {{ email }}. Follow the link below:
{{ protocol }}://{{ domain }}{% url "password_reset_confirm" uidb64=uid token=token %}
Your username, in case you've forgotten: {{ user.get_username }}


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\account\templates\registration\password_change_form.html
============================================================

{% extends "mebel/base.html" %}
{% load static %}

{% block title %}Смена пароля{% endblock %}

{% block extra_css %}
<style>
/* Основные стили контейнера */
.dashboard-container {
    max-width: 600px;
    margin: 0 auto;
    padding: 40px 20px;
}

.page-header {
    text-align: center;
    margin-bottom: 40px;
}

.page-header h1 {
    color: #2c3e50;
    font-weight: 700;
    font-size: 2.5rem;
    margin-bottom: 10px;
}

.page-header p {
    color: #6b7280;
    font-size: 1.2rem;
}

/* Стили для карточек */
.card-modern {
    background: white;
    border-radius: 16px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.08);
    border: none;
    overflow: hidden;
    margin-bottom: 25px;
}

.card-modern-header {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    padding: 20px 25px;
    border-bottom: 1px solid #e2e8f0;
}

.card-modern-title {
    color: #2c3e50;
    font-weight: 600;
    margin: 0;
    font-size: 1.3rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

.card-modern-body {
    padding: 30px;
}

/* Стили для форм */
.form-modern {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.form-label {
    font-weight: 600;
    color: #2c3e50;
    font-size: 0.9rem;
}

.form-input {
    padding: 12px 15px;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    font-size: 0.9rem;
    outline: none;
    transition: all 0.3s;
    background: white;
}

.form-input:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

/* Кнопки */
.btn-modern {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 12px 30px;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
    margin-top: 10px;
}

.btn-modern:hover {
    background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    color: white;
    text-decoration: none;
}

/* Стили для ошибок */
.form-errors {
    background: #fef2f2;
    border: 1px solid #fecaca;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
}

.form-error {
    color: #dc2626;
    font-size: 0.8rem;
    margin: 5px 0;
}

.form-error ul {
    margin: 0;
    padding-left: 20px;
}

/* Анимации */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.card-modern {
    animation: fadeInUp 0.6s ease-out;
}

/* Стили для подсказок пароля */
.password-help {
    background: #f0f9ff;
    border: 1px solid #bae6fd;
    border-radius: 8px;
    padding: 15px;
    margin-top: 20px;
}

.password-help-title {
    font-weight: 600;
    color: #0369a1;
    margin-bottom: 10px;
    font-size: 0.9rem;
}

.password-help-list {
    margin: 0;
    padding-left: 20px;
    color: #64748b;
    font-size: 0.8rem;
    line-height: 1.5;
}

.password-help-list li {
    margin-bottom: 5px;
}

/* Индикатор сложности пароля */
.password-strength {
    margin-top: 5px;
    height: 4px;
    border-radius: 2px;
    background: #e2e8f0;
    overflow: hidden;
}

.password-strength-bar {
    height: 100%;
    transition: all 0.3s;
    width: 0%;
}

.strength-weak {
    background: #ef4444;
    width: 25%;
}

.strength-fair {
    background: #f59e0b;
    width: 50%;
}

.strength-good {
    background: #10b981;
    width: 75%;
}

.strength-strong {
    background: #059669;
    width: 100%;
}

/* Адаптивность */
@media (max-width: 768px) {
    .dashboard-container {
        padding: 20px 15px;
    }

    .page-header h1 {
        font-size: 2rem;
    }

    .card-modern-body {
        padding: 25px 20px;
    }

    .form-group {
        gap: 6px;
    }

    .form-input {
        padding: 10px 12px;
    }
}

@media (max-width: 576px) {
    .page-header h1 {
        font-size: 1.8rem;
    }

    .page-header p {
        font-size: 1rem;
    }

    .card-modern-header {
        padding: 15px 20px;
    }

    .btn-modern {
        width: 100%;
        justify-content: center;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Заголовок страницы -->
    <div class="page-header">
        <h1>🔐 Смена пароля</h1>
        <p>Обновите ваш пароль для обеспечения безопасности</p>
    </div>

    <!-- Карточка с формой -->
    <div class="card-modern">
        <div class="card-modern-header">
            <h5 class="card-modern-title">
                🔒 Новый пароль
            </h5>
        </div>
        <div class="card-modern-body">
            <form method="post" class="form-modern">
                {% csrf_token %}

                <!-- Ошибки формы -->
                {% if form.errors %}
                <div class="form-errors">
                    <div class="form-error">
                        Пожалуйста, исправьте следующие ошибки:
                        {{ form.errors }}
                    </div>
                </div>
                {% endif %}

                <!-- Поля формы -->
                {% for field in form %}
                <div class="form-group">
                    <label for="{{ field.id_for_label }}" class="form-label">
                        {{ field.label }}
                    </label>
                    {{ field }}

                    {% if field.errors %}
                    <div class="form-error">
                        {{ field.errors }}
                    </div>
                    {% endif %}

                    {% if field.help_text %}
                    <small style="color: #6b7280; font-size: 0.8rem;">
                        {{ field.help_text }}
                    </small>
                    {% endif %}

                    <!-- Индикатор сложности пароля для нового пароля -->
                    {% if field.name == 'new_password1' %}
                    <div class="password-strength">
                        <div class="password-strength-bar" id="passwordStrengthBar"></div>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}

                <!-- Подсказки для пароля -->
                <div class="password-help">
                    <div class="password-help-title">💡 Требования к паролю:</div>
                    <ul class="password-help-list">
                        <li>Пароль не должен быть слишком похож на другую вашу личную информацию</li>
                        <li>Пароль должен содержать как минимум 8 символов</li>
                        <li>Пароль не должен быть слишком простым и распространенным</li>
                        <li>Пароль не может состоять только из цифр</li>
                    </ul>
                </div>

                <!-- Кнопка отправки -->
                <button type="submit" class="btn-modern">
                    💾 Сменить пароль
                </button>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Добавляем классы к полям формы
    const inputs = document.querySelectorAll('input');
    inputs.forEach(input => {
        if (!input.classList.contains('form-input')) {
            input.classList.add('form-input');
        }
    });

    // Индикатор сложности пароля
    const newPasswordInput = document.querySelector('#id_new_password1');
    const strengthBar = document.querySelector('#passwordStrengthBar');

    if (newPasswordInput && strengthBar) {
        newPasswordInput.addEventListener('input', function() {
            const password = this.value;
            let strength = 0;

            // Проверка длины
            if (password.length >= 8) strength += 25;

            // Проверка на наличие цифр
            if (/\d/.test(password)) strength += 25;

            // Проверка на наличие букв в разных регистрах
            if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength += 25;

            // Проверка на наличие специальных символов
            if (/[^a-zA-Z0-9]/.test(password)) strength += 25;

            // Обновляем индикатор
            strengthBar.className = 'password-strength-bar';
            if (strength <= 25) {
                strengthBar.classList.add('strength-weak');
            } else if (strength <= 50) {
                strengthBar.classList.add('strength-fair');
            } else if (strength <= 75) {
                strengthBar.classList.add('strength-good');
            } else {
                strengthBar.classList.add('strength-strong');
            }
        });
    }

    // Подтверждение пароля в реальном времени
    const password1 = document.querySelector('#id_new_password1');
    const password2 = document.querySelector('#id_new_password2');

    if (password1 && password2) {
        function checkPasswordMatch() {
            if (password2.value && password1.value !== password2.value) {
                password2.style.borderColor = '#ef4444';
            } else if (password2.value) {
                password2.style.borderColor = '#10b981';
            } else {
                password2.style.borderColor = '#e2e8f0';
            }
        }

        password1.addEventListener('input', checkPasswordMatch);
        password2.addEventListener('input', checkPasswordMatch);
    }
});
</script>
{% endblock %}


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\account\templates\registration\password_reset_complete.html
============================================================

{% extends "mebel/base.html" %}

{% block title %}Password reset{% endblock %}

{% block content %}
  <h1>Password set</h1>
  <p>Your password has been set. You can <a href="{% url "account:login" %}">log in now</a></p>
{% endblock %}


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\account\templates\registration\password_reset_confirm.html
============================================================

{% extends "mebel/base.html" %}

{% block title %}Reset your password{% endblock %}

{% block content %}
  <h1>Reset your password</h1>
  {% if validlink %}
    <p>Please enter your new password twice:</p>
    <form method="post">
      {{ form.as_p }}
      {% csrf_token %}
      <p><input type="submit" value="Change my password" /></p>
    </form>
  {% else %}
    <p>The password reset link was invalid, possibly because it has already been used. Please request a new password reset.</p>
  {% endif %}
{% endblock %}


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\account\templates\registration\password_reset_done.html
============================================================

{% extends "mebel/base.html" %}

{% block title %}Reset your password{% endblock %}

{% block content %}
  <h1>Reset your password</h1>
  <p>We've emailed you instructions for setting your password.</p>
  <p>If you don't receive an email, please make sure you've entered the address you registered with.</p>
{% endblock %}


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\account\templates\registration\password_reset_form.html
============================================================

{% extends "mebel/base.html" %}

{% block title %}Reset your password{% endblock %}

{% block content %}
  <h1>Forgotten your password?</h1>
  <p>Enter your e-mail address to obtain a new password.</p>
  <form method="post">
    {{ form.as_p }}
    <p><input type="submit" value="Send e-mail"></p>
    {% csrf_token %}
  </form>
{% endblock %}


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\account\templates\base.html
============================================================

{% load static %}
<!DOCTYPE html>
<html>
<head>
  <title>{% block title %}{% endblock %}</title>
  <link rel="stylesheet" href="{% static 'css/profile.css' %}">
  <link href="{% static "css/base.css" %}" rel="stylesheet">
</head>
<body>
  <div id="header">
    <span class="logo">Bookmarks</span>
    {% if request.user.is_authenticated %}
      <ul class="menu">
        <li {% if section == "dashboard" %}class="selected"{% endif %}>
          <a href="{% url "mebel:main_dashboard" %}">My dashboard</a>
        </li>
        <li {% if section == "images" %}class="selected"{% endif %}>
          <a href="#">Images</a>
        </li>
        <li {% if section == "people" %}class="selected"{% endif %}>
          <a href="#">People</a>
        </li>
      </ul>
    {% endif %}
    <span class="user">
      {% if request.user.is_authenticated %}
        Hello {{ request.user.first_name|default:request.user.username }},
        <a href="{% url "account:logout" %}">Logout</a>
      {% else %}
        <a href="{% url "account:login" %}">Log-in</a>
      {% endif %}
    </span>
  </div>
  {% if messages %}
    <ul class="messages">
      {% for message in messages %}
        <li class="{{ message.tags }}">
          {{ message|safe }}
          <a href="#" class="close">x</a>
        </li>
      {% endfor %}
    </ul>
  {% endif %}
  <div id="content">
    {% block content %}
    {% endblock %}
  </div>
</body>
</html>


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\account\admin.py
============================================================

from django.contrib import admin
from .models import Profile


@admin.register(Profile)
class ProfileAdmin(admin.ModelAdmin):
 list_display = ['user', 'date_of_birth', 'photo']
 raw_id_fields = ['user']


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\account\apps.py
============================================================

from django.apps import AppConfig


class AccountConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'account'


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\account\forms.py
============================================================

from django import forms
from django.contrib.auth.models import User
from .models import Profile

class LoginForm(forms.Form):
    username = forms.CharField()
    password = forms.CharField(widget=forms.PasswordInput)

class UserRegistrationForm(forms.ModelForm):
    password = forms.CharField(label='Password',
                               widget=forms.PasswordInput)
    password2 = forms.CharField(label='Repeat password',
                                widget=forms.PasswordInput)

    class Meta:
        model = User
        fields = ['username', 'first_name', 'email']

    def clean_password2(self):
        cd = self.cleaned_data
        if cd['password'] != cd['password2']:
            raise forms.ValidationError('Passwords don\'t match.')
        return cd['password2']

    def clean_email(self):
        data = self.cleaned_data['email']
        if User.objects.filter(email=data).exists():
            raise forms.ValidationError('Email already in use.')
        return data

class UserEditForm(forms.ModelForm):
    class Meta:
        model = User
        fields = ['first_name', 'last_name', 'email']

    def clean_email(self):
        data = self.cleaned_data['email']
        qs = User.objects.exclude(id=self.instance.id)\
                         .filter(email=data)
        if qs.exists():
            raise forms.ValidationError('Email already in use.')
        return data


class ProfileEditForm(forms.ModelForm):
    class Meta:
        model = Profile
        fields = ['date_of_birth', 'photo']


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\account\models.py
============================================================

from django.db import models
from django.conf import settings


class Profile(models.Model):
    user = models.OneToOneField(settings.AUTH_USER_MODEL,
                                on_delete=models.CASCADE)
    date_of_birth = models.DateField(blank=True, null=True)
    photo = models.ImageField(upload_to='users/%Y/%m/%d/',
                              blank=True)

    def __str__(self):
        return f'Profile of {self.user.username}'


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\account\tests.py
============================================================

from django.test import TestCase

# Create your tests here.


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\account\urls.py
============================================================

from django.urls import path, include
from django.contrib.auth import views as auth_views
from . import views

app_name = 'account'

urlpatterns = [
    #адреса входа и выхода
    path('login/', auth_views.LoginView.as_view(), name='login'),
    path('logout/', auth_views.LogoutView.as_view(), name='logout'),
    # change password urls
    path('', include('django.contrib.auth.urls')),
    path('profile/', views.profile_view, name='profile'),
    path('register/', views.register, name='register'),
    path('edit/', views.edit, name='edit'),
]


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\account\views.py
============================================================

from django.http import HttpResponse
from django.shortcuts import render, redirect
from django.contrib.auth import authenticate, login
from django.contrib.auth.decorators import login_required
from django.contrib import messages
from .forms import LoginForm, UserRegistrationForm, UserEditForm, ProfileEditForm
from django.shortcuts import render, get_object_or_404
from django.contrib.auth.decorators import login_required
from .models import Profile


@login_required
def profile_view(request):
    """
    Отображает профиль текущего пользователя.
    Автоматически создает профиль, если он не существует.
    """
    # Получаем или создаем профиль
    profile, created = Profile.objects.get_or_create(user=request.user)

    context = {
        'profile': profile,
        'created': created  # Можно использовать для отладки
    }

    return render(request, 'account/profile.html', context)

def register(request):
    if request.method == 'POST':
        user_form = UserRegistrationForm(request.POST)
        if user_form.is_valid():
            # Create a new user object but avoid saving it yet
            new_user = user_form.save(commit=False)
            # Set the chosen password
            new_user.set_password(
                user_form.cleaned_data['password'])
            # Save the User object
            new_user.save()
            # Create the user profile
            Profile.objects.create(user=new_user)
            return render(request,
                          'account/register_done.html',
                          {'new_user': new_user})
    else:
        user_form = UserRegistrationForm()
    return render(request,
                  'account/register.html',
                  {'user_form': user_form})

@login_required
def dashboard(request):
    return redirect('mebel:main_dashboard')

@login_required
def edit(request):
    try:
        profile = request.user.profile
    except Profile.DoesNotExist:
        profile = Profile.objects.create(user=request.user)
    if request.method == 'POST':
        user_form = UserEditForm(instance=request.user,
                                 data=request.POST)
        profile_form = ProfileEditForm(
                                    instance=request.user.profile,
                                    data=request.POST,
                                    files=request.FILES)
        if user_form.is_valid() and profile_form.is_valid():
            user_form.save()
            profile_form.save()
            messages.success(request, 'Profile updated '\
                                      'successfully')
            return redirect('account:profile')
        else:
            messages.error(request, 'Error updating your profile')
    else:
        user_form = UserEditForm(instance=request.user)
        profile_form = ProfileEditForm(
                                    instance=request.user.profile)
    return render(request,
                  'account/edit.html',
                  {'user_form': user_form,
                   'profile_form': profile_form})

def custom_permission_denied_view(request, exception=None):
    return render(request, '403.html', status=403)


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\account\__init__.py
============================================================



============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\mebel\management\commands\sync_materials.py
============================================================

from django.core.management.base import BaseCommand
from mebel.models import Material

class Command(BaseCommand):
    help = 'Синхронизирует резервы материалов с актуальными данными заказов'

    def handle(self, *args, **options):
        Material.update_all_reserved_quantities()
        self.stdout.write(
            self.style.SUCCESS('✅ Резервы материалов успешно синхронизированы с заказами')
        )


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\mebel\templates\mebel\includes\modern_card.html
============================================================

<!-- modern_card.html -->
<div class="card-modern">
    {% if header %}
    <div class="card-modern-header">
        <h2 class="card-modern-title">{{ title }}</h2>
        {% if subtitle %}<p class="card-modern-subtitle">{{ subtitle }}</p>{% endif %}
    </div>
    {% endif %}

    <div class="card-modern-body">
        {{ content|safe }}
    </div>

    {% if actions %}
    <div class="card-actions">
        {% for action in actions %}
        <a href="{{ action.url }}" class="btn-modern {{ action.class }}">
            {% if action.icon %}<i class="{{ action.icon }}"></i>{% endif %}
            {{ action.text }}
        </a>
        {% endfor %}
    </div>
    {% endif %}
</div>


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\mebel\templates\mebel\includes\supplier_modal_form.html
============================================================

<div class="modal-header">
    <h5 class="modal-title">Добавить нового поставщика</h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<form id="supplier-create-form" method="post" action="{% url 'mebel:supplier_create_modal' %}">
    <div class="modal-body">
        {% csrf_token %}
        <div id="supplier-form-errors"></div>

        <div class="mb-3">
            <label class="form-label">{{ form.name.label }}</label>
            {{ form.name }}
            <div class="form-text">Обязательное поле</div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label">{{ form.contact_person.label }}</label>
                    {{ form.contact_person }}
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label">{{ form.phone.label }}</label>
                    {{ form.phone }}
                </div>
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">{{ form.email.label }}</label>
            {{ form.email }}
        </div>

        <div class="mb-3">
            <label class="form-label">{{ form.address.label }}</label>
            {{ form.address }}
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
        <button type="submit" class="btn btn-primary">Создать поставщика</button>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('supplier-create-form');
    const errorContainer = document.getElementById('supplier-form-errors');

    // Функция для сохранения данных формы материала
    function saveMaterialFormData() {
        const materialForm = document.querySelector('form[enctype="multipart/form-data"]');
        if (!materialForm) return null;

        const formData = {};
        const inputs = materialForm.querySelectorAll('input, select, textarea');

        inputs.forEach(input => {
            if (input.name && input.type !== 'file') {
                if (input.type === 'checkbox' || input.type === 'radio') {
                    formData[input.name] = input.checked;
                } else {
                    formData[input.name] = input.value;
                }
            }
        });

        // Сохраняем в sessionStorage
        sessionStorage.setItem('materialFormData', JSON.stringify(formData));
        return formData;
    }

    // Функция для восстановления данных формы материала
    function restoreMaterialFormData() {
        const savedData = sessionStorage.getItem('materialFormData');
        if (!savedData) return;

        const formData = JSON.parse(savedData);
        const materialForm = document.querySelector('form[enctype="multipart/form-data"]');
        if (!materialForm) return;

        Object.keys(formData).forEach(name => {
            const input = materialForm.querySelector(`[name="${name}"]`);
            if (input) {
                if (input.type === 'checkbox' || input.type === 'radio') {
                    input.checked = formData[name];
                } else {
                    input.value = formData[name];
                }

                // Триггерим событие change для обновления зависимых полей
                const event = new Event('change', { bubbles: true });
                input.dispatchEvent(event);
            }
        });

        // Очищаем сохраненные данные
        sessionStorage.removeItem('materialFormData');
    }

    form.addEventListener('submit', function(e) {
        e.preventDefault();

        // Сохраняем данные формы материала перед отправкой
        saveMaterialFormData();

        // Показываем индикатор загрузки
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Создание...';
        submitBtn.disabled = true;

        // Отправляем форму через AJAX
        fetch(form.action, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: new FormData(form)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Обновляем select с поставщиками
                const supplierSelect = document.getElementById('supplier-select');
                if (supplierSelect) {
                    const newOption = new Option(data.supplier_name, data.supplier_id, true, true);
                    supplierSelect.add(newOption);

                    // Восстанавливаем данные формы материала
                    setTimeout(restoreMaterialFormData, 100);
                }

                // Обновляем другие возможные select'ы на странице
                document.querySelectorAll('select[name="supplier"]').forEach(select => {
                    if (select.id !== 'supplier-select') {
                        const option = new Option(data.supplier_name, data.supplier_id);
                        select.add(option);
                    }
                });

                // Закрываем модальное окно
                const modal = bootstrap.Modal.getInstance(document.getElementById('supplierModal'));
                if (modal) {
                    modal.hide();
                }

                // Показываем сообщение об успехе
                showAlert('success', data.message);

                // Очищаем форму поставщика
                form.reset();
                errorContainer.innerHTML = '';

            } else {
                // Показываем ошибки валидации
                showFormErrors(errorContainer, data.errors);

                // Восстанавливаем данные формы материала при ошибке
                setTimeout(restoreMaterialFormData, 100);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('danger', 'Произошла ошибка при создании поставщика');

            // Восстанавливаем данные формы материала при ошибке
            setTimeout(restoreMaterialFormData, 100);
        })
        .finally(() => {
            // Восстанавливаем кнопку
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        });
    });

    // Восстанавливаем данные при закрытии модалки без создания поставщика
    document.getElementById('supplierModal').addEventListener('hidden.bs.modal', function() {
        setTimeout(restoreMaterialFormData, 100);
    });

    function showFormErrors(container, errors) {
        let html = '<div class="alert alert-danger">';
        html += '<strong>Ошибки в форме:</strong><ul>';
        for (const field in errors) {
            const fieldNames = {
                'name': 'Название',
                'contact_person': 'Контактное лицо',
                'phone': 'Телефон',
                'email': 'Email',
                'address': 'Адрес'
            };
            const fieldName = fieldNames[field] || field;
            html += `<li><strong>${fieldName}:</strong> ${errors[field].join(', ')}</li>`;
        }
        html += '</ul></div>';
        container.innerHTML = html;

        container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function showAlert(type, message) {
        // Удаляем существующие алерты того же типа
        document.querySelectorAll(`.alert-${type}`).forEach(alert => {
            if (alert.parentNode) {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            }
        });

        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show mt-3`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        const header = document.querySelector('h1') || document.querySelector('.container');
        if (header) {
            header.parentNode.insertBefore(alertDiv, header.nextSibling);
        } else {
            document.querySelector('.container').prepend(alertDiv);
        }

        setTimeout(() => {
            if (alertDiv.parentNode) {
                const bsAlert = new bootstrap.Alert(alertDiv);
                bsAlert.close();
            }
        }, 5000);
    }

    // Автофокус на первое поле при открытии модалки
    const firstInput = form.querySelector('input[type="text"], input[type="email"]');
    if (firstInput) {
        setTimeout(() => firstInput.focus(), 300);
    }
});
</script>


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\mebel\templates\mebel\material\create.html
============================================================

{% extends "mebel/base.html" %}
{% load static %}

{% block title %}Добавить материал{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Заголовок страницы -->
    <div class="page-header">
        <h1>📦 Добавить материал</h1>
        <p>Создайте новую позицию в каталоге материалов</p>
    </div>

    <div class="card-modern">
        <div class="card-modern-header">
            <h5 class="card-modern-title">➕ Новый материал</h5>
        </div>

        <form method="post" enctype="multipart/form-data" class="modern-form">
            {% csrf_token %}

            <!-- Основная информация -->
            <div class="form-section">
                <h6 class="section-title">📋 Основная информация</h6>

                {% include "includes/form_errors.html" with form=form %}

                <div class="form-grid">
                    <div class="form-group">
                        <label for="{{ form.name.id_for_label }}" class="form-label">
                            📝 {{ form.name.label }}
                        </label>
                        {{ form.name }}
                        {% if form.name.errors %}
                        <div class="error-text">{{ form.name.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="{{ form.category.id_for_label }}" class="form-label">
                            🗂️ {{ form.category.label }}
                        </label>
                        {{ form.category }}
                        {% if form.category.errors %}
                        <div class="error-text">{{ form.category.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="{{ form.price.id_for_label }}" class="form-label">
                            💰 {{ form.price.label }}
                        </label>
                        {{ form.price }}
                        {% if form.price.errors %}
                        <div class="error-text">{{ form.price.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="{{ form.image.id_for_label }}" class="form-label">
                            🖼️ {{ form.image.label }}
                        </label>
                        <div class="file-input-wrapper">
                            {{ form.image }}
                            <div class="file-input-placeholder">
                                <i class="bi bi-cloud-upload"></i>
                                <span>Выберите файл изображения</span>
                            </div>
                        </div>
                        {% if form.image.errors %}
                        <div class="error-text">{{ form.image.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <!-- Блок поставщика -->
                <div class="supplier-section">
                    <h6 class="section-subtitle">🏢 Поставщик</h6>
                    <div class="supplier-row">
                        <div class="supplier-select">
                            <label for="{{ form.supplier.id_for_label }}" class="form-label">
                                👥 {{ form.supplier.label }}
                            </label>
                            {{ form.supplier }}
                            {% if form.supplier.errors %}
                            <div class="error-text">{{ form.supplier.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="supplier-action">
                            <label class="form-label">&nbsp;</label>
                            <button type="button" class="btn-modern btn-outline" data-bs-toggle="modal" data-bs-target="#supplierModal">
                                <i class="bi bi-plus-circle"></i>
                                Добавить поставщика
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Описание -->
                <div class="form-group full-width">
                    <label for="{{ form.description.id_for_label }}" class="form-label">
                        📄 {{ form.description.label }}
                    </label>
                    {{ form.description }}
                    {% if form.description.errors %}
                    <div class="error-text">{{ form.description.errors }}</div>
                    {% endif %}
                </div>
            </div>

            <!-- Кнопки действий -->
            <div class="form-actions">
                <button type="submit" class="btn-modern btn-primary">
                    <i class="bi bi-check-circle"></i>
                    Создать материал
                </button>
                <a href="{% url 'mebel:material_list' %}" class="btn-modern btn-outline">
                    <i class="bi bi-arrow-left"></i>
                    Отмена
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Модальное окно для создания поставщика -->
<div class="modal fade" id="supplierModal" tabindex="-1" aria-labelledby="supplierModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" id="supplier-modal-content">
            <!-- Содержимое будет загружено через AJAX -->
        </div>
    </div>
</div>

<style>
.dashboard-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
}

.page-header {
    text-align: center;
    margin-bottom: 30px;
}

.page-header h1 {
    color: #2c3e50;
    font-weight: 700;
    font-size: 2.5rem;
    margin-bottom: 10px;
}

.page-header p {
    color: #6b7280;
    font-size: 1.2rem;
}

.card-modern {
    background: white;
    border-radius: 16px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.08);
    border: none;
    overflow: hidden;
}

.card-modern-header {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    padding: 20px 25px;
    border-bottom: 1px solid #e2e8f0;
}

.card-modern-title {
    color: #2c3e50;
    font-weight: 600;
    margin: 0;
    font-size: 1.3rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

.form-section {
    padding: 25px;
}

.section-title {
    color: #2c3e50;
    font-weight: 600;
    margin-bottom: 25px;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    gap: 8px;
    padding-bottom: 12px;
    border-bottom: 2px solid #f1f5f9;
}

.section-subtitle {
    color: #2c3e50;
    font-weight: 600;
    margin: 25px 0 15px 0;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 8px;
}

.form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 10px;
}

.form-group {
    margin-bottom: 0;
}

.form-group.full-width {
    grid-column: 1 / -1;
}

.form-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #2c3e50;
    font-size: 0.9rem;
}

.form-control, .form-select {
    width: 100%;
    padding: 12px;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    font-size: 14px;
    transition: all 0.3s;
    background: white;
}

.form-control:focus, .form-select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

textarea.form-control {
    min-height: 100px;
    resize: vertical;
}

.error-text {
    color: #dc2626;
    font-size: 0.8rem;
    margin-top: 5px;
}

/* Стили для загрузки файлов */
.file-input-wrapper {
    position: relative;
}

.file-input-wrapper input[type="file"] {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
    z-index: 2;
}

.file-input-placeholder {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px;
    border: 2px dashed #e2e8f0;
    border-radius: 8px;
    background: #f8fafc;
    color: #6b7280;
    transition: all 0.3s;
    text-align: center;
    justify-content: center;
}

.file-input-wrapper:hover .file-input-placeholder {
    border-color: #667eea;
    background: #f0f4ff;
    color: #667eea;
}

/* Стили для блока поставщика */
.supplier-section {
    margin-top: 25px;
    padding-top: 20px;
    border-top: 1px solid #f1f5f9;
}

.supplier-row {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 15px;
    align-items: end;
}

.supplier-select {
    flex: 1;
}

.supplier-action {
    min-width: 200px;
}

/* Стили для кнопок */
.btn-modern {
    border: none;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    white-space: nowrap;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.btn-primary:hover {
    background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.btn-outline {
    background: transparent;
    border: 2px solid #667eea;
    color: #667eea;
}

.btn-outline:hover {
    background: #667eea;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

/* Стили для действий формы */
.form-actions {
    display: flex;
    gap: 15px;
    justify-content: center;
    padding: 25px;
    border-top: 1px solid #f1f5f9;
    background: #f8fafc;
}

/* Анимации */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.card-modern {
    animation: fadeInUp 0.6s ease-out;
}

/* Стили для модального окна */
.modal-content {
    border-radius: 16px;
    border: none;
    box-shadow: 0 10px 40px rgba(0,0,0,0.1);
}

.modal-header {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    border-bottom: 1px solid #e2e8f0;
    border-radius: 16px 16px 0 0;
    padding: 20px 25px;
}

.modal-title {
    color: #2c3e50;
    font-weight: 600;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 8px;
}

.modal-body {
    padding: 25px;
}

/* Адаптивность */
@media (max-width: 768px) {
    .dashboard-container {
        padding: 15px;
    }

    .page-header h1 {
        font-size: 2rem;
    }

    .form-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }

    .supplier-row {
        grid-template-columns: 1fr;
        gap: 15px;
    }

    .supplier-action {
        min-width: auto;
    }

    .form-actions {
        flex-direction: column;
    }

    .btn-modern {
        width: 100%;
        justify-content: center;
    }

    .modal-dialog {
        margin: 10px;
    }
}

@media (max-width: 480px) {
    .dashboard-container {
        padding: 10px;
    }

    .page-header h1 {
        font-size: 1.8rem;
    }

    .form-section {
        padding: 20px;
    }

    .card-modern-header {
        padding: 15px 20px;
    }
}
</style>
{% endblock %}

{% block domready %}
<script>
// Загрузка формы поставщика в модальное окно
document.getElementById('supplierModal').addEventListener('show.bs.modal', function (event) {
    var modal = this;
    fetch("{% url 'mebel:supplier_create_modal' %}", {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        modal.querySelector('.modal-content').innerHTML = data.html;
    })
    .catch(error => {
        modal.querySelector('.modal-content').innerHTML = `
            <div class="modal-header">
                <h5 class="modal-title">❌ Ошибка</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Не удалось загрузить форму создания поставщика.</p>
            </div>
        `;
    });
});

// Очистка модального окна при закрытии
document.getElementById('supplierModal').addEventListener('hidden.bs.modal', function () {
    this.querySelector('.modal-content').innerHTML = '';
});

// Фокус на поле поставщика после закрытия модалки
document.getElementById('supplierModal').addEventListener('hidden.bs.modal', function () {
    setTimeout(function() {
        const supplierSelect = document.getElementById('{{ form.supplier.id_for_label }}');
        if (supplierSelect) {
            supplierSelect.focus();
        }
    }, 100);
});

// Обработка изменения файла
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.querySelector('input[type="file"]');
    const filePlaceholder = document.querySelector('.file-input-placeholder');

    if (fileInput && filePlaceholder) {
        fileInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                filePlaceholder.innerHTML = `
                    <i class="bi bi-file-earmark-image"></i>
                    <span>${this.files[0].name}</span>
                `;
                filePlaceholder.style.borderColor = '#10b981';
                filePlaceholder.style.background = '#f0fdf4';
                filePlaceholder.style.color = '#059669';
            }
        });
    }
});
</script>
{% endblock %}


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\mebel\templates\mebel\material\detail.html
============================================================

{% extends "mebel/base.html" %}
{% load static %}

{% block title %}{{ material.name }}{% endblock %}

{% block extra_css %}
<style>
.material-detail-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.material-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
}

.material-title {
    color: #2c3e50;
    font-weight: 600;
    margin: 0;
}

.material-content {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
    margin-bottom: 30px;
}

@media (max-width: 768px) {
    .material-content {
        grid-template-columns: 1fr;
    }

    .material-header {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
    }
}

.status-badge {
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: 500;
    font-size: 0.9rem;
}

.status-available {
    background: linear-gradient(135deg, #4ade80, #16a34a);
    color: white;
}

.status-warning {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    color: white;
}

.status-danger {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
}

.operations-table {
    width: 100%;
    border-collapse: collapse;
}

.operations-table th {
    background: #f8f9fa;
    padding: 12px 15px;
    text-align: left;
    font-weight: 600;
    color: #5f6368;
    border-bottom: 2px solid #e9ecef;
}

.operations-table td {
    padding: 12px 15px;
    border-bottom: 1px solid #f1f3f4;
}

.operations-table tr:hover {
    background-color: #f8f9fa;
}

.image-container {
    text-align: center;
    padding: 20px;
}

.material-image {
    max-width: 100%;
    max-height: 400px;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}
</style>
{% endblock %}

{% block content %}
<div class="material-detail-container">
    <!-- Заголовок -->
    <div class="material-header">
        <h1 class="material-title">📦 {{ material.name }}</h1>
        <span class="status-badge {% if material.availability_status == 'green' %}status-available{% elif material.availability_status == 'yellow' %}status-warning{% else %}status-danger{% endif %}">
            {% if material.availability_status == 'green' %}
                ✅ В наличии
            {% elif material.availability_status == 'yellow' %}
                ⚠️ Мало осталось
            {% else %}
                ❌ Нет в наличии
            {% endif %}
        </span>
    </div>

    <!-- Основная информация -->
    <div class="material-content">
        <!-- Левая колонка - информация -->
        <div class="card-modern">
            <div class="card-modern-header">
                <h2 class="card-modern-title">📋 Информация о материале</h2>
            </div>

            <div class="card-modern-body">
                <div class="detail-row">
                    <span class="detail-label">🏷️ Категория:</span>
                    <span class="detail-value">{{ material.category.name }}</span>
                </div>

                <div class="detail-row">
                    <span class="detail-label">💰 Цена:</span>
                    <span class="detail-value">{{ material.price }} ₽</span>
                </div>

                <div class="detail-row">
                    <span class="detail-label">📊 Баланс на складе:</span>
                    <span class="detail-value">{{ material.balance }} шт.</span>
                </div>

                <div class="detail-row">
                    <span class="detail-label">🔒 Зарезервировано:</span>
                    <span class="detail-value">{{ material.reserved }} шт.</span>
                </div>

                <div class="detail-row">
                    <span class="detail-label">✅ Доступно:</span>
                    <span class="detail-value" style="color: {% if material.availability_status == 'green' %}#16a34a{% elif material.availability_status == 'yellow' %}#d97706{% else %}#dc2626{% endif %}; font-weight: 600;">
                        {{ material.available }} шт.
                    </span>
                </div>

                <div class="detail-row">
                    <span class="detail-label">⚠️ Нехватка:</span>
                    <span class="detail-value" style="color: {% if material.lack > 0 %}#dc2626{% else %}#16a34a{% endif %}; font-weight: 600;">
                        {{ material.lack }} шт.
                    </span>
                </div>

                <div class="detail-row">
                    <span class="detail-label">🏢 Поставщик:</span>
                    <span class="detail-value">
                        {% if material.supplier %}
                            {{ material.supplier.name }}
                            {% if material.supplier.phone %}
                                <br><small style="color: #6b7280;">📞 {{ material.supplier.phone }}</small>
                            {% endif %}
                        {% else %}
                            <span style="color: #9ca3af;">Не указан</span>
                        {% endif %}
                    </span>
                </div>

                {% if material.description %}
                <div class="detail-row">
                    <span class="detail-label">📝 Описание:</span>
                    <span class="detail-value">{{ material.description }}</span>
                </div>
                {% endif %}
            </div>

            <!-- Кнопки действий -->
            <div class="card-actions">
                {% if user.groups.all.0.name == 'Отдел МТО' or user.is_superuser %}
                <button type="button" class="btn-modern btn-danger-modern" data-bs-toggle="modal" data-bs-target="#writeOffModal">
                    <i class="bi bi-arrow-up-circle"></i>
                    Списать материалы
                </button>

                <button type="button" class="btn-modern btn-primary-gradient" data-bs-toggle="modal" data-bs-target="#receiptModal">
                    <i class="bi bi-arrow-down-circle"></i>
                    Поступление материалов
                </button>

                <a href="{% url 'mebel:material_edit' material.id %}" class="btn-modern btn-outline-modern">
                    <i class="bi bi-pencil-square"></i>
                    Редактировать
                </a>
                {% endif %}
            </div>
        </div>

        <!-- Правая колонка - изображение -->
        <div class="card-modern">
            <div class="card-modern-header">
                <h2 class="card-modern-title">🖼️ Изображение</h2>
            </div>

            <div class="image-container">
                <img src="{% if material.image %}{{ material.image.url }}{% else %}{% static 'img/no_image.png' %}{% endif %}"
                     alt="{{ material.name }}"
                     class="material-image">
            </div>
        </div>
    </div>

    <!-- История операций -->
    <div class="card-modern">
        <div class="card-modern-header">
            <h2 class="card-modern-title">📊 История операций</h2>
        </div>

        <div class="card-modern-body">
            {% if operations %}
            <div class="table-responsive">
                <table class="operations-table">
                    <thead>
                        <tr>
                            <th>📅 Дата</th>
                            <th>🔧 Тип операции</th>
                            <th>📦 Количество</th>
                            <th>📝 Примечание</th>
                            <th>👤 Пользователь</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for op in operations %}
                        <tr>
                            <td>{{ op.created|date:"d.m.Y H:i" }}</td>
                            <td>
                                <span class="badge {% if op.operation_type == 'receipt' %}bg-success{% else %}bg-danger{% endif %}">
                                    {{ op.get_operation_type_display }}
                                </span>
                            </td>
                            <td>{{ op.quantity }} шт.</td>
                            <td>{{ op.notes|default:"-" }}</td>
                            <td>{{ op.user.username|default:"Система" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-4">
                <p style="color: #6b7280; font-size: 1.1rem;">📭 Операций пока нет</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Кнопка возврата -->
    <div class="card-actions" style="justify-content: flex-start; padding: 0; margin-top: 20px;">
        <a href="{% url 'mebel:material_list' %}" class="btn-modern btn-outline-modern">
            <i class="bi bi-arrow-left"></i>
            Вернуться к списку материалов
        </a>
    </div>
</div>

<!-- Модальные окна (остаются без изменений) -->
<div class="modal fade" id="writeOffModal" tabindex="-1" aria-labelledby="writeOffModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="writeOffModalLabel">
                    <i class="bi bi-arrow-up-circle me-2"></i>
                    Списание материала: {{ material.name }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                    <p class="mt-2">Загрузка формы...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="receiptModal" tabindex="-1" aria-labelledby="receiptModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="receiptModalLabel">
                    <i class="bi bi-arrow-down-circle me-2"></i>
                    Поступление материала: {{ material.name }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                    <p class="mt-2">Загрузка формы...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block domready %}
<script>
// Для поступления
$('#receiptModal').on('show.bs.modal', function (event) {
    var modal = $(this);
    $.ajax({
        url: "{% url 'mebel:material_receipt' material.id %}",
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            if (response.html) {
                modal.find('.modal-content').html(response.html);

                // Вешаем обработчик на форму
                modal.find('form').on('submit', function(e) {
                    e.preventDefault();
                    var form = $(this);

                    $.ajax({
                        type: 'POST',
                        url: form.attr('action'),
                        data: form.serialize(),
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        success: function(data) {
                            if (data.success) {
                                // Показываем сообщение об успехе
                                showAlert('success', data.message);
                                // Закрываем модальное окно
                                modal.modal('hide');
                                // Обновляем данные на странице (опционально)
                                setTimeout(function() {
                                    location.reload();
                                }, 1000);
                            } else {
                                // Показываем ошибки валидации
                                showFormErrors(form, data.errors);
                            }
                        },
                        error: function() {
                            alert('Ошибка при отправке формы');
                        }
                    });
                });
            }
        },
        error: function() {
            modal.find('.modal-content').html(
                '<div class="modal-header"><h5 class="modal-title">Ошибка</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>' +
                '<div class="modal-body"><p>Не удалось загрузить форму поступления.</p></div>'
            );
        }
    });
});

// Для списания - ТАКЖЕ ИСПРАВИТЬ
$('#writeOffModal').on('show.bs.modal', function (event) {
    var modal = $(this);
    $.ajax({
        url: "{% url 'mebel:material_write_off' material.id %}",
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            if (response.html) {
                modal.find('.modal-content').html(response.html);

                // Вешаем обработчик на форму
                modal.find('form').on('submit', function(e) {
                    e.preventDefault();
                    var form = $(this);

                    $.ajax({
                        type: 'POST',
                        url: form.attr('action'),
                        data: form.serialize(),
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        success: function(data) {
                            if (data.success) {
                                // Показываем сообщение об успехе
                                showAlert('success', data.message);
                                // Закрываем модальное окно
                                modal.modal('hide');
                                // Обновляем данные на странице (опционально)
                                setTimeout(function() {
                                    location.reload();
                                }, 1000);
                            } else {
                                // Показываем ошибки валидации
                                showFormErrors(form, data.errors);
                            }
                        },
                        error: function() {
                            alert('Ошибка при отправке формы');
                        }
                    });
                });
            }
        },
        error: function() {
            modal.find('.modal-content').html(
                '<div class="modal-header"><h5 class="modal-title">Ошибка</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>' +
                '<div class="modal-body"><p>Не удалось загрузить форму списания.</p></div>'
            );
        }
    });
});

// Функция для показа сообщений
function showAlert(type, message) {
    // Создаем или находим контейнер для алертов
    var alertContainer = $('.alert-container');
    if (alertContainer.length === 0) {
        alertContainer = $('<div class="alert-container" style="position: fixed; top: 20px; right: 20px; z-index: 1060;"></div>');
        $('body').append(alertContainer);
    }

    var alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    var alertHtml = '<div class="alert ' + alertClass + ' alert-dismissible fade show" role="alert">' +
                    message +
                    '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                    '</div>';

    alertContainer.append(alertHtml);

    // Автоматически скрываем через 5 секунд
    setTimeout(function() {
        alertContainer.find('.alert').first().alert('close');
    }, 5000);
}

// Функция для показа ошибок формы
function showFormErrors(form, errors) {
    // Очищаем предыдущие ошибки
    form.find('.error-text').remove();
    form.find('.is-invalid').removeClass('is-invalid');

    // Показываем новые ошибки
    $.each(errors, function(field, messages) {
        var fieldInput = form.find('[name="' + field + '"]');
        fieldInput.addClass('is-invalid');
        fieldInput.after('<div class="error-text text-danger small">' + messages.join(', ') + '</div>');
    });
}
</script>
{% endblock %}


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\mebel\templates\mebel\material\edit.html
============================================================

{% extends "mebel/base.html" %}
{% load static %}

{% block title %}Редактировать {{ material.name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>Редактировать материал: {{ material.name }}</h1>

    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title">Основная информация</h5>
            </div>
            <div class="card-body">
                {% include "includes/form_errors.html" with form=form %}

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">{{ form.name.label }}</label>
                            {{ form.name }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">{{ form.category.label }}</label>
                            {{ form.category }}
                        </div>
                    </div>
                </div>


                <!-- БЛОК ПОСТАВЩИКА С КНОПКОЙ ДОБАВЛЕНИЯ -->
                <div class="row">
                    <div class="col-md-10">
                        <div class="mb-3">
                            <label class="form-label">{{ form.supplier.label }}</label>
                            {{ form.supplier }}
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="mb-3">
                            <label class="form-label">&nbsp;</label>
                            <button type="button" class="btn btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#supplierModal">
                                + Добавить
                            </button>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">{{ form.price.label }}</label>
                            {{ form.price }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">{{ form.image.label }}</label>
                            {{ form.image }}
                            {% if form.instance.image %}
                            <div class="mt-2">
                                <small>Текущее изображение:</small><br>
                                <img src="{{ form.instance.image.url }}" alt="{{ form.instance.name }}" style="max-height: 100px;">
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">{{ form.description.label }}</label>
                    {{ form.description }}
                </div>
            </div>
        </div>

        <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">
                Сохранить изменения
            </button>
            <a href="{% url 'mebel:material_detail' material.id material.slug %}" class="btn btn-secondary">
                Отмена
            </a>
        </div>
    </form>
</div>

<!-- МОДАЛЬНОЕ ОКНО ДЛЯ СОЗДАНИЯ ПОСТАВЩИКА -->
<div class="modal fade" id="supplierModal" tabindex="-1" aria-labelledby="supplierModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" id="supplier-modal-content">
            <!-- Содержимое будет загружено через AJAX -->
        </div>
    </div>
</div>

<style>
    .form-control, .form-select {
        border-radius: 0.375rem;
        border: 1px solid #ced4da;
        padding: 0.375rem 0.75rem;
    }

    .form-control:focus, .form-select:focus {
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
</style>
{% endblock %}

{% block domready %}
<script>
// Загрузка формы поставщика в модальное окно
$('#supplierModal').on('show.bs.modal', function (event) {
    var modal = $(this);
    $.ajax({
        url: "{% url 'mebel:supplier_create_modal' %}",
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            modal.find('.modal-content').html(response.html);
        },
        error: function() {
            modal.find('.modal-content').html(
                '<div class="modal-header"><h5 class="modal-title">Ошибка</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>' +
                '<div class="modal-body"><p>Не удалось загрузить форму создания поставщика.</p></div>'
            );
        }
    });
});

// Очистка модального окна при закрытии
$('#supplierModal').on('hidden.bs.modal', function () {
    $(this).find('.modal-content').html('');
});

// Фокус на поле поставщика после закрытия модалки
$('#supplierModal').on('hidden.bs.modal', function () {
    setTimeout(function() {
        $('#supplier-select').focus();
    }, 100);
});
</script>
{% endblock %}


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\mebel\templates\mebel\material\list.html
============================================================

{% extends "mebel/base.html" %}
{% load static %}

{% block title %}Список материалов{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
/* Основные стили контейнера */
.dashboard-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}

.page-header {
    text-align: center;
    margin-bottom: 30px;
}

.page-header h1 {
    color: #2c3e50;
    font-weight: 700;
    font-size: 2.5rem;
    margin-bottom: 10px;
}

.page-header p {
    color: #6b7280;
    font-size: 1.2rem;
}

/* Стили для карточек */
.card-modern {
    background: white;
    border-radius: 16px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.08);
    border: none;
    overflow: hidden;
    margin-bottom: 25px;
}

.card-modern-header {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    padding: 20px 25px;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.card-modern-title {
    color: #2c3e50;
    font-weight: 600;
    margin: 0;
    font-size: 1.3rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

/* Сетка для графика и таблицы */
.dashboard-grid {
    display: grid;
    grid-template-columns: 400px 1fr;
    gap: 25px;
    margin-bottom: 30px;
}

/* Стили для графика */
.chart-card {
    height: fit-content;
}

.chart-container-improved {
    position: relative;
    height: 320px;
    width: 100%;
    padding: 15px;
}

/* Стили для таблицы */
.table-card {
    min-height: 500px;
}

.table-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.btn-modern {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
}

.btn-modern:hover {
    background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    color: white;
    text-decoration: none;
}

/* Стили для таблицы */
.material-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 12px;
    overflow: hidden;
    font-size: 0.85rem;
}

.material-table thead {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.material-table th {
    color: white;
    font-weight: 600;
    padding: 15px 12px;
    text-align: left;
    border: none;
    font-size: 0.9rem;
    white-space: nowrap;
    position: relative;
}

.material-table th a.sort-link {
    color: white !important;
    text-decoration: none;
    display: block;
    padding: 2px 0;
    transition: opacity 0.3s;
}

.material-table th a.sort-link:hover {
    opacity: 0.8;
    text-decoration: underline;
}

.material-table tbody tr {
    border-bottom: 1px solid #f1f5f9;
    transition: all 0.3s;
}

.material-table tbody tr:hover {
    background-color: #f8fafc;
    transform: translateX(5px);
}

.material-table tbody tr.material-row-zero-available {
    background-color: #fef2f2;
    border-left: 4px solid #ef4444;
}

.material-table td {
    padding: 12px;
    vertical-align: middle;
    border: none;
}

/* Стили для статусов доступности */
.availability-badge {
    font-weight: bold;
    padding: 6px 10px;
    border-radius: 20px;
    font-size: 0.75rem;
    white-space: nowrap;
    display: inline-block;
    text-align: center;
    min-width: 60px;
}

.availability-green {
    background: #d1fae5;
    color: #065f46;
    border: 1px solid #a7f3d0;
}

.availability-yellow {
    background: #fef3c7;
    color: #92400e;
    border: 1px solid #fcd34d;
}

.availability-red {
    background: #fee2e2;
    color: #991b1b;
    border: 1px solid #fca5a5;
}

/* Стили для цен */
.price-cell {
    font-family: 'Courier New', monospace;
    font-weight: 600;
    text-align: right;
    color: #2c3e50;
    font-size: 0.9rem;
}

/* Стили для названия материала */
.material-name {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 4px;
}

.supplier-name {
    font-size: 0.8rem;
    color: #6b7280;
}

/* Стили для кнопок действий */
.action-buttons {
    display: flex !important;
    gap: 5px !important;
    flex-wrap: nowrap !important;
    justify-content: center !important;
}

.action-btn {
    padding: 6px 8px !important;
    border-radius: 6px !important;
    font-size: 0.75rem !important;
    min-width: 30px !important;
    height: 28px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    transition: all 0.3s !important;
}

.action-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 3px 8px rgba(0,0,0,0.15);
}

/* Стили для информации о материале */
.material-info-modern {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    padding: 15px;
    border-radius: 12px;
    margin-bottom: 15px;
    border: 1px solid #bae6fd;
}

.material-info-modern h6 {
    color: #0369a1;
    margin-bottom: 10px;
    font-weight: 600;
}

/* Стили для категорий */
.categories-modern {
    margin-bottom: 20px;
}

.category-badge {
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
    text-decoration: none;
    transition: all 0.3s;
    border: 2px solid transparent;
}

.category-badge.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.category-badge:not(.active) {
    background: white;
    color: #64748b;
    border-color: #e2e8f0;
}

.category-badge:not(.active):hover {
    border-color: #667eea;
    color: #667eea;
}

/* Анимации */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.card-modern {
    animation: fadeInUp 0.6s ease-out;
}

.dashboard-grid > *:nth-child(1) { animation-delay: 0.1s; }
.dashboard-grid > *:nth-child(2) { animation-delay: 0.2s; }

/* Адаптивность */
@media (max-width: 1200px) {
    .dashboard-grid {
        grid-template-columns: 1fr;
        gap: 20px;
    }

    .chart-card {
        order: 2;
    }

    .table-card {
        order: 1;
    }
}

@media (max-width: 992px) {
    .dashboard-container {
        padding: 15px;
    }

    .material-table th:nth-child(2), /* Поставщик */
    .material-table td:nth-child(2) {
        width: 10% !important;  /* Уменьшаем ширину столбца поставщик */
        display: none;
    }


    .material-table th:nth-child(1), /* Поставщик */
    .material-table td:nth-child(1) {
        width: 10% !important;  /* Уменьшаем ширину столбца поставщик */
        display: none;
    }
}

@media (max-width: 768px) {
    .dashboard-container {
        padding: 10px;
    }

    .page-header h1 {
        font-size: 2rem;
    }

    .card-modern-header {
        padding: 15px 20px;
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
    }

    .material-table {
        font-size: 0.75rem;
    }

    .material-table th,
    .material-table td {
        padding: 10px 8px;
    }

    .material-table th:nth-child(3), /* Цена */
    .material-table td:nth-child(3) {
        display: none;
    }

    .chart-container-improved {
        height: 250px;
    }
}

@media (max-width: 576px) {
    .page-header h1 {
        font-size: 1.8rem;
    }

    .page-header p {
        font-size: 1rem;
    }

    .material-table th:nth-child(4), /* Баланс */
    .material-table td:nth-child(4) {
        display: none;
    }

    .btn-modern {
        width: 100%;
        justify-content: center;
    }

    .action-buttons {
        flex-direction: column !important;
        gap: 3px !important;
    }
}

/* Стили для пустого состояния */
.no-data {
    text-align: center;
    padding: 60px 20px;
    color: #9ca3af;
}

.no-data p {
    margin: 0;
    font-size: 1.1rem;
}

/* Улучшенные стили для графика */
.chart-improved {
    border-radius: 12px;
    padding: 10px;
}

/* Стили для выбранного материала */
.material-selected {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%) !important;
    border-left: 4px solid #3b82f6 !important;
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Заголовок страницы -->
    <div class="page-header">
        <h1>📦 Управление материалами</h1>
        <p>Отслеживание наличия и статистика материалов</p>
    </div>

    <!-- Основная сетка: график + таблица -->
    <div class="dashboard-grid">
        <!-- График наличия материалов -->
        <div class="card-modern chart-card">
            <div class="card-modern-header">
                <h5 class="card-modern-title">
                    📊 Статистика материалов
                </h5>
            </div>
            <div class="card-modern-body">
                <!-- Информация о материале -->
                <div class="material-info-modern" id="materialInfo">
                    <h6 id="materialName">Выберите материал для просмотра графика</h6>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <small>Баланс: <strong id="currentBalance">-</strong></small>
                        </div>
                        <div>
                            <small>Доступно: <strong id="currentAvailable">-</strong></small>
                        </div>
                    </div>
                </div>

                <!-- Контейнер для графика -->
                <div class="chart-container-improved">
                    <canvas id="materialChart" class="chart-improved"></canvas>
                </div>
            </div>
        </div>

        <!-- Таблица материалов -->
        <div class="card-modern table-card">
            <div class="card-modern-header">
                <h5 class="card-modern-title">
                    📋 Список материалов
                </h5>
                {% if user.groups.all.0.name == 'Отдел МТО' or user.is_superuser %}
                <a href="{% url 'mebel:material_create' %}" class="btn-modern">
                    <i class="bi bi-plus-circle"></i>
                    Добавить материал
                </a>
                {% endif %}
            </div>
            <div class="card-modern-body">
                <!-- Категории -->
                <div class="categories-modern">
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <a href="{% url 'mebel:material_list' %}"
                           class="category-badge {% if not category %}active{% endif %}">
                            Все
                        </a>
                        {% for c in categories %}
                        <a href="{{ c.get_absolute_url }}"
                           class="category-badge {% if category.slug == c.slug %}active{% endif %}">
                            {{ c.name }}
                        </a>
                        {% endfor %}
                    </div>
                </div>

                {% if materials %}
                <div class="table-responsive">
                    <table class="material-table">
                        <thead>
                            <tr>
                                <th>
                                    <a href="?sort=name&order={% if current_sort == 'name' and current_order == 'asc' %}desc{% else %}asc{% endif %}{% if category %}&category={{ category.slug }}{% endif %}" class="sort-link">
                                        Название
                                        {% if current_sort == 'name' %}
                                            {% if current_order == 'asc' %}↑{% else %}↓{% endif %}
                                        {% endif %}
                                    </a>
                                </th>
                                <th>
                                    <a href="?sort=supplier&order={% if current_sort == 'supplier' and current_order == 'asc' %}desc{% else %}asc{% endif %}{% if category %}&category={{ category.slug }}{% endif %}" class="sort-link">
                                        Поставщик
                                        {% if current_sort == 'supplier' %}
                                            {% if current_order == 'asc' %}↑{% else %}↓{% endif %}
                                        {% endif %}
                                    </a>
                                </th>
                                <th>
                                    <a href="?sort=price&order={% if current_sort == 'price' and current_order == 'asc' %}desc{% else %}asc{% endif %}{% if category %}&category={{ category.slug }}{% endif %}" class="sort-link">
                                        Цена
                                        {% if current_sort == 'price' %}
                                            {% if current_order == 'asc' %}↑{% else %}↓{% endif %}
                                        {% endif %}
                                    </a>
                                </th>
                                <th>
                                    <a href="?sort=balance&order={% if current_sort == 'balance' and current_order == 'asc' %}desc{% else %}asc{% endif %}{% if category %}&category={{ category.slug }}{% endif %}" class="sort-link">
                                        Баланс
                                        {% if current_sort == 'balance' %}
                                            {% if current_order == 'asc' %}↑{% else %}↓{% endif %}
                                        {% endif %}
                                    </a>
                                </th>
                                <th>
                                    <a href="?sort=available&order={% if current_sort == 'available' and current_order == 'asc' %}desc{% else %}asc{% endif %}{% if category %}&category={{ category.slug }}{% endif %}" class="sort-link">
                                        Доступно
                                        {% if current_sort == 'available' %}
                                            {% if current_order == 'asc' %}↑{% else %}↓{% endif %}
                                        {% endif %}
                                    </a>
                                </th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for material in materials %}
                            <tr data-material-id="{{ material.id }}"
                                class="{% if material.available == 0 %}material-row-zero-available{% endif %}"
                                onclick="selectMaterialForChart({{ material.id }}, '{{ material.name|escapejs }}')">
                                <td>
                                    <div class="material-name">{{ material.name|truncatechars:25 }}</div>
                                    {% if material.supplier %}
                                    <div class="supplier-name">{{ material.supplier.name|truncatechars:20 }}</div>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if material.supplier %}
                                        {{ material.supplier.name|truncatechars:20 }}
                                    {% else %}
                                        <span style="color: #9ca3af; font-size: 0.8rem;">Не указан</span>
                                    {% endif %}
                                </td>
                                <td class="price-cell">{{ material.price }} ₽</td>
                                <td>{{ material.balance }}</td>
                                <td>
                                    {% if material.availability_status == 'green' %}
                                        <span class="availability-badge availability-green">{{ material.available }}</span>
                                    {% elif material.availability_status == 'yellow' %}
                                        <span class="availability-badge availability-yellow">{{ material.available }}</span>
                                    {% else %}
                                        <span class="availability-badge availability-red">{{ material.available }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <a href="{{ material.get_absolute_url }}"
                                           class="action-btn"
                                           title="Подробности"
                                           style="background: #10b981; color: white; text-decoration: none;">
                                            👁️
                                        </a>
                                        {% if user.groups.all.0.name == 'Отдел МТО' or user.is_superuser %}
                                        <a href="{% url 'mebel:material_edit' material.id %}"
                                           class="action-btn"
                                           title="Редактировать"
                                           style="background: #f59e0b; color: white; text-decoration: none;">
                                            ✏️
                                        </a>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Пагинация -->
                <div style="margin-top: 25px;">
                    {% include "pagination.html" %}
                </div>
                {% else %}
                <div class="no-data">
                    <p>📭 Материалы не найдены</p>
                    {% if user.groups.all.0.name == 'Отдел МТО' or user.is_superuser %}
                    <a href="{% url 'mebel:material_create' %}" class="btn-modern" style="margin-top: 15px;">
                        <i class="bi bi-plus-circle"></i>
                        Добавить первый материал
                    </a>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let materialChart = null;
    let currentMaterialId = null;
    let selectedRow = null;

    // Функция выбора материала для графика
    window.selectMaterialForChart = function(materialId, materialName) {
        // Убираем выделение с предыдущей строки
        if (selectedRow) {
            selectedRow.classList.remove('material-selected');
        }

        // Выделяем текущую строку
        selectedRow = document.querySelector(`tr[data-material-id="${materialId}"]`);
        if (selectedRow) {
            selectedRow.classList.add('material-selected');
        }

        // Загружаем график
        loadMaterialChart(materialId, materialName);
    };

    // Загрузка данных графика
    function loadMaterialChart(materialId, materialName) {
        showLoading(true);

        // Обновляем информацию о материале
        document.getElementById('materialName').textContent = materialName;
        document.getElementById('currentBalance').textContent = 'загрузка...';
        document.getElementById('currentAvailable').textContent = 'загрузка...';

        fetch(`{% url 'mebel:material_chart_data' 0 %}`.replace('0', materialId))
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                currentMaterialId = materialId;

                // Обновляем информацию о материале
                document.getElementById('currentBalance').textContent = data.current_balance;
                document.getElementById('currentAvailable').textContent = data.current_available;

                // Форматируем даты
                const formattedDates = data.dates.map(date => {
                    const d = new Date(date);
                    return d.toLocaleDateString('ru-RU', {
                        month: 'short',
                        day: 'numeric'
                    });
                });

                // Обновляем график
                updateChart(formattedDates, data.quantities, data.material_name);
            })
            .catch(error => {
                console.error('Error loading chart data:', error);
                document.getElementById('materialName').textContent = 'Ошибка загрузки данных';
                document.getElementById('currentBalance').textContent = '-';
                document.getElementById('currentAvailable').textContent = '-';
            })
            .finally(() => {
                showLoading(false);
            });
    }

    // Функция показа/скрытия загрузки
    function showLoading(show) {
        // Можно добавить индикатор загрузки если нужно
    }

    // Обновление графика
    function updateChart(dates, quantities, materialName) {
        const ctx = document.getElementById('materialChart').getContext('2d');

        if (materialChart) {
            materialChart.destroy();
        }

        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);

        materialChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [{
                    label: `Наличие: ${materialName}`,
                    data: quantities,
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#10b981',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            color: '#2c3e50',
                            font: {
                                size: 12,
                                family: "'Inter', sans-serif"
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(44, 62, 80, 0.9)',
                        titleFont: {
                            family: "'Inter', sans-serif"
                        },
                        bodyFont: {
                            family: "'Inter', sans-serif"
                        },
                        padding: 12,
                        cornerRadius: 8
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grace: '5%',
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        },
                        ticks: {
                            color: '#64748b'
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        },
                        ticks: {
                            color: '#64748b'
                        }
                    }
                },
                animation: {
                    duration: 1000,
                    easing: 'easeOutQuart'
                }
            }
        });

        setTimeout(() => {
            if (materialChart) {
                materialChart.resize();
            }
        }, 100);
    }

    // Автоматически выбираем первый материал при загрузке страницы
    const firstMaterialRow = document.querySelector('tr[data-material-id]');
    if (firstMaterialRow) {
        const materialId = firstMaterialRow.dataset.materialId;
        const materialName = firstMaterialRow.querySelector('.material-name').textContent;

        setTimeout(() => {
            selectMaterialForChart(materialId, materialName);
        }, 500);
    }
});
</script>
{% endblock %}


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\mebel\templates\mebel\material\pagination.html
============================================================

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>

</body>
</html>


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\mebel\templates\mebel\material\receipt_modal.html
============================================================

<div class="modal-header">
    <h5 class="modal-title">Поступление материала: {{ material.name }}</h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<form method="post" action="{% url 'mebel:material_receipt' material.id %}">
    <div class="modal-body">
        {% csrf_token %}
        {% include "includes/form_errors.html" %}
        <div class="mb-3">
            <p><strong>Текущий баланс:</strong> {{ material.balance }}</p>
        </div>
        {{ form.as_p }}
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
        <button type="submit" class="btn btn-success">Подтвердить поступление</button>
    </div>
</form>


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\mebel\templates\mebel\material\write_off_modal.html
============================================================

<div class="modal-header">
    <h5 class="modal-title">Списание материала: {{ material.name }}</h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<form method="post" action="{% url 'mebel:material_write_off' material.id %}" onsubmit="return validateWriteOffForm(this)">
    <div class="modal-body">
        {% csrf_token %}
        {% include "includes/form_errors.html" %}
        <div class="mb-3">
            <p><strong>Текущий баланс:</strong> {{ material.balance }}</p>
            <p><strong>Максимум можно списать:</strong> {{ material.balance }}</p>
        </div>
        {{ form.as_p }}
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
        <button type="submit" class="btn btn-danger">Подтвердить списание</button>
    </div>
</form>

<script>
function validateWriteOffForm(form) {
    const quantityInput = form.querySelector('input[name="quantity"]');
    const maxQuantity = parseInt(quantityInput.getAttribute('max'));
    const quantity = parseInt(quantityInput.value);

    if (quantity > maxQuantity) {
        alert(`Нельзя списать ${quantity}, на складе только ${maxQuantity}`);
        quantityInput.focus();
        return false;
    }

    return true;
}
</script>


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\mebel\templates\mebel\material\write_off_modal_content.html
============================================================

<!-- mebel/material/write_off_modal_content.html -->
<div class="modal-header">
    <h5 class="modal-title">Списание материала: {{ material.name }}</h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<form method="post" action="{% url 'mebel:material_write_off' material.id %}">
    <div class="modal-body">
        {% csrf_token %}
        {% include "includes/form_errors.html" %}
        <div class="mb-3">
            <p><strong>Текущий баланс:</strong> {{ material.balance }}</p>
        </div>
        {{ form.as_p }}
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
        <button type="submit" class="btn btn-danger">Подтвердить списание</button>
    </div>
</form>


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\mebel\templates\mebel\operations\operations_list.html
============================================================

{% extends "mebel/base.html" %}
{% load static %}

{% block title %}Операции по материалам{% endblock %}

{% block extra_css %}
<style>
/* Основные стили контейнера */
.dashboard-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}

.page-header {
    text-align: center;
    margin-bottom: 30px;
}

.page-header h1 {
    color: #2c3e50;
    font-weight: 700;
    font-size: 2.5rem;
    margin-bottom: 10px;
}

.page-header p {
    color: #6b7280;
    font-size: 1.2rem;
}

/* Стили для карточек */
.card-modern {
    background: white;
    border-radius: 16px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.08);
    border: none;
    overflow: hidden;
    margin-bottom: 25px;
}

.card-modern-header {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    padding: 20px 25px;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.card-modern-title {
    color: #2c3e50;
    font-weight: 600;
    margin: 0;
    font-size: 1.3rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

/* Стили для таблицы */
.operations-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 12px;
    overflow: hidden;
    font-size: 0.85rem;
}

.operations-table thead {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.operations-table th {
    color: white;
    font-weight: 600;
    padding: 15px 12px;
    text-align: left;
    border: none;
    font-size: 0.9rem;
    white-space: nowrap;
}

.operations-table tbody tr {
    border-bottom: 1px solid #f1f5f9;
    transition: all 0.3s;
    cursor: pointer;
}

.operations-table tbody tr:hover {
    background-color: #f8fafc;
    transform: translateX(5px);
}

.operations-table td {
    padding: 12px;
    vertical-align: middle;
    border: none;
}

/* Стили для статусов операций */
.operation-badge {
    font-weight: bold;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    white-space: nowrap;
    display: inline-block;
    text-align: center;
    min-width: 100px;
}

.receipt-badge {
    background: #d1fae5;
    color: #065f46;
    border: 1px solid #a7f3d0;
}

.writeoff-badge {
    background: #fee2e2;
    color: #991b1b;
    border: 1px solid #fca5a5;
}

/* Стили для количеств */
.quantity-cell {
    font-family: 'Courier New', monospace;
    font-weight: 600;
    text-align: right;
    color: #2c3e50;
    font-size: 0.9rem;
}

/* Стили для дат */
.date-cell {
    white-space: nowrap;
    font-size: 0.8rem;
    color: #6b7280;
}

/* Стили для названия материала */
.material-name {
    font-weight: 600;
    color: #2c3e50;
}

/* Стили для кнопок действий */
.action-buttons {
    display: flex !important;
    gap: 5px !important;
    flex-wrap: nowrap !important;
    justify-content: center !important;
}

.action-btn {
    padding: 6px 8px !important;
    border-radius: 6px !important;
    font-size: 0.75rem !important;
    min-width: 30px !important;
    height: 28px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    transition: all 0.3s !important;
    text-decoration: none !important;
    border: none !important;
}

.action-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 3px 8px rgba(0,0,0,0.15);
}

/* Стили для фильтров */
.filters-modern {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 20px;
}

.filter-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    align-items: end;
}

.filter-group {
    display: flex;
    flex-direction: column;
}

.filter-label {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 8px;
    font-size: 0.9rem;
}

.filter-select {
    padding: 10px 12px;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    font-size: 0.9rem;
    outline: none;
    transition: all 0.3s;
    background: white;
}

.filter-select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.filter-input {
    padding: 10px 12px;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    font-size: 0.9rem;
    outline: none;
    transition: all 0.3s;
}

.filter-input:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

/* Кнопки */
.btn-modern {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
}

.btn-modern:hover {
    background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    color: white;
    text-decoration: none;
}

.btn-warning-modern {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
}

.btn-warning-modern:hover {
    background: linear-gradient(135deg, #e0900a 0%, #b45309 100%);
}

/* Анимации */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.card-modern {
    animation: fadeInUp 0.6s ease-out;
}

/* Стили для пустого состояния */
.no-data {
    text-align: center;
    padding: 60px 20px;
    color: #9ca3af;
}

.no-data p {
    margin: 0;
    font-size: 1.1rem;
}

/* Бейдж количества */
.count-badge {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.9rem;
}

/* Адаптивность */
@media (max-width: 768px) {
    .dashboard-container {
        padding: 10px;
    }

    .page-header h1 {
        font-size: 2rem;
    }

    .filter-grid {
        grid-template-columns: 1fr;
    }

    .operations-table {
        font-size: 0.75rem;
    }

    .operations-table th,
    .operations-table td {
        padding: 10px 8px;
    }

    .operations-table th:nth-child(5), /* Пользователь */
    .operations-table td:nth-child(5) {
        display: none;
    }
}

@media (max-width: 576px) {
    .page-header h1 {
        font-size: 1.8rem;
    }

    .operations-table th:nth-child(6), /* Примечание */
    .operations-table td:nth-child(6) {
        display: none;
    }

    .action-buttons {
        flex-direction: column !important;
        gap: 3px !important;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Заголовок страницы -->
    <div class="page-header">
        <h1>📊 Операции по материалам</h1>
        <p>История поступлений и списаний материалов</p>
    </div>

    <!-- Карточка с фильтрами -->
    <div class="card-modern">
        <div class="card-modern-header">
            <h5 class="card-modern-title">
                🔍 Фильтры операций
            </h5>
        </div>
        <div class="card-modern-body">
            <form method="get" class="filters-modern">
                <div class="filter-grid">
                    <div class="filter-group">
                        <label class="filter-label">Тип операции</label>
                        <select name="type" class="filter-select">
                            <option value="">Все операции</option>
                            <option value="receipt" {% if operation_type == 'receipt' %}selected{% endif %}>Поступления</option>
                            <option value="write_off" {% if operation_type == 'write_off' %}selected{% endif %}>Списания</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Материал</label>
                        <select name="material" class="filter-select">
                            <option value="">Все материалы</option>
                            {% for material in materials %}
                            <option value="{{ material.id }}" {% if selected_material == material.id|stringformat:"i" %}selected{% endif %}>
                                {{ material.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">С даты</label>
                        <input type="date" name="date_from" class="filter-input" value="{{ date_from }}">
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">По дату</label>
                        <input type="date" name="date_to" class="filter-input" value="{{ date_to }}">
                    </div>

                    <div class="filter-group" style="grid-column: 1 / -1;">
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button type="submit" class="btn-modern">
                                🔍 Применить фильтры
                            </button>
                            <a href="{% url 'mebel:operations_list' %}" class="btn-modern" style="background: #6b7280;">
                                🗑️ Сбросить
                            </a>
                        </div>
                    </div>
                </div>
            </form>

            <!-- Кнопка пересчета балансов -->
            <div style="display: flex; align-items: center; gap: 15px; margin-top: 15px; padding: 15px; background: #fffbeb; border-radius: 8px; border: 1px solid #fcd34d;">
                <a href="{% url 'mebel:recalculate_balances' %}" class="btn-modern btn-warning-modern">
                    🔄 Пересчитать все балансы
                </a>
                <small style="color: #92400e; font-size: 0.8rem;">
                    Используйте если балансы не совпадают с операциями
                </small>
            </div>
        </div>
    </div>

    <!-- Таблица операций -->
    <div class="card-modern">
        <div class="card-modern-header">
            <h5 class="card-modern-title">
                📋 Список операций
            </h5>
            <span class="count-badge">Всего: {{ page_obj.paginator.count }}</span>
        </div>
        <div class="card-modern-body">
            {% if page_obj %}
            <div class="table-responsive">
                <table class="operations-table">
                    <thead>
                        <tr>
                            <th>Дата</th>
                            <th>Тип</th>
                            <th>Материал</th>
                            <th>Количество</th>
                            <th>Пользователь</th>
                            <th>Примечание</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for operation in page_obj %}
                        <tr onclick="window.location='{% url 'mebel:operation_detail' operation.id %}';">
                            <td class="date-cell">{{ operation.created|date:"d.m.Y H:i" }}</td>
                            <td>
                                {% if operation.operation_type == 'receipt' %}
                                    <span class="operation-badge receipt-badge">📈 Поступление</span>
                                {% else %}
                                    <span class="operation-badge writeoff-badge">📉 Списание</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="material-name">{{ operation.material.name|truncatechars:25 }}</div>
                            </td>
                            <td class="quantity-cell">{{ operation.quantity }} шт.</td>
                            <td>{{ operation.user.get_full_name|default:operation.user.username }}</td>
                            <td>{{ operation.notes|default:"-"|truncatewords:3 }}</td>
                            <td>
                                <div class="action-buttons">
                                    <a href="{% url 'mebel:operation_detail' operation.id %}"
                                       class="action-btn"
                                       title="Подробнее"
                                       style="background: #10b981; color: white;">
                                        👁️
                                    </a>
                                    {% if operation.can_edit %}
                                    <a href="{% url 'mebel:operation_edit' operation.id %}"
                                       class="action-btn"
                                       title="Редактировать"
                                       style="background: #f59e0b; color: white;">
                                        ✏️
                                    </a>
                                    {% else %}
                                    <button class="action-btn"
                                            title="Редактирование недоступно"
                                            disabled
                                            style="background: #9ca3af; color: white;">
                                        ⏳
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Пагинация -->
            <div style="margin-top: 25px;">
                {% include 'pagination.html' %}
            </div>

            {% else %}
            <div class="no-data">
                <p>📭 Операции не найдены</p>
                <p style="font-size: 0.9rem; margin-top: 10px;">Попробуйте изменить параметры фильтров</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\mebel\templates\mebel\operations\operation_detail.html
============================================================

{% extends "mebel/base.html" %}
{% load static %}

{% block title %}Операция #{{ operation.id }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        {% if operation.operation_type == 'receipt' %}
                            📈 Поступление
                        {% else %}
                            📉 Списание
                        {% endif %}
                        #{{ operation.id }}
                    </h5>
                    <span class="badge {% if operation.can_edit %}bg-warning{% else %}bg-secondary{% endif %}">
                        {% if operation.can_edit %}Можно редактировать{% else %}Только просмотр{% endif %}
                    </span>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Основная информация</h6>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item">
                                    <strong>Материал:</strong>
                                    <a href="{{ operation.material.get_absolute_url }}">
                                        {{ operation.material.name }}
                                    </a>
                                </li>
                                <li class="list-group-item">
                                    <strong>Количество:</strong> {{ operation.quantity }} шт.
                                </li>
                                <li class="list-group-item">
                                    <strong>Дата операции:</strong> {{ operation.created|date:"d.m.Y H:i" }}
                                </li>
                                <li class="list-group-item">
                                    <strong>Пользователь:</strong> {{ operation.user.get_full_name|default:operation.user.username }}
                                </li>
                            </ul>
                        </div>
                        
                        <div class="col-md-6">
                            <h6>Детали</h6>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item">
                                    <strong>Тип операции:</strong>
                                    {% if operation.operation_type == 'receipt' %}
                                        <span class="badge bg-success">Поступление</span>
                                    {% else %}
                                        <span class="badge bg-danger">Списание</span>
                                    {% endif %}
                                </li>
                                <li class="list-group-item">
                                    <strong>Текущий баланс материала:</strong> {{ operation.material.balance }} шт.
                                </li>
                                <li class="list-group-item">
                                    <strong>Доступно:</strong> {{ operation.material.available }} шт.
                                </li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h6>Примечание</h6>
                        <div class="card">
                            <div class="card-body">
                                {{ operation.notes|default:"Примечание отсутствует"|linebreaks }}
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4 d-flex gap-2">
                        <a href="{% url 'mebel:operations_list' %}" class="btn btn-secondary">
                            ← Назад к списку
                        </a>
                        
                        {% if operation.can_edit %}
                        <a href="{% url 'mebel:operation_edit' operation.id %}" class="btn btn-warning">
                            ✏️ Редактировать
                        </a>
                        {% endif %}
                        
                        <a href="{{ operation.material.get_absolute_url }}" class="btn btn-primary">
                            👁️ К материалу
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\mebel\templates\mebel\operations\operation_edit.html
============================================================

{% extends "mebel/base.html" %}
{% load static %}

{% block title %}Редактирование операции #{{ operation.id }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        ✏️ Редактирование операции #{{ operation.id }}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning">
                        <strong>Внимание!</strong> Изменение операции повлияет на баланс материала.
                        Будет создана корректирующая операция.
                    </div>

                    <!-- Информация об операции -->
                    <div class="mb-4">
                        <h6>Информация об операции:</h6>
                        <ul class="list-group">
                            <li class="list-group-item">
                                <strong>Материал:</strong>
                                <a href="{{ operation.material.get_absolute_url }}">
                                    {{ operation.material.name }}
                                </a>
                            </li>
                            <li class="list-group-item">
                                <strong>Тип:</strong>
                                {% if operation.operation_type == 'receipt' %}
                                    <span class="badge bg-success">Поступление</span>
                                {% else %}
                                    <span class="badge bg-danger">Списание</span>
                                {% endif %}
                            </li>
                            <li class="list-group-item">
                                <strong>Текущее количество:</strong> {{ operation.quantity }} шт.
                            </li>
                            <li class="list-group-item">
                                <strong>Дата создания:</strong> {{ operation.created|date:"d.m.Y H:i" }}
                            </li>
                        </ul>
                    </div>
                    <!-- Добавьте этот блок после информации об операции -->
                    <div class="mb-3">
                        <h6>Текущее состояние:</h6>
                        <ul class="list-group">
                            <li class="list-group-item">
                                <strong>Текущий баланс материала:</strong> {{ material.balance }} шт.
                            </li>
                            <li class="list-group-item">
                                <strong>Исходное количество в операции:</strong> {{ operation.quantity }} шт.
                            </li>
                            {% if operation.operation_type == 'write_off' %}
                            <li class="list-group-item">
                                <strong>Максимально можно списать:</strong> {{ material.balance|add:operation.quantity }} шт.
                            </li>
                            {% endif %}
                        </ul>
                    </div>
                    <!-- Форма редактирования -->
                    <form method="post">
                        {% csrf_token %}

                        {% include "includes/form_errors.html" with form=form %}

                        <div class="mb-3">
                            <label class="form-label">{{ form.quantity.label }}</label>
                            {{ form.quantity }}
                            <div class="form-text">
                                Максимально можно установить:
                                {% if operation.operation_type == 'write_off' %}
                                    {{ operation.material.balance|add:operation.quantity }} шт.
                                {% else %}
                                    не ограничено
                                {% endif %}
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">{{ form.notes.label }}</label>
                            {{ form.notes }}
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-warning">
                                💾 Сохранить изменения
                            </button>
                            <a href="{% url 'mebel:operations_list' %}" class="btn btn-secondary">
                                Отмена
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\mebel\templates\mebel\base.html
============================================================

{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{% block title %}Ware House{% endblock %}</title>

    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <!-- Global CSS -->
    <link rel="stylesheet" href="{% static 'css/global.css' %}">

    <!-- В head после global.css -->
    <link rel="stylesheet" href="{% static 'css/cards.css' %}">

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <link rel="stylesheet" href="{% static 'css/global.css' %}">

    {% block extra_css %}{% endblock %}
</head>
<body>
    <header id="header" class="bg-primary text-white shadow-lg">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center py-2">
                <!-- Логотип и основная навигация -->
                <div class="d-flex align-items-center">
                    <a href="{% url 'mebel:main_dashboard' %}" class="logo text-white text-decoration-none fw-bold fs-4 me-4">
                        <i class="bi bi-house-gear me-2"></i>Мой Склад
                    </a>

                    <!-- Навигационные меню -->
                    <div class="d-flex align-items-center gap-2">
                        <!-- Меню заказов -->
                        <div class="dropdown">
                            <button class="btn btn-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                📋 Заказы
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="{% url 'orders:order_list' %}">📊 Список заказов</a></li>
                                {% if user.groups.all.0.name == 'Менеджеры' or user.is_superuser %}
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="{% url 'orders:order_create' %}">➕ Создать заказ</a></li>
                                {% endif %}
                            </ul>
                        </div>

                        <!-- Меню материалов -->
                        <div class="dropdown">
                            <button class="btn btn-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                📦 Материалы
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="{% url 'mebel:material_list' %}">📋 Список материалов</a></li>
                                {% if user.groups.all.0.name == 'Отдел МТО' or user.is_superuser %}
                                <li><a class="dropdown-item" href="{% url 'mebel:material_create' %}">➕ Добавить материал</a></li>
                                <li><a class="dropdown-item" href="{% url 'mebel:operations_list' %}">🔄 Операции списания/поступления</a></li>
                                {% endif %}
                            </ul>
                        </div>

                        <!-- Ссылка на профиль -->
                        <a href="{% url 'account:profile' %}" class="btn btn-outline-light btn-sm">👤 Мой профиль</a>
                    </div>
                </div>

                <!-- Информация о пользователе -->
                <div class="user-info">
                    {% if user.is_authenticated %}
                    <div class="d-flex align-items-center gap-3">
                        <span class="d-none d-md-inline">
                            <i class="bi bi-person-circle me-1"></i>
                            <strong>{{ user.get_full_name|default:user.username }}</strong>
                        </span>
                        <span class="badge bg-light text-dark">
                            {% if user.groups.all %}
                                {{ user.groups.all.0.name }}
                            {% else %}
                                {% if user.is_staff %}Администратор{% else %}Пользователь{% endif %}
                            {% endif %}
                        </span>
                    </div>
                    {% else %}
                    <span class="text-white-50">Неавторизованный пользователь</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </header>

    <div id="content" class="container-fluid mt-4">
        {% block content %}
        {% endblock %}
    </div>

    <!-- Ваши кастомные JS -->
    <script src="{% static 'js/icons.js' %}"></script>
    {% block domready %}
    {% endblock %}

    <style>
    #header {
        position: sticky;
        top: 0;
        z-index: 1000;
    }

    .logo:hover {
        opacity: 0.9;
        transform: translateY(-1px);
    }

    /* Стили для навигационных кнопок */
    .header-nav .btn {
        font-size: 0.875rem;
        padding: 0.375rem 0.75rem;
    }

    .header-nav .dropdown-menu {
        font-size: 0.875rem;
    }
    </style>
</body>
</html>


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\mebel\templates\mebel\main_dashboard.html
============================================================

{% extends "mebel/base.html" %}
{% load static %}

{% block title %}Мой склад{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'mebel/css/dashboard.css' %}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
.dashboard-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}

.welcome-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 16px;
    padding: 25px;
    margin-bottom: 30px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
}

.welcome-card h5 {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 10px;
}

.welcome-card p {
    opacity: 0.9;
    margin: 0;
    font-size: 1.1rem;
}

.full-width-chart {
    width: 100%;
    margin-bottom: 30px;
}

.shortage-cards {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 25px;
    margin-bottom: 30px;
}

.shortage-card {
    min-height: 300px;
    transition: transform 0.3s ease;
}

.shortage-card:hover {
    transform: translateY(-5px);
}

.card-modern {
    background: white;
    border-radius: 16px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.08);
    border: none;
    overflow: hidden;
}

.card-modern-header {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    padding: 20px 25px;
    border-bottom: 1px solid #e2e8f0;
}

.card-modern-title {
    color: #2c3e50;
    font-weight: 600;
    margin: 0;
    font-size: 1.3rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

.card-modern-body {
    padding: 25px;
}

/* Стили для кнопок периода */
.period-buttons {
    display: flex;
    gap: 10px;
}

.btn-period {
    padding: 8px 16px;
    border: 2px solid #667eea;
    background: transparent;
    color: #667eea;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
    text-decoration: none;
    font-size: 0.9rem;
}

.btn-period:hover {
    background: #667eea;
    color: white;
    transform: translateY(-2px);
}

.btn-period.active {
    background: #667eea;
    color: white;
}

/* Стили для списка материалов */
.material-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.material-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    background: #f8fafc;
    border-radius: 12px;
    border-left: 4px solid;
    transition: all 0.3s;
    text-decoration: none;
    color: inherit;
}

.material-item:hover {
    background: #f1f5f9;
    transform: translateX(5px);
}

.material-item.current {
    border-left-color: #ef4444;
}

.material-item.predicted {
    border-left-color: #f59e0b;
}

.material-name {
    font-weight: 500;
    color: #2c3e50;
    flex: 1;
}

.material-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.85rem;
}

.badge-danger {
    background: #fee2e2;
    color: #dc2626;
}

.badge-warning {
    background: #fef3c7;
    color: #d97706;
}

/* Стили для графика */
.chart-container {
    position: relative;
    height: 300px;
    width: 100%;
}

.no-data {
    text-align: center;
    padding: 60px 20px;
    color: #9ca3af;
}

.no-data p {
    margin: 0;
    font-size: 1.1rem;
}

/* Анимации */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.card-modern {
    animation: fadeInUp 0.6s ease-out;
}

.shortage-card:nth-child(1) { animation-delay: 0.1s; }
.shortage-card:nth-child(2) { animation-delay: 0.2s; }

/* Адаптивность */
@media (max-width: 1024px) {
    .dashboard-container {
        padding: 15px;
    }

    .shortage-cards {
        grid-template-columns: 1fr;
        gap: 20px;
    }
}

@media (max-width: 768px) {
    .dashboard-container {
        padding: 10px;
    }

    .welcome-card {
        padding: 20px;
        margin-bottom: 20px;
    }

    .card-modern-body {
        padding: 20px;
    }

    .period-buttons {
        flex-wrap: wrap;
        justify-content: center;
    }

    .btn-period {
        flex: 1;
        min-width: 80px;
        text-align: center;
    }

    .material-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
}

@media (max-width: 480px) {
    .welcome-card h5 {
        font-size: 1.3rem;
    }

    .card-modern-title {
        font-size: 1.1rem;
    }

    .chart-container {
        height: 250px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Заголовок -->
    <div class="text-center mb-4">
        <h1 style="color: #2c3e50; font-weight: 700; font-size: 2.5rem; margin-bottom: 10px;">📊 Мой склад</h1>
        <p style="color: #6b7280; font-size: 1.2rem;">Панель управления складом и отслеживание материалов</p>
    </div>

    <!-- Приветственная карточка -->
    <div class="welcome-card">
        <h5>🎉 Добро пожаловать в систему управления складом!</h5>
        <p>Здесь отображается общая информация по заказам и материалам в реальном времени.</p>
    </div>

    <!-- График динамики заказов -->
    <div class="full-width-chart">
        <div class="card-modern">
            <div class="card-modern-header d-flex justify-content-between align-items-center">
                <h5 class="card-modern-title">
                    📈 Динамика создания заказов
                </h5>
                <div class="period-buttons">
                    <a href="?period=week" class="btn-period {% if period == 'week' %}active{% endif %}">Неделя</a>
                    <a href="?period=month" class="btn-period {% if period == 'month' %}active{% endif %}">Месяц</a>
                    <a href="?period=year" class="btn-period {% if period == 'year' %}active{% endif %}">Год</a>
                </div>
            </div>
            <div class="card-modern-body">
                {% if has_data %}
                <div class="chart-container">
                    <canvas id="ordersChart"></canvas>
                </div>
                {% else %}
                <div class="no-data">
                    <p>📭 Нет данных для отображения графика</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Карточки нехватки материалов -->
    <div class="shortage-cards">
        <!-- Текущая нехватка -->
        <div class="card-modern shortage-card">
            <div class="card-modern-header">
                <h5 class="card-modern-title">🔴 Текущая нехватка</h5>
            </div>
            <div class="card-modern-body">
                {% if current_shortage %}
                <div class="material-list">
                    {% for material in current_shortage %}
                    <a href="{{ material.get_absolute_url }}" class="material-item current">
                        <span class="material-name">{{ material.name }}</span>
                        <span class="material-badge badge-danger">Не хватает: {{ material.lack }} шт.</span>
                    </a>
                    {% endfor %}
                </div>
                {% else %}
                <div class="no-data">
                    <p>✅ Нет материалов с текущей нехваткой</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Прогнозируемая нехватка -->
        <div class="card-modern shortage-card">
            <div class="card-modern-header">
                <h5 class="card-modern-title">🟡 Прогнозируемая нехватка</h5>
            </div>
            <div class="card-modern-body">
                {% if predicted_shortage %}
                <div class="material-list">
                    {% for material in predicted_shortage %}
                    <a href="{{ material.get_absolute_url }}" class="material-item predicted">
                        <span class="material-name">{{ material.name }}</span>
                        <span class="material-badge badge-warning">{{ material.balance }} из {{ material.reserved }} шт.</span>
                    </a>
                    {% endfor %}
                </div>
                {% else %}
                <div class="no-data">
                    <p>✅ Нет материалов с прогнозируемой нехваткой</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block domready %}
{% if has_data %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('ordersChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: {{ dates_json|safe }},
            datasets: [{
                label: 'Количество заказов',
                data: {{ counts_json|safe }},
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                borderColor: 'rgba(102, 126, 234, 1)',
                borderWidth: 3,
                tension: 0.3,
                fill: true,
                pointBackgroundColor: '#667eea',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointRadius: 5,
                pointHoverRadius: 7
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        font: {
                            size: 14,
                            family: "'Inter', sans-serif"
                        },
                        color: '#2c3e50'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(44, 62, 80, 0.9)',
                    titleFont: {
                        size: 13,
                        family: "'Inter', sans-serif"
                    },
                    bodyFont: {
                        size: 13,
                        family: "'Inter', sans-serif"
                    },
                    padding: 12,
                    cornerRadius: 8
                }
            },
            scales: {
                x: {
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        font: {
                            family: "'Inter', sans-serif"
                        },
                        color: '#6b7280'
                    }
                },
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        font: {
                            family: "'Inter', sans-serif"
                        },
                        color: '#6b7280'
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            },
            animations: {
                tension: {
                    duration: 1000,
                    easing: 'linear'
                }
            }
        }
    });
});
</script>
{% endif %}
{% endblock %}


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\mebel\templates\mebel\pagination.html
============================================================

<div class="pagination">
    <span class="step-links">
        {% if page_obj.has_previous %}
            <a href="?page=1{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}{% if request.GET.order %}&order={{ request.GET.order }}{% endif %}{% if category %}&category={{ category.slug }}{% endif %}" class="btn btn-sm btn-outline-primary">&laquo;</a>
            <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}{% if request.GET.order %}&order={{ request.GET.order }}{% endif %}{% if category %}&category={{ category.slug }}{% endif %}" class="btn btn-sm btn-outline-primary">&lsaquo;</a>
        {% endif %}

        <span class="current small">
            Страница {{ page_obj.number }} из {{ page_obj.paginator.num_pages }}
        </span>

        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}{% if request.GET.order %}&order={{ request.GET.order }}{% endif %}{% if category %}&category={{ category.slug }}{% endif %}" class="btn btn-sm btn-outline-primary">&rsaquo;</a>
            <a href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}{% if request.GET.order %}&order={{ request.GET.order }}{% endif %}{% if category %}&category={{ category.slug }}{% endif %}" class="btn btn-sm btn-outline-primary">&raquo;</a>
        {% endif %}
    </span>
</div>

<style>
.pagination {
    margin: 15px 0;
    text-align: center;
}
.pagination .btn {
    margin: 0 2px;
    padding: 2px 6px;
    font-size: 12px;
}
.pagination .current {
    padding: 0 10px;
    font-size: 12px;
}
</style>


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\mebel\admin.py
============================================================

from django.contrib import admin
from .models import Category, Material, Supplier  # добавляем импорт Supplier
from django.utils.html import format_html

@admin.register(Supplier)
class SupplierAdmin(admin.ModelAdmin):
    list_display = ['name', 'contact_person', 'phone', 'email', 'created']
    list_filter = ['created']
    search_fields = ['name', 'contact_person', 'phone']

@admin.register(Category)
class CategoryAdmin(admin.ModelAdmin):
    list_display = ['name', 'slug']
    prepopulated_fields = {'slug': ('name',)}

@admin.register(Material)
class MaterialAdmin(admin.ModelAdmin):
    # Добавляем supplier в list_display
    list_display = ['name', 'supplier', 'balance', 'reserved',
                   'available_with_status', 'lack', 'updated']
    list_filter = ['created', 'updated', 'lack', 'category', 'supplier']  # добавляем supplier в фильтры
    # Добавляем поиск по поставщику
    search_fields = ['name', 'supplier__name']

    def available_with_status(self, obj):
        """Цветное отображение с иконками"""
        colors = {
            'green': '#4CAF50',
            'yellow': '#FFC107',
            'red': '#F44336'
        }

        icons = {
            'green': '🟢',
            'yellow': '⚠️',
            'red': '❌'
        }

        return format_html(
            '{} <span style="color: white; background: {}; padding: 3px 8px; border-radius: 4px;">{}</span>',
            icons[obj.availability_status],
            colors[obj.availability_status],
            obj.available
        )

    available_with_status.short_description = 'Доступно'


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\mebel\apps.py
============================================================

from django.apps import AppConfig


class MebelConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'mebel'




============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\mebel\forms.py
============================================================

from django import forms
from .models import Material, Category
from django.core.exceptions import ValidationError
from .models import Material
from django.db.models.functions import Lower, Replace
from django.db.models import Value
from django import forms
from .models import Material, MaterialOperation, Category, Supplier
from django.core.exceptions import ValidationError
from django.db.models.functions import Lower, Replace
from django.db.models import Value

class SupplierCreateForm(forms.ModelForm):
    class Meta:
        model = Supplier
        fields = ['name', 'contact_person', 'phone', 'email', 'address']
        widgets = {
            'name': forms.TextInput(attrs={'class': 'form-control', 'placeholder': 'Название компании'}),
            'contact_person': forms.TextInput(attrs={'class': 'form-control', 'placeholder': 'ФИО контактного лица'}),
            'phone': forms.TextInput(attrs={'class': 'form-control', 'placeholder': '+7 (XXX) XXX-XX-XX'}),
            'email': forms.EmailInput(attrs={'class': 'form-control', 'placeholder': 'email@example.com'}),
            'address': forms.Textarea(attrs={'class': 'form-control', 'rows': 2, 'placeholder': 'Полный адрес'}),
        }
        labels = {
            'name': 'Название поставщика*',
            'contact_person': 'Контактное лицо',
            'phone': 'Телефон',
            'email': 'Email',
            'address': 'Адрес',
        }

    def clean_name(self):
        name = self.cleaned_data['name']
        if Supplier.objects.filter(name__iexact=name).exists():
            raise ValidationError('Поставщик с таким названием уже существует.')
        return name

class MaterialEditForm(forms.ModelForm):
    class Meta:
        model = Material
        fields = ['name', 'category', 'supplier', 'description', 'price', 'image']
        widgets = {
            'name': forms.TextInput(attrs={'class': 'form-control'}),
            'category': forms.Select(attrs={'class': 'form-control'}),
            'supplier': forms.Select(attrs={'class': 'form-control', 'id': 'supplier-select'}),
            'description': forms.Textarea(attrs={'class': 'form-control', 'rows': 3}),
            'price': forms.NumberInput(attrs={'class': 'form-control'}),
            'image': forms.FileInput(attrs={'class': 'form-control'}),
        }
        labels = {
            'name': 'Название',
            'category': 'Категория',
            'supplier': 'Поставщик',
            'description': 'Описание',
            'price': 'Цена',
            'image': 'Изображение',
        }


class MaterialOperationEditForm(forms.ModelForm):
    class Meta:
        model = MaterialOperation
        fields = ['quantity', 'notes']
        widgets = {
            'quantity': forms.NumberInput(attrs={
                'class': 'form-control',
                'min': 1
            }),
            'notes': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 3
            })
        }

    def __init__(self, *args, **kwargs):
        self.material = kwargs.pop('material', None)
        super().__init__(*args, **kwargs)

    def clean_quantity(self):
        quantity = self.cleaned_data['quantity']
        if (self.material and
                self.instance.operation_type == 'write_off' and
                hasattr(self.instance, 'id')):
            current_balance = self.material.balance
            quantity_diff = quantity - self.instance.quantity
            projected_balance = current_balance - quantity_diff
            if projected_balance < 0:
                raise ValidationError(
                    f'Нельзя списать {quantity} шт. Это приведет к отрицательному балансу ({projected_balance})'
                )
        return quantity

class MaterialCreateForm(forms.ModelForm):
    class Meta:
        model = Material
        fields = ['name', 'category', 'supplier', 'description', 'price', 'image']
        widgets = {
            'name': forms.TextInput(attrs={'class': 'form-control'}),
            'category': forms.Select(attrs={'class': 'form-control'}),
            'supplier': forms.Select(attrs={'class': 'form-control', 'id': 'supplier-select'}),
            'description': forms.Textarea(attrs={'class': 'form-control', 'rows': 3}),
            'price': forms.NumberInput(attrs={'class': 'form-control'}),
            'image': forms.FileInput(attrs={'class': 'form-control'}),
        }
        labels = {
            'name': 'Название',
            'category': 'Категория',
            'supplier': 'Поставщик',
            'description': 'Описание',
            'price': 'Цена',
            'image': 'Изображение',
        }

    def clean_name(self):
        name = self.cleaned_data['name']
        normalized_name = name.lower().replace(' ', '')
        if Material.objects.annotate(
            normalized_name=Lower(Replace('name', Value(' '), Value('')))
        ).filter(normalized_name=normalized_name).exists():
            raise ValidationError('Материал с таким названием уже существует.')
        return name


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\mebel\models.py
============================================================

from django.db import models
from django.urls import reverse
from django.db.models import Sum
from django.conf import settings
from django.urls import reverse
from django.utils.text import slugify
from transliterate import slugify as transliterate_slugify
from django.db.models.functions import Lower, Replace
from django.db.models import Value
from django.utils import timezone


class Supplier(models.Model):
    name = models.CharField(max_length=200, verbose_name="Название поставщика")
    contact_person = models.CharField(max_length=100, blank=True, verbose_name="Контактное лицо")
    phone = models.CharField(max_length=20, blank=True, verbose_name="Телефон")
    email = models.EmailField(blank=True, verbose_name="Email")
    address = models.TextField(blank=True, verbose_name="Адрес")
    created = models.DateTimeField(auto_now_add=True)
    updated = models.DateTimeField(auto_now=True)

    class Meta:
        ordering = ['name']
        verbose_name = 'поставщик'
        verbose_name_plural = 'поставщики'

    def __str__(self):
        return self.name

    def get_absolute_url(self):
        return reverse('mebel:supplier_detail', args=[self.id])

class Category(models.Model):
    name = models.CharField(max_length=200)
    slug = models.SlugField(max_length=200,
                            unique=True)

    class Meta:
        ordering = ['name']
        indexes = [
            models.Index(fields=['name']),
        ]
        constraints = [
            models.UniqueConstraint(
                Lower(Replace('name', Value(' '), Value(''))),
                name='unique_normalized_name'
            )
        ]
        verbose_name = 'category'
        verbose_name_plural = 'categories'


    def __str__(self):
        return self.name

    def get_absolute_url(self):
        return reverse('mebel:material_list_by_category',
                       args=[self.slug])


class Material(models.Model):
    category = models.ForeignKey(Category,
                                 related_name='materials',
                                 on_delete=models.CASCADE)
    name = models.CharField(max_length=200)
    slug = models.SlugField(max_length=200, blank=True)
    image = models.ImageField(upload_to='materials/%Y/%m/%d',
                              blank=True)
    description = models.TextField(blank=True)
    price = models.DecimalField(max_digits=10,
                                decimal_places=2)
    supplier = models.ForeignKey(Supplier,
                                on_delete=models.SET_NULL,
                                null=True,
                                blank=True,
                                verbose_name="Поставщик",
                                related_name='materials')
    balance = models.PositiveIntegerField(default=0, verbose_name="Текущий остаток")
    reserved = models.PositiveIntegerField(default=0, verbose_name="Зарезервировано")
    lack = models.PositiveIntegerField(default=0, verbose_name="Нехватка")
    created = models.DateTimeField(auto_now_add=True)
    updated = models.DateTimeField(auto_now=True)

    class Meta:
        ordering = ['name']
        indexes = [
            models.Index(fields=['id', 'slug']),
            models.Index(fields=['name']),
            models.Index(fields=['lack']),
        ]

    def get_write_off_url(self):
        return reverse('mebel:material_write_off', args=[self.id])

    def get_receipt_url(self):
        return reverse('mebel:material_receipt', args=[self.id])

    @classmethod
    def recalculate_balance(cls, material_id):
        from django.db.models import Sum

        material = cls.objects.get(id=material_id)
        total_receipt = MaterialOperation.objects.filter(
            material=material,
            operation_type='receipt'
        ).aggregate(total=Sum('quantity'))['total'] or 0
        total_write_off = MaterialOperation.objects.filter(
            material=material,
            operation_type='write_off'
        ).aggregate(total=Sum('quantity'))['total'] or 0
        new_balance = total_receipt - total_write_off
        if material.balance != new_balance:
            material.balance = new_balance
            material.save(update_fields=['balance'])

        return new_balance

    @classmethod
    def recalculate_all_balances(cls):
        """Пересчитывает балансы для всех материалов"""
        for material in cls.objects.all():
            cls.recalculate_balance(material.id)
    def recalculate_own_balance(self):
        """Пересчитывает баланс для текущего материала"""
        return self.recalculate_balance(self.id)
    @classmethod
    def update_all_reserved_quantities(cls):
        """Пересчитывает резервы для всех материалов на основе активных заказов"""
        from orders.models import OrderItem
        for material in cls.objects.all():
            total_reserved = OrderItem.objects.filter(
                material=material
            ).aggregate(total=Sum('quantity'))['total'] or 0

            # Обновляем только если значение изменилось
            if material.reserved != total_reserved:
                material.reserved = total_reserved
                material.save(update_fields=['reserved'])

    @property
    def availability_status(self):
        """Возвращает статус доступности для цветового отображения"""
        if self.balance == 0 or self.available <= 0:
            return 'red'
        availability_ratio = self.available / self.balance
        return 'green' if availability_ratio >= 0.2 else 'yellow'

    @property
    def available(self):
        """Автоматически рассчитываемое количество ДОСТУПНО"""
        return max(0, self.balance - self.reserved)

    def clean(self):
        """Расчёт НЕХВАТКА"""
        # Всегда пересчитываем нехватку
        self.lack = max(0, self.reserved - self.balance)

    def update_reserved_quantity(self):
        """
        АКТУАЛИЗАЦИЯ: Пересчитывает резерв для конкретного материала
        """
        from orders.models import OrderItem
        from django.db.models import Sum

        total_reserved = OrderItem.objects.filter(
            material=self
        ).aggregate(total=Sum('quantity'))['total'] or 0

        if self.reserved != total_reserved:
            self.reserved = total_reserved
            self.save(update_fields=['reserved'])

    def save(self, *args, **kwargs):
        from orders.models import OrderItem
        from django.db.models import Sum

        # Пересчитываем резерв с учетом уже списанного
        total_pending = OrderItem.objects.filter(
            material=self
        ).aggregate(
            total=Sum('quantity') - Sum('written_off')
        )['total'] or 0

        self.reserved = total_pending
        self.lack = max(0, total_pending - self.balance)
        super().save(*args, **kwargs)

    def __str__(self):
        return self.name

    def get_absolute_url(self):
        return reverse('mebel:material_detail',
                       args=[self.id, self.slug])


class MaterialOperation(models.Model):
    OPERATION_TYPES = [
        ('write_off', 'Списание'),
        ('receipt', 'Поступление'),
    ]

    material = models.ForeignKey(Material, on_delete=models.CASCADE, related_name='operations')
    operation_type = models.CharField(max_length=20, choices=OPERATION_TYPES)
    quantity = models.PositiveIntegerField()
    notes = models.TextField(blank=True, null=True)
    user = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.SET_NULL, null=True)
    created = models.DateTimeField(auto_now_add=True)

    class Meta:
        ordering = ['-created']

    def __str__(self):
        return f"{self.get_operation_type_display()} {self.quantity} шт. - {self.material.name}"

    def get_edit_url(self):
        return reverse('mebel:operation_edit', args=[self.id])

    def get_absolute_url(self):
        return reverse('mebel:operations_list') + f'?operation={self.id}'

    def can_edit(self):
        """Проверяет, можно ли редактировать операцию (только сегодняшние)"""
        return self.created.date() == timezone.now().date()



============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\mebel\tests.py
============================================================

from django.test import TestCase

# Create your tests here.


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\mebel\urls.py
============================================================

from django.urls import path
from . import views
from .views import MaterialListView

app_name = 'mebel'

urlpatterns = [
    path('recalculate-balances/', views.recalculate_balances, name='recalculate_balances'),
    path('operations/', views.operations_list, name='operations_list'),
    path('operations/<int:operation_id>/edit/', views.operation_edit, name='operation_edit'),
    path('operations/<int:operation_id>/', views.operation_detail, name='operation_detail'),
    path('', views.main_dashboard, name='main_dashboard'),
    path('create/', views.material_create, name='material_create'),
    path('materials/', MaterialListView.as_view(), name='material_list'),  # Изменили с 'materials' на 'materials/'
    path('refresh-materials/', views.refresh_materials, name='refresh_materials'),
    path('<int:material_id>/write-off/', views.material_write_off, name='material_write_off'),
    path('<int:material_id>/receipt/', views.material_receipt, name='material_receipt'),
    path('<int:material_id>/edit/', views.material_edit, name='material_edit'),  # Новый URL
    path('<slug:category_slug>/', MaterialListView.as_view(), name='material_list_by_category'),  # Используем MaterialListView
    path('<int:id>/<slug:slug>/', views.material_detail, name='material_detail'),
    path('supplier/create-modal/', views.supplier_create_modal, name='supplier_create_modal'),
    path('material-chart-data/<int:material_id>/', views.material_daily_chart_data, name='material_chart_data'),
    path('material-autocomplete/', views.material_autocomplete, name='material_autocomplete'),
    path('material/<int:material_id>/operations/', views.material_operations, name='material_operations'),



]


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\mebel\views.py
============================================================

from django.shortcuts import get_object_or_404
from .models import Category, Material
from django.views.generic import ListView
from django.contrib import messages
from django.contrib.auth.decorators import login_required
from django.contrib.auth.mixins import LoginRequiredMixin
from django.shortcuts import render, redirect
from django.views.decorators.http import require_http_methods
from django.views.decorators.http import require_POST
from .models import MaterialOperation  # Добавьте импорт
from django import forms
from django.db.models import Count, F, Q
from django.db.models.functions import TruncDate, TruncMonth, TruncYear
from datetime import datetime, timedelta
from django.http import JsonResponse, HttpResponseBadRequest  # Добавить импорт
from orders.models import Order
from warehouse.utils import managers_required, mto_required
from .forms import MaterialEditForm, MaterialCreateForm  # Добавить импорт
from .models import Material
import json
from django.utils.safestring import mark_safe
from django.utils.text import slugify
from transliterate import slugify as transliterate_slugify
from django.core.paginator import Paginator
from django.db.models import F, ExpressionWrapper, IntegerField
from django.shortcuts import get_object_or_404
from .models import Category, Material, Supplier  # добавляем Supplier
from .forms import MaterialEditForm, MaterialCreateForm, SupplierCreateForm  # добавляем SupplierCreateForm
from django.http import JsonResponse
from django.template.loader import render_to_string

# Добавим в views.py после существующих импортов
from django.db.models import Sum, Q
from django.utils import timezone
from datetime import timedelta

# Добавим в views.py
from django.db.models import Sum
from datetime import datetime, timedelta
import json

from django.core.paginator import Paginator
from .forms import MaterialOperationEditForm


@login_required
@mto_required
def operations_list(request):
    """Список всех операций с фильтрацией"""
    operations = MaterialOperation.objects.select_related(
        'material', 'user'
    ).order_by('-created')

    # Фильтрация
    operation_type = request.GET.get('type', '')
    material_id = request.GET.get('material', '')
    date_from = request.GET.get('date_from', '')
    date_to = request.GET.get('date_to', '')

    if operation_type:
        operations = operations.filter(operation_type=operation_type)

    if material_id:
        operations = operations.filter(material_id=material_id)

    if date_from:
        operations = operations.filter(created__date__gte=date_from)

    if date_to:
        operations = operations.filter(created__date__lte=date_to)

    # Пагинация
    paginator = Paginator(operations, 20)
    page_number = request.GET.get('page')
    page_obj = paginator.get_page(page_number)

    # Материалы для фильтра
    materials = Material.objects.all()

    context = {
        'page_obj': page_obj,
        'materials': materials,
        'operation_type': operation_type,
        'selected_material': material_id,
        'date_from': date_from,
        'date_to': date_to,
    }

    return render(request, 'mebel/operations/operations_list.html', context)


@login_required
@mto_required
def operation_edit(request, operation_id):
    """Редактирование операции - УПРОЩЕННАЯ ВЕРСИЯ"""
    operation = get_object_or_404(MaterialOperation, id=operation_id)
    material = operation.material

    # Сохраняем исходный баланс для сообщения
    original_balance = material.balance

    if request.method == 'POST':
        form = MaterialOperationEditForm(
            request.POST,
            instance=operation,
            material=material
        )

        if form.is_valid():
            # Просто сохраняем операцию
            operation = form.save()

            # Пересчитываем баланс материала на основе ВСЕХ операций
            Material.recalculate_balance(material.id)

            # Обновляем объект material
            material.refresh_from_db()

            messages.success(request,
                             f'Операция #{operation.id} успешно отредактирована. ' +
                             f'Баланс пересчитан: {original_balance} → {material.balance}')
            return redirect('mebel:operations_list')
    else:
        form = MaterialOperationEditForm(instance=operation, material=material)

    return render(request, 'mebel/operations/operation_edit.html', {
        'form': form,
        'operation': operation,
        'material': material
    })


@login_required
@mto_required
def operation_detail(request, operation_id):
    """Детальная информация об операции"""
    operation = get_object_or_404(MaterialOperation, id=operation_id)

    return render(request, 'mebel/operations/operation_detail.html', {
        'operation': operation
    })


@login_required
@mto_required
def recalculate_balances(request):
    """Принудительный пересчет всех балансов"""
    try:
        Material.recalculate_all_balances()
        messages.success(request, 'Балансы всех материалов успешно пересчитаны')
    except Exception as e:
        messages.error(request, f'Ошибка при пересчете балансов: {e}')

    return redirect('mebel:operations_list')
@login_required
def material_operations(request, material_id):
    """Возвращает детальную информацию об операциях материала"""
    material = get_object_or_404(Material, id=material_id)

    # Операции из MaterialOperation
    operations = MaterialOperation.objects.filter(material=material).order_by('-created')[:50]

    # Резервирования из OrderItem
    from orders.models import OrderItem
    reservations = OrderItem.objects.filter(material=material).order_by('-order__created')[:50]

    operations_data = []

    for op in operations:
        operations_data.append({
            'date': op.created.isoformat(),
            'type': op.get_operation_type_display(),
            'quantity': op.quantity,
            'notes': op.notes,
            'user': op.user.username if op.user else 'Система',
            'source': 'operation'
        })

    for res in reservations:
        operations_data.append({
            'date': res.order.created.isoformat(),
            'type': 'Резервирование',
            'quantity': res.quantity,
            'notes': f'Заказ #{res.order.id}',
            'user': res.order.user.username if res.order.user else 'Система',
            'source': 'order'
        })

    # Сортируем по дате
    operations_data.sort(key=lambda x: x['date'], reverse=True)

    return JsonResponse(operations_data, safe=False)

@login_required
def material_chart_data(request, material_id):
    """Возвращает данные для графика наличия материала"""
    material = get_object_or_404(Material, id=material_id)

    # Получаем операции за последний год
    one_year_ago = timezone.now() - timedelta(days=365)
    operations = MaterialOperation.objects.filter(
        material=material,
        created__gte=one_year_ago
    ).order_by('created')

    # Также получаем операции из заказов (резервирования)
    from orders.models import OrderItem
    order_operations = OrderItem.objects.filter(
        material=material,
        order__created__gte=one_year_ago
    ).order_by('order__created')

    # Собираем все операции вместе
    all_operations = []

    # Добавляем MaterialOperation
    for op in operations:
        all_operations.append({
            'date': op.created,
            'type': op.operation_type,
            'quantity': op.quantity,
            'source': 'operation'
        })

    # Добавляем OrderItem (резервирования)
    for item in order_operations:
        all_operations.append({
            'date': item.order.created,
            'type': 'reservation',
            'quantity': item.quantity,
            'source': 'order'
        })

    # Сортируем все операции по дате
    all_operations.sort(key=lambda x: x['date'])

    # Создаем временные точки для графика (по месяцам)
    dates = []
    quantities = []

    # Начинаем с текущего баланса и идем назад
    current_date = timezone.now().date()
    start_date = current_date - timedelta(days=365)

    # Создаем точки для каждого месяца
    temp_date = start_date.replace(day=1)  # Начинаем с первого дня месяца
    monthly_data = {}

    while temp_date <= current_date:
        month_key = temp_date.strftime('%Y-%m')
        monthly_data[month_key] = {
            'date': temp_date,
            'receipt': 0,
            'write_off': 0,
            'reservation': 0
        }
        # Переходим к следующему месяцу
        if temp_date.month == 12:
            temp_date = temp_date.replace(year=temp_date.year + 1, month=1)
        else:
            temp_date = temp_date.replace(month=temp_date.month + 1)

    # Распределяем операции по месяцам
    for op in all_operations:
        month_key = op['date'].strftime('%Y-%m')
        if month_key in monthly_data:
            if op['type'] == 'receipt':
                monthly_data[month_key]['receipt'] += op['quantity']
            elif op['type'] == 'write_off':
                monthly_data[month_key]['write_off'] += op['quantity']
            elif op['type'] == 'reservation':
                monthly_data[month_key]['reservation'] += op['quantity']

    # Восстанавливаем историю баланса (идем от текущего значения назад)
    current_balance = material.balance
    balance_history = {current_date.strftime('%Y-%m'): current_balance}

    # Сортируем месяцы в обратном порядке (от текущего к прошлому)
    sorted_months = sorted(monthly_data.keys(), reverse=True)

    for i, month_key in enumerate(sorted_months):
        if month_key == current_date.strftime('%Y-%m'):
            # Текущий месяц - используем текущий баланс
            continue

        # Для предыдущих месяцев: вычитаем поступления и прибавляем списания/резервирования
        # (т.к. идем назад во времени)
        month_data = monthly_data[month_key]
        current_balance = current_balance - month_data['receipt'] + month_data['write_off'] + month_data['reservation']
        balance_history[month_key] = max(0, current_balance)  # Баланс не может быть отрицательным

    # Сортируем данные по дате для графика
    sorted_history = sorted(balance_history.items(), key=lambda x: x[0])

    dates = [item[0] for item in sorted_history]
    quantities = [item[1] for item in sorted_history]

    return JsonResponse({
        'material_name': material.name,
        'dates': dates,
        'quantities': quantities,
        'current_balance': material.balance,
        'current_available': material.available,
        'reserved': material.reserved
    })


@login_required
def material_daily_chart_data(request, material_id):
    """Данные для графика по дням - ИСПРАВЛЕННАЯ ВЕРСИЯ"""
    material = get_object_or_404(Material, id=material_id)

    # Получаем операции за ВСЕ время, а не за год
    operations = MaterialOperation.objects.filter(
        material=material
    ).order_by('created')

    # Получаем резервирования за ВСЕ время
    from orders.models import OrderItem
    reservations = OrderItem.objects.filter(
        material=material
    ).order_by('order__created')

    # Собираем ВСЕ события за всю историю материала
    all_events = []

    for op in operations:
        all_events.append({
            'date': op.created,
            'type': op.operation_type,
            'quantity': op.quantity,
            'source': 'operation'
        })

    for res in reservations:
        all_events.append({
            'date': res.order.created,
            'type': 'reservation',
            'quantity': res.quantity,
            'source': 'order'
        })

    # Сортируем по дате (от старых к новым)
    all_events.sort(key=lambda x: x['date'])

    # Восстанавливаем историю баланса ПРАВИЛЬНО
    # Начинаем с ИЗВЕСТНОГО начального баланса (если есть самая первая операция)
    current_balance = 0
    balance_history = []

    # Если есть события, находим баланс ДО первого события
    if all_events:
        # Вычисляем баланс на момент ДО первой операции
        # Для этого идем ОТ ТЕКУЩЕГО баланса НАЗАД через все операции
        temp_balance = material.balance

        # Идем в обратном порядке (от новых к старым) и "отменяем" операции
        for event in reversed(all_events):
            if event['type'] == 'receipt':
                temp_balance -= event['quantity']  # Отменяем поступление
            elif event['type'] == 'write_off':
                temp_balance += event['quantity']  # Отменяем списание
            # Резервирования не влияют на физический баланс

        current_balance = max(0, temp_balance)  # Начальный баланс ДО всех операций

    # Теперь идем вперед по времени и применяем операции
    dates = []
    quantities = []

    # Добавляем начальную точку (если есть история)
    if all_events:
        first_date = all_events[0]['date'].date()
        # Добавляем точку за день до первой операции
        prev_date = first_date - timedelta(days=1)
        dates.append(prev_date.isoformat())
        quantities.append(current_balance)

    # Применяем операции в хронологическом порядке
    for event in all_events:
        event_date = event['date'].date()

        if event['type'] == 'receipt':
            current_balance += event['quantity']
        elif event['type'] == 'write_off':
            current_balance = max(0, current_balance - event['quantity'])  # Не уходим в минус

        # Добавляем точку после операции
        dates.append(event_date.isoformat())
        quantities.append(current_balance)

    # Ограничиваем последним годом для производительности
    one_year_ago = (timezone.now() - timedelta(days=365)).date()

    filtered_data = []
    for i, date_str in enumerate(dates):
        date_obj = datetime.fromisoformat(date_str).date()
        if date_obj >= one_year_ago:
            filtered_data.append((date_str, quantities[i]))

    if filtered_data:
        dates_filtered, quantities_filtered = zip(*filtered_data)
    else:
        dates_filtered, quantities_filtered = [], []

    return JsonResponse({
        'material_name': material.name,
        'dates': dates_filtered,
        'quantities': quantities_filtered,
        'current_balance': material.balance,
        'current_available': material.available,
        'reserved': material.reserved
    })

# View для автодополнения поиска
# Добавим в views.py улучшенную функцию автодополнения
@login_required
def material_autocomplete(request):
    """Автодополнение для поиска материалов"""
    query = request.GET.get('q', '').strip()

    # Логируем запрос для отладки
    print(f"Autocomplete query: '{query}'")

    if not query or len(query) < 2:
        return JsonResponse([], safe=False)

    try:
        # Используем более гибкий поиск
        materials = Material.objects.filter(
            Q(name__icontains=query) |
            Q(description__icontains=query) |
            Q(supplier__name__icontains=query) |
            Q(category__name__icontains=query)
        ).select_related('category', 'supplier').distinct()[:10]

        results = []
        for material in materials:
            results.append({
                'id': material.id,
                'name': material.name,
                'category': material.category.name if material.category else 'Без категории',
                'balance': material.balance,
                'supplier': material.supplier.name if material.supplier else 'Не указан'
            })

        print(f"Found {len(results)} materials")
        return JsonResponse(results, safe=False)

    except Exception as e:
        print(f"Error in material_autocomplete: {e}")
        # Возвращаем пустой список при ошибке
        return JsonResponse([], safe=False)


# НОВЫЙ VIEW ДЛЯ СОЗДАНИЯ ПОСТАВЩИКА ЧЕРЕЗ МОДАЛКУ
@login_required
@require_http_methods(["GET", "POST"])
def supplier_create_modal(request):
    if request.method == 'POST':
        form = SupplierCreateForm(request.POST)
        if form.is_valid():
            supplier = form.save()

            # Если это AJAX запрос, возвращаем JSON
            if request.headers.get('X-Requested-With') == 'XMLHttpRequest':
                return JsonResponse({
                    'success': True,
                    'supplier_id': supplier.id,
                    'supplier_name': supplier.name,
                    'message': 'Поставщик успешно создан!'
                })

            # Для не-AJAX запроса определяем, откуда пришел запрос
            referer = request.POST.get('referer') or request.META.get('HTTP_REFERER')

            messages.success(request, f'Поставщик "{supplier.name}" успешно создан!')

            # Пытаемся вернуться на предыдущую страницу
            if referer:
                return redirect(referer)
            else:
                # Если referer нет, возвращаемся к списку материалов
                return redirect('mebel:material_list')

        # Обработка невалидной формы для AJAX
        if request.headers.get('X-Requested-With') == 'XMLHttpRequest':
            return JsonResponse({
                'success': False,
                'errors': form.errors
            })
        # Для не-AJAX просто показываем форму с ошибками
        # (этот случай маловероятен, но на всякий случай)

    else:
        form = SupplierCreateForm()

    # Рендерим форму для модального окна (AJAX)
    if request.headers.get('X-Requested-With') == 'XMLHttpRequest':
        html = render_to_string('mebel/includes/supplier_modal_form.html', {
            'form': form
        }, request=request)
        return JsonResponse({'html': html})

    # Не-AJAX GET запрос (редкий случай)
    return render(request, 'mebel/supplier/create.html', {'form': form})

@require_POST  # Разрешаем только POST-запросы
@login_required
def refresh_materials(request):
    """Отдельный view только для обновления данных"""
    try:
        # После рефакторинга сигналов эта строка может не понадобиться!
        # Material.update_all_reserved_quantities()
        messages.success(request, '✅ Данные материалов успешно обновлены!')
    except Exception as e:
        messages.error(request, f'❌ Ошибка при обновлении: {e}')

    # Возвращаем на предыдущую страницу
    return redirect(request.META.get('HTTP_REFERER', 'mebel:material_list'))


@login_required
def main_dashboard(request):
    period = request.GET.get('period', 'month')  # week, month, year

    today = datetime.now().date()
    if period == 'week':
        start_date = today - timedelta(days=7)
        trunc_func = TruncDate('created')
    elif period == 'month':
        start_date = today - timedelta(days=30)
        trunc_func = TruncDate('created')
    else:  # year
        start_date = today - timedelta(days=365)
        trunc_func = TruncMonth('created')

    # Получаем данные для графика
    orders_data = Order.objects.filter(
        created__date__gte=start_date
    ).annotate(
        period_field=trunc_func
    ).values('period_field').annotate(
        count=Count('id')
    ).order_by('period_field')

    # Подготавливаем данные для графика
    dates = []
    counts = []

    for item in orders_data:
        if period == 'year':
            dates.append(item['period_field'].strftime('%Y-%m'))
        else:
            dates.append(item['period_field'].strftime('%Y-%m-%d'))
        counts.append(item['count'])

    # Проверяем, является ли запрос AJAX
    if request.headers.get('X-Requested-With') == 'XMLHttpRequest':
        data = {
            'dates': dates,
            'counts': counts,
            'has_data': len(dates) > 0,
            'period': period
        }
        return JsonResponse(data)  # Возвращаем JSON для AJAX

    # Конвертируем данные в JSON для безопасной передачи в JavaScript
    dates_json = mark_safe(json.dumps(dates))
    counts_json = mark_safe(json.dumps(counts))

    # Материалы с текущей нехваткой
    current_shortage = Material.objects.filter(lack__gt=0)

    # Материалы с прогнозируемой нехваткой
    predicted_shortage = Material.objects.filter(
        Q(balance__gt=0) &
        Q(balance__lt=F('reserved') * 1.1) &
        Q(lack=0)
    )

    return render(request, 'mebel/main_dashboard.html', {
        'dates_json': dates_json,
        'counts_json': counts_json,
        'current_shortage': current_shortage,
        'predicted_shortage': predicted_shortage,
        'period': period,
        'has_data': len(dates) > 0
    })


@mto_required
def material_create(request):
    if request.method == 'POST':
        form = MaterialCreateForm(request.POST, request.FILES)
        if form.is_valid():
            material = form.save(commit=False)
            # Генерируем slug, если он не был создан автоматически
            if not material.slug:
                material.slug = transliterate_slugify(material.name)
            material.save()
            messages.success(request, f'Материал "{material.name}" успешно создан!')
            return redirect('mebel:material_detail', id=material.id, slug=material.slug)
    else:
        form = MaterialCreateForm()

    return render(request, 'mebel/material/create.html', {'form': form})


# Форма для списания
class MaterialWriteOffForm(forms.Form):
    quantity = forms.IntegerField(
        label='Количество для списания',
        min_value=1,
        max_value=10000,  # Установим максимальное значение
        widget=forms.NumberInput(attrs={
            'class': 'form-control',
            'placeholder': 'Введите количество',
            'max': 10000  # HTML5 валидация
        })
    )
    reason = forms.CharField(
        label='Причина списания',
        required=False,
        widget=forms.Textarea(attrs={
            'class': 'form-control',
            'rows': 3,
            'placeholder': 'Например: брак, порча, производственные потери'
        })
    )

    def __init__(self, *args, **kwargs):
        self.material = kwargs.pop('material', None)
        super().__init__(*args, **kwargs)
        if self.material:
            # Динамически устанавливаем максимальное значение
            self.fields['quantity'].widget.attrs['max'] = self.material.balance


# Форма для поступления
class MaterialReceiptForm(forms.Form):
    quantity = forms.IntegerField(
        label='Количество для поступления',
        min_value=1,
        max_value=10000,
        widget=forms.NumberInput(attrs={
            'class': 'form-control',
            'placeholder': 'Введите количество'
        })
    )
    comment = forms.CharField(
        label='Комментарий',
        required=False,
        widget=forms.Textarea(attrs={
            'class': 'form-control',
            'rows': 3,
            'placeholder': 'Например: закупка, возврат, инвентаризация'
        })
    )





@mto_required
@require_http_methods(["GET", "POST"])
def material_write_off(request, material_id):
    material = get_object_or_404(Material, id=material_id)

    if request.method == 'POST':
        form = MaterialWriteOffForm(request.POST, material=material)
        if form.is_valid():
            quantity = form.cleaned_data['quantity']
            reason = form.cleaned_data['reason']

            # Списание
            material.balance -= quantity
            material.save()

            # Сохраняем в лог
            MaterialOperation.objects.create(
                material=material,
                operation_type='write_off',
                quantity=quantity,
                notes=reason,
                user=request.user
            )

            # Если это AJAX-запрос, возвращаем JSON
            if request.headers.get('X-Requested-With') == 'XMLHttpRequest':
                return JsonResponse({
                    'success': True,
                    'message': f'Списано {quantity} единиц материала "{material.name}"',
                    'new_balance': material.balance,
                    'new_available': material.available
                })

            messages.success(request, f'Списано {quantity} единиц материала "{material.name}"')
            return redirect('mebel:material_detail', id=material.id, slug=material.slug)
        else:
            # Если форма невалидна и это AJAX, возвращаем ошибки
            if request.headers.get('X-Requested-With') == 'XMLHttpRequest':
                return JsonResponse({
                    'success': False,
                    'errors': form.errors
                })
    else:
        form = MaterialWriteOffForm(material=material)

    # Если это AJAX-запрос (GET), возвращаем HTML формы
    if request.headers.get('X-Requested-With') == 'XMLHttpRequest':
        html = render_to_string('mebel/material/write_off_modal.html', {
            'material': material,
            'form': form,
        }, request=request)
        return JsonResponse({'html': html})

    return render(request, 'mebel/material/write_off_modal.html', {
        'material': material,
        'form': form,
    })


@mto_required
@require_http_methods(["GET", "POST"])
def material_receipt(request, material_id):
    material = get_object_or_404(Material, id=material_id)

    if request.method == 'POST':
        form = MaterialReceiptForm(request.POST)
        if form.is_valid():
            quantity = form.cleaned_data['quantity']
            comment = form.cleaned_data['comment']

            # Поступление
            material.balance += quantity
            material.save()

            # Сохраняем в лог
            MaterialOperation.objects.create(
                material=material,
                operation_type='receipt',
                quantity=quantity,
                notes=comment,
                user=request.user
            )

            # Если это AJAX-запрос, возвращаем JSON
            if request.headers.get('X-Requested-With') == 'XMLHttpRequest':
                return JsonResponse({
                    'success': True,
                    'message': f'Поступило {quantity} единиц материала "{material.name}"',
                    'new_balance': material.balance,
                    'new_available': material.available
                })

            messages.success(request, f'Поступило {quantity} единиц материала "{material.name}"')
            return redirect('mebel:material_detail', id=material.id, slug=material.slug)
        else:
            # Если форма невалидна и это AJAX, возвращаем ошибки
            if request.headers.get('X-Requested-With') == 'XMLHttpRequest':
                return JsonResponse({
                    'success': False,
                    'errors': form.errors
                })
    else:
        form = MaterialReceiptForm()

    # Если это AJAX-запрос (GET), возвращаем HTML формы
    if request.headers.get('X-Requested-With') == 'XMLHttpRequest':
        html = render_to_string('mebel/material/receipt_modal.html', {
            'material': material,
            'form': form,
        }, request=request)
        return JsonResponse({'html': html})

    return render(request, 'mebel/material/receipt_modal.html', {
        'material': material,
        'form': form,
    })

class MaterialListView(LoginRequiredMixin, ListView):
    model = Material
    context_object_name = 'materials'
    template_name = 'mebel/material/list.html'
    paginate_by = 15

    def post(self, request, *args, **kwargs):
        """Обработка кнопки обновления"""
        if 'refresh_data' in request.POST:
            try:
                Material.update_all_reserved_quantities()
                messages.success(request, '✅ Данные материалов успешно обновлены!')
            except Exception as e:
                messages.error(request, f'❌ Ошибка при обновлении: {e}')

        # Возвращаемся к GET-обработке
        return self.get(request, *args, **kwargs)

    def get_queryset(self):
        sort_by = self.request.GET.get('sort', 'name')
        order = self.request.GET.get('order', 'asc')

        queryset = Material.objects.annotate(
            calculated_available=ExpressionWrapper(
                F('balance') - F('reserved'),
                output_field=IntegerField()
            )
        )

        # Добавляем поддержку сортировки по поставщику
        if sort_by == 'supplier':
            # Сортируем по имени поставщика
            if order == 'asc':
                queryset = queryset.order_by('supplier__name')
            else:
                queryset = queryset.order_by('-supplier__name')
        else:
            # Для других полей используем старую логику
            if sort_by == 'available':
                sort_by = 'calculated_available'

            if order == 'asc':
                order_by = sort_by
            else:
                order_by = f'-{sort_by}'

            queryset = queryset.order_by(order_by)

        category_slug = self.kwargs.get('category_slug')
        if category_slug:
            self.category = get_object_or_404(Category, slug=category_slug)
            return queryset.filter(category=self.category)
        return queryset
    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['categories'] = Category.objects.all()
        context['category'] = getattr(self, 'category', None)

        # Добавляем параметры сортировки в контекст
        context['current_sort'] = self.request.GET.get('sort', 'name')
        context['current_order'] = self.request.GET.get('order', 'asc')

        return context

class MaterialOperationForm(forms.Form):
    """Базовая форма для операций с материалами"""
    quantity = forms.IntegerField(
        min_value=1,
        label='Количество',
        widget=forms.NumberInput(attrs={
            'class': 'form-control',
            'placeholder': 'Введите количество'
        })
    )
    notes = forms.CharField(
        required=False,
        label='Примечания',
        widget=forms.Textarea(attrs={
            'class': 'form-control',
            'rows': 3,
            'placeholder': 'Дополнительная информация...'
        })
    )


@login_required
def material_detail(request, id, slug):
    material = get_object_or_404(Material, id=id, slug=slug)
    operations = material.operations.all()[:10]  # Последние 10 операций

    context = {
        'material': material,
        'operations': operations,
    }

    return render(request, 'mebel/material/detail.html', context)



@mto_required
def material_edit(request, material_id):
    material = get_object_or_404(Material, id=material_id)

    if request.method == 'POST':
        form = MaterialEditForm(request.POST, request.FILES, instance=material)
        if form.is_valid():
            form.save()
            messages.success(request, f'Материал "{material.name}" успешно обновлен!')
            return redirect('mebel:material_detail', id=material.id, slug=material.slug)
    else:
        form = MaterialEditForm(instance=material)

    return render(request, 'mebel/material/edit.html', {
        'form': form,
        'material': material
    })


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\mebel\__init__.py
============================================================



============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\orders\templates\orders\order\create.html
============================================================

{% extends "mebel/base.html" %}
{% load static %}
{% load order_extras %}

{% block title %}Создание Заказа{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Заголовок страницы -->
    <div class="page-header">
        <h1>📝 Создание заказа</h1>
        <p>Заполните информацию о новом заказе</p>
    </div>

    <div class="card-modern">
        <div class="card-modern-header">
            <h5 class="card-modern-title">➕ Новый заказ</h5>
        </div>

        <form method="post" class="order-form" enctype="multipart/form-data">
            {% csrf_token %}

            <!-- Обработка ошибок формы -->
            {% include "includes/form_errors.html" with form=form %}

            <!-- Обработка ошибок formsets -->
            {% if formset.errors %}
            <div class="alert-danger" style="background: #fee; border: 1px solid #fcc; color: #c33; padding: 20px; border-radius: 12px; margin-bottom: 25px;">
                <h6 style="margin: 0 0 15px 0; font-weight: 600;">⚠️ Ошибки в позициях заказа:</h6>
                {{ formset.non_form_errors }}
                {% for form in formset %}
                    {% if form.errors %}
                    <div style="margin-bottom: 15px; padding: 12px; background: #fff5f5; border-radius: 8px;">
                        <strong style="color: #c53030;">Позиция {{ forloop.counter }}:</strong>
                        <ul style="margin: 8px 0 0 20px;">
                            {% for field, errors in form.errors.items %}
                            <li>{{ field }}: {{ errors|striptags }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
            {% endif %}

            <!-- Секция загрузки изображений -->
            <div class="form-section">
                <h6 class="section-title">🖼️ Изображения</h6>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="{{ form.blueprint.id_for_label }}" class="form-label">{{ form.blueprint.label }}</label>
                        {{ form.blueprint }}
                        {% if form.blueprint.errors %}
                        <div class="error-text">{{ form.blueprint.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="form-group">
                        <label for="{{ form.visualization.id_for_label }}" class="form-label">{{ form.visualization.label }}</label>
                        {{ form.visualization }}
                        {% if form.visualization.errors %}
                        <div class="error-text">{{ form.visualization.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="form-group">
                        <label for="{{ form.installation_photo.id_for_label }}" class="form-label">{{ form.installation_photo.label }}</label>
                        {{ form.installation_photo }}
                        {% if form.installation_photo.errors %}
                        <div class="error-text">{{ form.installation_photo.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Секция информации о заказе -->
            <div class="form-section">
                <h6 class="section-title">📋 Информация по заказу</h6>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="{{ form.order_name.id_for_label }}" class="form-label">{{ form.order_name.label }}</label>
                        {{ form.order_name }}
                        {% if form.order_name.errors %}
                        <div class="error-text">{{ form.order_name.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="form-group">
                        <label for="{{ form.customer_name.id_for_label }}" class="form-label">{{ form.customer_name.label }}</label>
                        {{ form.customer_name }}
                        {% if form.customer_name.errors %}
                        <div class="error-text">{{ form.customer_name.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="form-group">
                        <label for="{{ form.address.id_for_label }}" class="form-label">{{ form.address.label }}</label>
                        {{ form.address }}
                        {% if form.address.errors %}
                        <div class="error-text">{{ form.address.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="form-group">
                        <label for="{{ form.deadline.id_for_label }}" class="form-label">{{ form.deadline.label }}</label>
                        {{ form.deadline }}
                        {% if form.deadline.errors %}
                        <div class="error-text">{{ form.deadline.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="form-group">
                        <label for="{{ form.transferred_amount.id_for_label }}" class="form-label">{{ form.transferred_amount.label }}</label>
                        {{ form.transferred_amount }}
                        {% if form.transferred_amount.errors %}
                        <div class="error-text">{{ form.transferred_amount.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="form-group">
                        <label for="{{ form.discount.id_for_label }}" class="form-label">{{ form.discount.label }}</label>
                        {{ form.discount }}
                        {% if form.discount.errors %}
                        <div class="error-text">{{ form.discount.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="form-group">
                        <label for="{{ form.category.id_for_label }}" class="form-label">{{ form.category.label }}</label>
                        {{ form.category }}
                        {% if form.category.errors %}
                        <div class="error-text">{{ form.category.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="form-group">
                        <label for="{{ form.installation_status.id_for_label }}" class="form-label">{{ form.installation_status.label }}</label>
                        {{ form.installation_status }}
                        {% if form.installation_status.errors %}
                        <div class="error-text">{{ form.installation_status.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Секция материалов -->
            <div class="form-section">
                <div class="section-header">
                    <h6 class="section-title">🔧 Комплектующие</h6>
                    <button type="button" id="add-more" class="btn-modern btn-outline">
                        <i class="bi bi-plus-circle"></i>
                        Добавить материал
                    </button>
                </div>

                {{ formset.management_form }}

                <div class="table-responsive">
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th style="width: 45%">Материал</th>
                                <th style="width: 20%">Количество</th>
                                <th style="width: 20%">Цена за единицу</th>
                                <th style="width: 15%">Действия</th>
                            </tr>
                        </thead>
                        <tbody id="materials-tbody">
                            {% for form in formset %}
                            <tr class="material-form">
                                <td>{{ form.material }}</td>
                                <td>{{ form.quantity }}</td>
                                <td class="price-cell" data-material-id="{{ form.material.value }}">
                                    {% if form.material.value %}
                                    <span class="price-placeholder">{{ form.material.value|get_material_price }} руб.</span>
                                    {% else %}
                                    <span class="text-muted">---</span>
                                    {% endif %}
                                </td>
                                <td class="actions-cell">
                                    {% if form.DELETE %}
                                    <label class="delete-checkbox">
                                        {{ form.DELETE }}
                                        <span class="delete-label">Удалить</span>
                                    </label>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Итоговая цена -->
            <div class="total-section">
                <div class="total-card">
                    <div class="total-header">
                        <span class="total-label">💰 Итоговая стоимость заказа:</span>
                        <span id="total-price" class="total-amount">0 руб.</span>
                    </div>
                    <div class="total-formula">
                        <small>(Стоимость материалов × 2 × (1 - скидка/100))</small>
                    </div>
                </div>
            </div>

            <!-- Кнопки отправки -->
            <div class="form-actions">
                <button type="submit" class="btn-modern btn-primary">
                    <i class="bi bi-check-circle"></i>
                    Создать заказ
                </button>
                <a href="{% url 'orders:order_list' %}" class="btn-modern btn-outline">
                    <i class="bi bi-arrow-left"></i>
                    Отмена
                </a>
            </div>
        </form>
    </div>
</div>

<style>
.dashboard-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.page-header {
    text-align: center;
    margin-bottom: 30px;
}

.page-header h1 {
    color: #2c3e50;
    font-weight: 700;
    font-size: 2.5rem;
    margin-bottom: 10px;
}

.page-header p {
    color: #6b7280;
    font-size: 1.2rem;
}

.card-modern {
    background: white;
    border-radius: 16px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.08);
    border: none;
    overflow: hidden;
}

.card-modern-header {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    padding: 20px 25px;
    border-bottom: 1px solid #e2e8f0;
}

.card-modern-title {
    color: #2c3e50;
    font-weight: 600;
    margin: 0;
    font-size: 1.3rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

.form-section {
    padding: 25px;
    border-bottom: 1px solid #f1f5f9;
}

.form-section:last-of-type {
    border-bottom: none;
}

.section-title {
    color: #2c3e50;
    font-weight: 600;
    margin-bottom: 20px;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    gap: 8px;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
}

.form-group {
    margin-bottom: 0;
}

.form-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #2c3e50;
    font-size: 0.9rem;
}

.form-control {
    width: 100%;
    padding: 12px;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    font-size: 14px;
    transition: all 0.3s;
    background: white;
}

.form-control:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.error-text {
    color: #dc2626;
    font-size: 0.8rem;
    margin-top: 5px;
}

/* Стили для таблицы материалов */
.modern-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 12px;
    overflow: hidden;
}

.modern-table thead {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.modern-table th {
    color: white;
    font-weight: 600;
    padding: 15px 12px;
    text-align: left;
    border: none;
    font-size: 0.9rem;
}

.modern-table tbody tr {
    border-bottom: 1px solid #f1f5f9;
    transition: background-color 0.3s;
}

.modern-table tbody tr:hover {
    background-color: #f8fafc;
}

.modern-table td {
    padding: 12px;
    vertical-align: middle;
    border: none;
}

.price-cell {
    font-family: 'Courier New', monospace;
    font-weight: 600;
    color: #059669;
}

.actions-cell {
    text-align: center;
}

.delete-checkbox {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    font-size: 0.8rem;
    color: #6b7280;
}

.delete-checkbox input[type="checkbox"] {
    width: 16px;
    height: 16px;
}

.delete-label {
    transition: color 0.3s;
}

.delete-checkbox:hover .delete-label {
    color: #dc2626;
}

/* Стили для кнопок */
.btn-modern {
    border: none;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.btn-primary:hover {
    background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.btn-outline {
    background: transparent;
    border: 2px solid #667eea;
    color: #667eea;
}

.btn-outline:hover {
    background: #667eea;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

/* Стили для итоговой цены */
.total-section {
    padding: 25px;
    background: #f8fafc;
    border-radius: 12px;
    margin: 25px;
}

.total-card {
    text-align: center;
}

.total-header {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 15px;
    margin-bottom: 10px;
}

.total-label {
    font-size: 1.2rem;
    font-weight: 600;
    color: #2c3e50;
}

.total-amount {
    font-size: 1.5rem;
    font-weight: 700;
    color: #059669;
    font-family: 'Courier New', monospace;
}

.total-formula {
    color: #6b7280;
    font-size: 0.9rem;
}

/* Стили для действий формы */
.form-actions {
    display: flex;
    gap: 15px;
    justify-content: center;
    padding: 25px;
    border-top: 1px solid #f1f5f9;
}

/* Анимации */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.card-modern {
    animation: fadeInUp 0.6s ease-out;
}

/* Адаптивность */
@media (max-width: 768px) {
    .dashboard-container {
        padding: 15px;
    }

    .page-header h1 {
        font-size: 2rem;
    }

    .form-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }

    .section-header {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
    }

    .form-actions {
        flex-direction: column;
    }

    .btn-modern {
        width: 100%;
        justify-content: center;
    }

    .modern-table {
        font-size: 0.8rem;
    }

    .modern-table th,
    .modern-table td {
        padding: 8px 6px;
    }

    .total-header {
        flex-direction: column;
        gap: 10px;
    }
}

@media (max-width: 480px) {
    .dashboard-container {
        padding: 10px;
    }

    .page-header h1 {
        font-size: 1.8rem;
    }

    .form-section {
        padding: 20px;
    }

    .modern-table {
        font-size: 0.75rem;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const materialPrices = JSON.parse('{{ material_prices_json|escapejs }}');
    const totalFormsInput = document.getElementById('id_items-TOTAL_FORMS');
    let formCount = parseInt(totalFormsInput.value);

    // Функция для добавления нового ряда материалов
    document.getElementById('add-more').addEventListener('click', function() {
        const formRow = document.querySelector('.material-form');
        if (!formRow) return;

        const newRow = formRow.cloneNode(true);
        const newRowHtml = newRow.innerHTML.replace(
            /items-\d+-/g,
            `items-${formCount}-`
        );
        newRow.innerHTML = newRowHtml;

        // Очищаем значения в новом ряду
        newRow.querySelectorAll('input, select').forEach(function(input) {
            if (input.name.includes('material') || input.name.includes('quantity')) {
                input.value = '';
            }
            if (input.type === 'checkbox' && input.name.includes('DELETE')) {
                input.checked = false;
            }
        });

        // Сбрасываем цену
        const priceCell = newRow.querySelector('.price-cell');
        priceCell.innerHTML = '<span class="text-muted">---</span>';
        priceCell.dataset.materialId = '';
        priceCell.dataset.price = '0';

        // Добавляем новый ряд в таблицу
        document.getElementById('materials-tbody').appendChild(newRow);
        formCount++;
        totalFormsInput.value = formCount;

        // Добавляем обработчики событий для нового ряда
        addEventListenersToRow(newRow);
    });

    // Функция для добавления обработчиков событий к ряду
    function addEventListenersToRow(row) {
        const materialSelect = row.querySelector('select[name*="-material"]');
        const quantityInput = row.querySelector('input[name*="-quantity"]');

        if (materialSelect) {
            materialSelect.addEventListener('change', function() {
                updateRowPrice(row);
            });
        }

        if (quantityInput) {
            quantityInput.addEventListener('input', updateTotal);
        }
    }

    // Функция для обновления цены в ряду
    function updateRowPrice(row) {
        const materialSelect = row.querySelector('select[name*="-material"]');
        const priceCell = row.querySelector('.price-cell');

        if (materialSelect && materialSelect.value) {
            const price = materialPrices[materialSelect.value] || '0.00';
            priceCell.innerHTML = `<span class="price-placeholder">${price} руб.</span>`;
            priceCell.dataset.price = price;
            priceCell.dataset.materialId = materialSelect.value;
            updateTotal();
        } else {
            priceCell.innerHTML = '<span class="text-muted">---</span>';
            priceCell.dataset.price = '0';
            updateTotal();
        }
    }

    // Функция для обновления общей стоимости
    function updateTotal() {
        let materialsTotal = 0;

        document.querySelectorAll('tr.material-form').forEach(row => {
            const priceCell = row.querySelector('.price-cell');
            const quantityInput = row.querySelector('input[name*="-quantity"]');

            if (priceCell && quantityInput) {
                const price = parseFloat(priceCell.dataset.price || 0);
                const quantity = parseFloat(quantityInput.value || 0);
                materialsTotal += price * quantity;
            }
        });

        const discountInput = document.getElementById('{{ form.discount.id_for_label }}');
        const discount = parseFloat(discountInput.value || 0);
        const totalPrice = materialsTotal * 2 * (1 - discount / 100);

        document.getElementById('total-price').textContent = totalPrice.toFixed(2) + ' руб.';
    }

    // Инициализация обработчиков событий для существующих рядов
    document.querySelectorAll('tr.material-form').forEach(row => {
        addEventListenersToRow(row);
        updateRowPrice(row);
    });

    // Обработчик для поля скидки
    const discountInput = document.getElementById('{{ form.discount.id_for_label }}');
    if (discountInput) {
        discountInput.addEventListener('input', updateTotal);
    }

    // Инициализация общей стоимости
    updateTotal();

    // Обработчик отправки формы для удаления пустых строк
    document.querySelector('form.order-form').addEventListener('submit', function(e) {
        const materialRows = document.querySelectorAll('tr.material-form');

        materialRows.forEach(row => {
            const materialSelect = row.querySelector('select[name*="-material"]');
            const quantityInput = row.querySelector('input[name*="-quantity"]');

            // Если оба поля пустые, скрываем строку
            if ((!materialSelect || !materialSelect.value) &&
                (!quantityInput || !quantityInput.value || quantityInput.value === '0' || quantityInput.value === '')) {
                row.style.display = 'none';

                // Добавляем скрытое поле DELETE
                const deleteInput = document.createElement('input');
                deleteInput.type = 'hidden';
                deleteInput.name = materialSelect.name.replace('-material', '-DELETE');
                deleteInput.value = 'on';
                row.appendChild(deleteInput);
            }
        });
    });
});
</script>
{% endblock %}


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\orders\templates\orders\order\created.html
============================================================


{% extends "mebel/base.html" %}

{% block title %}
  Thank you
{% endblock %}

{% block content %}
  <h1>Thank you</h1>
  <p>Your order has been successfully completed. Your order number is
  <strong>{{ order.id }}</strong>.</p>
{% endblock %}


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\orders\templates\orders\order\detail.html
============================================================

{% extends "mebel/base.html" %}
{% load static %}
{% load order_extras %}
{% block title %}Заказ #{{ order.id }}{% endblock %}

{% block extra_css %}
<style>
/* Стили для модального окна просмотра изображений */
.image-modal {
    display: none;
    position: fixed;
    z-index: 1050;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.9);
    overflow: auto;
}

.image-modal-content {
    margin: auto;
    display: block;
    max-width: 90%;
    max-height: 90%;
    margin-top: 2%;
    animation: zoom 0.3s;
}

@keyframes zoom {
    from {transform: scale(0.8); opacity: 0;}
    to {transform: scale(1); opacity: 1;}
}

.close-modal {
    position: absolute;
    top: 15px;
    right: 35px;
    color: #fff;
    font-size: 40px;
    font-weight: bold;
    cursor: pointer;
    z-index: 1060;
}

.close-modal:hover {
    color: #ccc;
}

.image-controls {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1060;
}

.download-btn {
    background-color: #007bff;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    transition: background-color 0.3s;
}

.download-btn:hover {
    background-color: #0056b3;
}

.image-card {
    position: relative;
    cursor: pointer;
    transition: transform 0.3s;
}

.image-card:hover {
    transform: scale(1.02);
}

.image-card img {
    transition: opacity 0.3s;
}

.image-card:hover img {
    opacity: 0.9;
}

.image-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s;
}

.image-card:hover .image-overlay {
    opacity: 1;
}

.zoom-icon {
    color: white;
    font-size: 2rem;
    background: rgba(0, 0, 0, 0.7);
    border-radius: 50%;
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
}
</style>
{% endblock %}

{% block content %}
<!-- Блок с изображениями - ОБНОВЛЕНО -->
<div class="row mb-4">
    <div class="col-md-4">
        {% if order.blueprint %}
        <div class="card image-card" onclick="openImageModal('{{ order.blueprint.url }}', 'Чертеж заказа #{{ order.id }}')">
            <div class="card-header">
                <h6 class="card-title mb-0">📐 Чертеж</h6>
            </div>
            <div class="card-body text-center position-relative">
                <img src="{{ order.blueprint.url }}" class="img-fluid rounded" alt="Чертеж" style="max-height: 200px;">
                <div class="image-overlay">
                    <div class="zoom-icon">
                        <i class="bi bi-search"></i>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    <div class="col-md-4">
        {% if order.visualization %}
        <div class="card image-card" onclick="openImageModal('{{ order.visualization.url }}', 'Визуализация заказа #{{ order.id }}')">
            <div class="card-header">
                <h6 class="card-title mb-0">🎨 Визуализация</h6>
            </div>
            <div class="card-body text-center position-relative">
                <img src="{{ order.visualization.url }}" class="img-fluid rounded" alt="Визуализация" style="max-height: 200px;">
                <div class="image-overlay">
                    <div class="zoom-icon">
                        <i class="bi bi-search"></i>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    <div class="col-md-4">
        {% if order.installation_photo %}
        <div class="card image-card" onclick="openImageModal('{{ order.installation_photo.url }}', 'Фото установки заказа #{{ order.id }}')">
            <div class="card-header">
                <h6 class="card-title mb-0">📸 Фото установки</h6>
            </div>
            <div class="card-body text-center position-relative">
                <img src="{{ order.installation_photo.url }}" class="img-fluid rounded" alt="Фото установки" style="max-height: 200px;">
                <div class="image-overlay">
                    <div class="zoom-icon">
                        <i class="bi bi-search"></i>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">📸 Фото установки</h6>
            </div>
            <div class="card-body text-center text-muted">
                <i class="bi bi-camera" style="font-size: 3rem;"></i>
                <p class="mt-2 mb-0">Фото установки не добавлено</p>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<div class="container mt-4">
  <!-- Заголовок с кнопками действий -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Заказ #{{ order.id }}</h1>
    <div>
        {% if user.groups.all.0.name == 'Менеджеры' or user.is_superuser %}
            <a href="{% url 'orders:order_edit' order.id %}" class="btn btn-warning me-2">
                <i class="bi bi-pencil"></i> Редактировать заказ
            </a>
        {% endif %}

        {% if user.groups.all.0.name == 'Отдел МТО' or user.is_superuser %}
            {% if order.items.exists %}
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#writeOffModal">
                <i class="bi bi-box-arrow-right"></i> Списать материалы
            </button>
            {% endif %}
        {% endif %}
    </div>
  </div>

  <!-- Сообщения об успехе/ошибках -->
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}

  <!-- Информация о заказе -->
    <div class="row">
        <div class="col-md-6">
            <p><strong>Название:</strong><br>{{ order.order_name }}</p>
            <p><strong>Имя заказчика:</strong><br>{{ order.customer_name }}</p>
            <p><strong>Категория:</strong><br>{{ order.get_category_display }}</p>
        </div>
        <div class="col-md-6">
            <p><strong>Адрес:</strong><br>{{ order.address }}</p>
            <p><strong>Перечисленные средства:</strong><br>{{ order.transferred_amount }} руб.</p>
            <p><strong>Скидка:</strong><br>{{ order.discount }}%</p>
        </div>
    </div>

    <div class="col-md-6">
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title mb-0">📊 Статус заказа</h5>
        </div>
        <div class="card-body">
          <p><strong>Дата создания:</strong> {{ order.created|date:"d.m.Y H:i" }}</p>
          <p><strong>Последнее обновление:</strong> {{ order.updated|date:"d.m.Y H:i" }}</p>
          <p>
            <strong>Статус оплаты:</strong>
            <span class="badge
              {% if order.paid == 'fully_paid' %}bg-success
              {% elif order.paid == 'partially_paid' %}bg-warning
              {% else %}bg-danger{% endif %}">
              {{ order.get_paid_display }}
            </span>
          </p>
                <p>
                    <strong>Статус установки:</strong>
                    <span class="badge
                    {% if order.installation_status == 'installed' %}bg-success
                    {% else %}bg-secondary{% endif %}">
                        {{ order.get_installation_status_display }}
                    </span>
                </p>
                <p>
                    <strong>Завершено:</strong>
                    <span class="badge
                    {% if order.is_completed %}bg-success
                    {% else %}bg-secondary{% endif %}">
                        {% if order.is_completed %}Да{% else %}Нет{% endif %}
                    </span>
                </p>
          <p><strong>ID заказа:</strong> {{ order.id }}</p>
        </div>
      </div>
    </div>
        <!-- Добавляем после блока с статусом оплаты -->
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">📅 Сроки выполнения</h5>
            </div>
            <div class="card-body">
                <p><strong>Дата сдачи:</strong> {{ order.deadline|date:"d.m.Y" }}</p>
                <p>
                    <strong>Статус:</strong>
                    {% with deadline_status=order.get_deadline_status %}
                    <span class="badge bg-{{ deadline_status.class }}">
                        {{ deadline_status.icon }} {{ deadline_status.status }}
                    </span>
                    {% endwith %}
                </p>
                {% with days_until=order.deadline|timeuntil %}
                <p><strong>Осталось:</strong> {{ days_until }}</p>
                {% endwith %}
            </div>
        </div>
    </div>
  </div>

  <!-- Позиции заказа -->
  <div class="card mb-4">
      <div class="card-header">
          <h5 class="card-title mb-0">📦 Позиции заказа</h5>
      </div>
      <div class="card-body">
          <div class="table-responsive">
              <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Материал</th>
                            <th class="text-center">Цена за шт.</th>
                            <th class="text-center">Количество по заказу</th>
                            <th class="text-center">Зарезервировано</th>
                            <th class="text-center">Баланс на складе</th>
                            <th class="text-center">Списано</th>
                            <th class="text-end">Стоимость</th>
                        </tr>
                    </thead>
                  <tbody>
                      {% for item in order.items.all %}
                        <tr>
                            <td>
                                <strong>{{ item.material.name }}</strong>
                                <br>
                                <small class="text-muted">Категория: {{ item.material.category.name }}</small>
                            </td>
                            <td class="text-center">{{ item.price }} руб.</td>
                            <td class="text-center">{{ item.quantity }} шт.</td>
                            <td class="text-center">
                                <span class="badge bg-info">
                                    {{ item.material.reserved }} шт.
                                </span>
                            </td>
                            <td class="text-center">
                                <span class="badge {% if item.material.balance > 0 %}bg-success{% else %}bg-danger{% endif %}">
                                    {{ item.material.balance }} шт.
                                </span>
                            </td>
                            <td class="text-center">
                                <span class="badge {% if item.written_off > 0 %}bg-success{% else %}bg-secondary{% endif %}">
                                    {{ item.written_off }} шт. (остаток: {{ item.quantity|subtract:item.written_off }} шт.)
                                </span>
                            </td>
                            <td class="text-end"><strong>{{ item.get_cost }} руб.</strong></td>
                        </tr>
                      {% empty %}
                      <tr>
                          <td colspan="7" class="text-center text-muted py-4"> <!-- Изменили colspan на 7 -->
                              В заказе нет позиций
                          </td>
                      </tr>
                      {% endfor %}
                  </tbody>
                  <tfoot class="table-group-divider">
                      <tr>
                          <td colspan="6" class="text-end"><strong>Общая стоимость:</strong></td> <!-- Изменили colspan на 6 -->
                          <td class="text-end"><strong class="fs-5">{{ order.get_total_cost }} руб.</strong></td>
                      </tr>
                  </tfoot>
              </table>
          </div>
      </div>
  </div>

  <!-- Кнопка возврата -->
  <div class="d-flex justify-content-between">
    <a href="{% url 'orders:order_list' %}" class="btn btn-secondary">
      <i class="bi bi-arrow-left"></i> Вернуться к списку заказов
    </a>
  </div>
</div>

<!-- Модальное окно для просмотра изображений -->
<div id="imageModal" class="image-modal">
    <span class="close-modal" onclick="closeImageModal()">&times;</span>
    <img class="image-modal-content" id="modalImage">
    <div class="image-controls">
        <button class="download-btn" onclick="downloadImage()">
            <i class="bi bi-download"></i> Скачать изображение
        </button>
    </div>
</div>

  <!-- Модальное окно -->
  {% with modal_id="writeOffModal" modal_size="modal-xl" modal_ajax_url=order.get_write_off_url %}
  {% include "includes/modal.html" %}
  {% endwith %}

  <style>
    .card {
      box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
      border: 1px solid rgba(0, 0, 0, 0.125);
    }
    .card-header {
      background-color: #f8f9fa;
      border-bottom: 1px solid rgba(0, 0, 0, 0.125);
    }
    .table th {
      font-weight: 600;
      background-color: #f8f9fa;
    }
    .badge {
      font-size: 0.85em;
    }
    .alert {
      margin-bottom: 20px;
    }
  </style>
{% endblock %}

{% block domready %}
<!-- JS для загрузки контента в модальное окно -->
<script>

        // Переменные для хранения текущего изображения
    let currentImageUrl = '';
    let currentImageTitle = '';

    // Функция открытия модального окна с изображением
    function openImageModal(imageUrl, imageTitle) {
        currentImageUrl = imageUrl;
        currentImageTitle = imageTitle;

        const modal = document.getElementById('imageModal');
        const modalImg = document.getElementById('modalImage');

        modal.style.display = 'block';
        modalImg.src = imageUrl;
        modalImg.alt = imageTitle;

        // Блокируем прокрутку фоновой страницы
        document.body.style.overflow = 'hidden';
    }

    // Функция закрытия модального окна
    function closeImageModal() {
        const modal = document.getElementById('imageModal');
        modal.style.display = 'none';

        // Восстанавливаем прокрутку страницы
        document.body.style.overflow = 'auto';
    }

    // Функция скачивания изображения
    function downloadImage() {
        if (!currentImageUrl) return;

        // Создаем временную ссылку для скачивания
        const link = document.createElement('a');
        link.href = currentImageUrl;

        // Извлекаем имя файла из URL
        const fileName = currentImageUrl.split('/').pop() || 'image';
        link.download = fileName;

        // Программно кликаем по ссылке
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // Закрытие модального окна при клике вне изображения
    document.getElementById('imageModal').addEventListener('click', function(event) {
        if (event.target === this) {
            closeImageModal();
        }
    });

    // Закрытие модального окна клавишей ESC
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeImageModal();
        }
    });

    $(document).ready(function(){
        $('#writeOffModal').on('show.bs.modal', function (event) {
            var modal = $(this);
            // Загружаем форму списания в модальное окно
            $.ajax({
                url: "{% url 'orders:order_write_off' order.id %}",
                context: document.body,
                success: function(response) {
                    modal.find('.modal-content').html(response);
                },
                error: function() {
                    modal.find('.modal-content').html(
                        '<div class="modal-header">' +
                        '<h5 class="modal-title">Ошибка</h5>' +
                        '<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>' +
                        '</div>' +
                        '<div class="modal-body">' +
                        '<p class="text-danger">Не удалось загрузить форму списания.</p>' +
                        '</div>'
                    );
                }
            });
        });

        // Обновление страницы после закрытия модального окна
        $('#writeOffModal').on('hidden.bs.modal', function () {
            // Перезагружаем страницу для обновления данных
            location.reload();
        });
    });
</script>
{% endblock %}


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\orders\templates\orders\order\edit.html
============================================================

{% extends "mebel/base.html" %}
{% load static %}
{% load order_extras %}

{% block title %}Редактировать заказ #{{ order.id }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>Редактировать заказ #{{ order.id }}</h1>

    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <!-- В разделе "Загрузка изображений" добавим: -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="form-group">
                    <label class="form-label">{{ form.blueprint.label }}</label>
                    {{ form.blueprint }}
                    {% if form.blueprint.errors %}
                    <div class="text-danger small">{{ form.blueprint.errors }}</div>
                    {% endif %}
                    {% if order.blueprint %}
                    <div class="mt-2">
                        <small>Текущий файл: <a href="{{ order.blueprint.url }}" target="_blank">{{ order.blueprint.name }}</a></small>
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label class="form-label">{{ form.visualization.label }}</label>
                    {{ form.visualization }}
                    {% if form.visualization.errors %}
                    <div class="text-danger small">{{ form.visualization.errors }}</div>
                    {% endif %}
                    {% if order.visualization %}
                    <div class="mt-2">
                        <small>Текущий файл: <a href="{{ order.visualization.url }}" target="_blank">{{ order.visualization.name }}</a></small>
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label class="form-label">{{ form.installation_photo.label }}</label>
                    {{ form.installation_photo }}
                    {% if form.installation_photo.errors %}
                    <div class="text-danger small">{{ form.installation_photo.errors }}</div>
                    {% endif %}
                    {% if order.installation_photo %}
                    <div class="mt-2">
                        <small>Текущий файл: <a href="{{ order.installation_photo.url }}" target="_blank">{{ order.installation_photo.name }}</a></small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Информация о заказе -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">📋 Информация о заказе</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">{{ form.order_name.label }}</label>
                            {{ form.order_name }}
                            {% if form.order_name.errors %}
                            <div class="text-danger small">{{ form.order_name.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            <label class="form-label">{{ form.customer_name.label }}</label>
                            {{ form.customer_name }}
                            {% if form.customer_name.errors %}
                            <div class="text-danger small">{{ form.customer_name.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            <label class="form-label">{{ form.address.label }}</label>
                            {{ form.address }}
                            {% if form.address.errors %}
                            <div class="text-danger small">{{ form.address.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">{{ form.transferred_amount.label }}</label>
                            {{ form.transferred_amount }}
                            {% if form.transferred_amount.errors %}
                            <div class="text-danger small">{{ form.transferred_amount.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.deadline.id_for_label }}">{{ form.deadline.label }}</label>
                            {{ form.deadline }}
                            {% if form.deadline.errors %}
                                <div class="text-danger small">{{ form.deadline.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            <label class="form-label">{{ form.discount.label }}</label>
                            {{ form.discount }}
                            {% if form.discount.errors %}
                            <div class="text-danger small">{{ form.discount.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.installation_status.id_for_label }}">{{ form.installation_status.label }}</label>
                            {{ form.installation_status }}
                            {% if form.installation_status.errors %}
                                <div class="text-danger small">{{ form.installation_status.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            <label class="form-label">{{ form.category.label }}</label>
                            {{ form.category }}
                            {% if form.category.errors %}
                            <div class="text-danger small">{{ form.category.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Блок с общей стоимостью заказа -->
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>Полная стоимость заказа:</strong>
                                    <span id="total-price-display">{{ order.get_total_cost }} руб.</span>
                                    <br>
                                    <small class="text-muted">
                                        (Стоимость материалов × 2 × (1 - скидка/100))
                                    </small>
                                </div>
                                <div class="text-end">
                                    <small>
                                        <strong>Перечисленные средства:</strong> {{ order.transferred_amount }} руб.<br>
                                        <strong>Статус оплаты:</strong>
                                        <span class="badge
                                            {% if order.paid == 'fully_paid' %}bg-success
                                            {% elif order.paid == 'partially_paid' %}bg-warning
                                            {% else %}bg-danger{% endif %}">
                                            {{ order.get_paid_display }}
                                        </span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Материалы в заказе -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">📦 Материалы в заказе</h5>
            </div>
            <div class="card-body">
                {{ formset.management_form }}

                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Материал</th>
                                <th>Количество</th>
                                <th>Цена за шт.</th>
                                <th>Стоимость</th>
                                <th class="text-center">Удалить</th>
                            </tr>
                        </thead>
                        <tbody id="formset-tbody">
                            {% for form in formset %}
                            <tr class="form-row">
                                <td>
                                    {{ form.id }}
                                    <div class="mb-2">
                                        {{ form.material }}
                                        {% if form.material.errors %}
                                        <div class="text-danger small">{{ form.material.errors }}</div>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    <div class="mb-2">
                                        {{ form.quantity }}
                                        {% if form.quantity.errors %}
                                        <div class="text-danger small">{{ form.quantity.errors }}</div>
                                        {% endif %}
                                    </div>
                                </td>
                                <td class="price-cell" data-material-id="{{ form.material.value }}">
                                    {% if form.material.value %}
                                    <span class="price-placeholder">{{ form.material.value|get_material_price }} руб.</span>
                                    {% else %}
                                    ---
                                    {% endif %}
                                </td>
                                <td class="item-cost">
                                    {% if form.material.value and form.quantity.value %}
                                    <span class="calculated-cost">---</span>
                                    {% else %}
                                    ---
                                    {% endif %}
                                </td>
                                <td class="text-center align-middle">
                                    {% if form.instance.pk %}
                                    <div class="form-check form-switch">
                                        {{ form.DELETE }}
                                        <label class="form-check-label" for="{{ form.DELETE.id_for_label }}"></label>
                                    </div>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="table-group-divider">
                            <tr>
                                <td colspan="3" class="text-end"><strong>Общая стоимость материалов:</strong></td>
                                <td><strong id="materials-total">0 руб.</strong></td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <button type="button" id="add-form" class="btn btn-success mt-3">
                    + Добавить материал
                </button>

                <div class="text-muted small">
                    <i class="bi bi-info-circle"></i> Для удаления позиции отметьте checkbox "Удалить"
                </div>
            </div>
        </div>

        <!-- Кнопки действий -->
        <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-check-lg"></i> Сохранить изменения
            </button>
            <a href="{% url 'orders:order_detail' order.id %}" class="btn btn-secondary">
                <i class="bi bi-x-lg"></i> Отмена
            </a>
        </div>
    </form>
</div>

<style>
.form-control, .form-select {
    border-radius: 0.375rem;
    border: 1px solid #ced4da;
    padding: 0.375rem 0.75rem;
}

.form-control:focus, .form-select:focus {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.table td {
    vertical-align: middle;
}

.form-row {
    transition: all 0.3s ease;
}

.btn-success {
    background-color: #28a745;
    border-color: #28a745;
}

.btn-success:hover {
    background-color: #218838;
    border-color: #1e7e34;
}

.form-check-input {
    width: 2.5em;
    height: 1.25em;
}

.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    border: 1px solid rgba(0, 0, 0, 0.125);
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid rgba(0, 0, 0, 0.125);
}

.alert-info {
    background-color: #d1ecf1;
    border-color: #bee5eb;
    color: #0c5460;
}
</style>
{% endblock %}

{% block domready %}
<script>
$(document).ready(function() {
    // Добавляем классы Bootstrap к элементам формы
    $('input, select, textarea').addClass('form-control');
    $('select').addClass('form-select');

    // Специальная обработка для checkbox удаления
    $('input[type="checkbox"]').removeClass('form-control').addClass('form-check-input');

    // Добавляем placeholder для полей
    $('input[name*="order_name"]').attr('placeholder', 'Введите название заказа');
    $('input[name*="customer_name"]').attr('placeholder', 'Введите имя заказчика');
    $('input[name*="address"]').attr('placeholder', 'Введите адрес');
    $('input[name*="transferred_amount"]').attr('placeholder', 'Введите сумму');
    $('input[name*="discount"]').attr('placeholder', '0');

    // Функция для обновления общей стоимости
    function updateTotalCost() {
        let materialsTotal = 0;

        // Считаем общую стоимость материалов
        $('.form-row').each(function() {
            const priceCell = $(this).find('.price-cell');
            const quantityInput = $(this).find('input[name*="-quantity"]');
            const deleteCheckbox = $(this).find('input[type="checkbox"][name*="-DELETE"]');
            const costCell = $(this).find('.calculated-cost');

            // Пропускаем удаленные строки
            if (deleteCheckbox.length > 0 && deleteCheckbox.is(':checked')) {
                costCell.text('---');
                return;
            }

            if (priceCell.length && quantityInput.length) {
                const priceText = priceCell.find('.price-placeholder').text();
                const price = parseFloat(priceText) || 0;
                const quantity = parseFloat(quantityInput.val()) || 0;
                const itemCost = price * quantity;

                materialsTotal += itemCost;

                // Обновляем стоимость для текущей строки
                costCell.text(itemCost.toFixed(2) + ' руб.');
            } else {
                costCell.text('---');
            }
        });

        // Обновляем общую стоимость материалов
        $('#materials-total').text(materialsTotal.toFixed(2) + ' руб.');

        // Получаем значение скидки
        const discountInput = $('input[name*="discount"]');
        const discount = parseFloat(discountInput.val()) || 0;

        // Рассчитываем итоговую стоимость: материалы * 2 * (1 - discount/100)
        const totalPrice = materialsTotal * 2 * (1 - discount / 100);

        // Обновляем отображение полной стоимости
        $('#total-price-display').text(totalPrice.toFixed(2) + ' руб.');
    }

    // Обработчики событий для обновления стоимости
    $('select[name*="-material"]').on('change', function() {
        const materialId = $(this).val();
        const priceCell = $(this).closest('tr').find('.price-cell');

        if (materialId) {
            // Используем текст из выбранного option
            const selectedOption = $(this).find('option:selected');
            const priceText = selectedOption.text().match(/\d+\.?\d*/);
            const price = priceText ? parseFloat(priceText[0]) : 0;

            priceCell.find('.price-placeholder').text(price.toFixed(2) + ' руб.');
        } else {
            priceCell.find('.price-placeholder').text('---');
        }

        updateTotalCost();
    });

    $('input[name*="-quantity"]').on('input', updateTotalCost);
    $('input[name*="discount"]').on('input', updateTotalCost);
    $('input[type="checkbox"][name*="-DELETE"]').on('change', updateTotalCost);

    // Код для добавления новой формы
    $('#add-form').on('click', function() {
        const totalForms = $('#id_items-TOTAL_FORMS');
        const formNum = parseInt(totalForms.val());
        const formRows = $('.form-row');

        if (formRows.length === 0) return;

        const lastFormRow = formRows.last();
        const newFormRow = lastFormRow.clone();

        // Заменяем индексы в именах полей
        newFormRow.html(newFormRow.html().replace(/items-\d+-/g, `items-${formNum}-`));
        newFormRow.html(newFormRow.html().replace(/\[\d+\]/g, `[${formNum}]`));

        // Очищаем значения полей
        newFormRow.find('input, select, textarea').each(function() {
            if ($(this).attr('type') !== 'hidden') {
                $(this).val('');
            } else {
                // Очищаем скрытые поля id
                if ($(this).attr('name').includes('id')) {
                    $(this).val('');
                }
            }
        });

        // Очищаем ячейки с ценой и стоимостью
        newFormRow.find('.price-cell').html('<span class="price-placeholder">---</span>');
        newFormRow.find('.item-cost').html('<span class="calculated-cost">---</span>');

        // Удаляем чекбокс удаления для новых форм
        const deleteCell = newFormRow.find('td:last-child');
        if (deleteCell.find('input[type="checkbox"]').length) {
            deleteCell.html('<span class="text-muted">-</span>');
        }

        // Вставляем новую строку
        $('#formset-tbody').append(newFormRow);

        // Увеличиваем счетчик форм
        totalForms.val(formNum + 1);

        // Перепривязываем обработчики для новых элементов
        $('input, select, textarea').addClass('form-control');
        $('select').addClass('form-select');
        $('input[type="checkbox"]').removeClass('form-control').addClass('form-check-input');

        // Добавляем обработчики для новой строки
        newFormRow.find('select[name*="-material"]').on('change', function() {
            const materialId = $(this).val();
            const priceCell = $(this).closest('tr').find('.price-cell');

            if (materialId) {
                const selectedOption = $(this).find('option:selected');
                const priceText = selectedOption.text().match(/\d+\.?\d*/);
                const price = priceText ? parseFloat(priceText[0]) : 0;

                priceCell.find('.price-placeholder').text(price.toFixed(2) + ' руб.');
            } else {
                priceCell.find('.price-placeholder').text('---');
            }

            updateTotalCost();
        });

        newFormRow.find('input[name*="-quantity"]').on('input', updateTotalCost);
    });

    // Инициализация при загрузке
    updateTotalCost();
});
</script>
{% endblock %}


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\orders\templates\orders\order\list.html
============================================================

{% extends "mebel/base.html" %}
{% load static %}

{% block title %}Список заказов{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
/* Основные стили контейнера */
.dashboard-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}

.page-header {
    text-align: center;
    margin-bottom: 30px;
}

.page-header h1 {
    color: #2c3e50;
    font-weight: 700;
    font-size: 2.5rem;
    margin-bottom: 10px;
}

.page-header p {
    color: #6b7280;
    font-size: 1.2rem;
}

/* Стили для карточек */
.card-modern {
    background: white;
    border-radius: 16px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.08);
    border: none;
    overflow: hidden;
    margin-bottom: 25px;
}

.card-modern-header {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    padding: 20px 25px;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.card-modern-title {
    color: #2c3e50;
    font-weight: 600;
    margin: 0;
    font-size: 1.3rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

/* Сетка для графика и таблицы */
.dashboard-grid {
    display: grid;
    grid-template-columns: 350px 1fr;
    gap: 25px;
    margin-bottom: 30px;
}

/* Стили для графика */
.chart-card {
    height: fit-content;
}

.chart-container {
    position: relative;
    height: 280px;
    width: 100%;
}

/* Стили для таблицы */
.table-card {
    min-height: 500px;
}

.table-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.btn-modern {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
}

.btn-modern:hover {
    background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    color: white;
    text-decoration: none;
}

/* Стили для таблицы */
.order-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 12px;
    overflow: hidden;
    font-size: 0.85rem;
}

.order-table thead {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.order-table th {
    color: white;
    font-weight: 600;
    padding: 15px 12px;
    text-align: left;
    border: none;
    font-size: 0.9rem;
    white-space: nowrap;
    position: relative;
}

.order-table th a.sort-link {
    color: white !important;
    text-decoration: none;
    display: block;
    padding: 2px 0;
    transition: opacity 0.3s;
}

.order-table th a.sort-link:hover {
    opacity: 0.8;
    text-decoration: underline;
}

.order-table tbody tr {
    border-bottom: 1px solid #f1f5f9;
    transition: all 0.3s;
    cursor: pointer;
}

.order-table tbody tr:hover {
    background-color: #f8fafc;
    transform: translateX(5px);
}

.order-table tbody tr.completed-order {
    background-color: #f0f9f0;
    border-left: 4px solid #10b981;
}

.order-table td {
    padding: 12px;
    vertical-align: middle;
    border: none;
}

/* Стили для статусов оплаты */
.paid-status {
    font-weight: bold;
    padding: 6px 10px;
    border-radius: 20px;
    font-size: 0.75rem;
    white-space: nowrap;
    display: inline-block;
    text-align: center;
    min-width: 60px;
}

.paid-fully {
    background: #d1fae5;
    color: #065f46;
    border: 1px solid #a7f3d0;
}

.paid-partially {
    background: #fef3c7;
    color: #92400e;
    border: 1px solid #fcd34d;
}

.paid-none {
    background: #fee2e2;
    color: #991b1b;
    border: 1px solid #fca5a5;
}

/* Стили для статусов сдачи */
.deadline-status {
    font-size: 0.75rem;
    white-space: nowrap;
    padding: 6px 10px;
    border-radius: 20px;
    font-weight: 500;
}

/* Стили для установки */
.installation-status {
    font-weight: bold;
    padding: 6px 10px;
    border-radius: 20px;
    font-size: 0.75rem;
    white-space: nowrap;
}

.installed {
    background: #d1fae5;
    color: #065f46;
}

.not-installed {
    background: #f3f4f6;
    color: #6b7280;
}

/* Стили для завершенных заказов */
.completed-badge {
    background: #d1fae5 !important;
    color: #065f46 !important;
    border: 1px solid #10b981;
    padding: 6px 12px;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.75rem;
}

/* Стили для сумм */
.price-cell {
    font-family: 'Courier New', monospace;
    font-weight: 600;
    text-align: right;
    color: #2c3e50;
    font-size: 0.9rem;
}

/* Стили для дат */
.date-cell {
    white-space: nowrap;
    font-size: 0.8rem;
    color: #6b7280;
}

/* Стили для названия заказа */
.order-name {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 4px;
}

.customer-name {
    font-size: 0.8rem;
    color: #6b7280;
}

/* Анимации */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.card-modern {
    animation: fadeInUp 0.6s ease-out;
}

.dashboard-grid > *:nth-child(1) { animation-delay: 0.1s; }
.dashboard-grid > *:nth-child(2) { animation-delay: 0.2s; }

/* Адаптивность */
@media (max-width: 1200px) {
    .dashboard-grid {
        grid-template-columns: 1fr;
        gap: 20px;
    }

    .chart-card {
        order: 2;
    }

    .table-card {
        order: 1;
    }
}

@media (max-width: 992px) {
    .dashboard-container {
        padding: 15px;
    }

    .order-table th:nth-child(3), /* Дата создания */
    .order-table td:nth-child(3) {
        display: none;
    }
}

@media (max-width: 768px) {
    .dashboard-container {
        padding: 10px;
    }

    .page-header h1 {
        font-size: 2rem;
    }

    .card-modern-header {
        padding: 15px 20px;
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
    }

    .table-header {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
    }

    .order-table {
        font-size: 0.75rem;
    }

    .order-table th,
    .order-table td {
        padding: 10px 8px;
    }

    .order-table th:nth-child(7), /* Оплата */
    .order-table td:nth-child(7) {
        display: none;
    }

    .chart-container {
        height: 250px;
    }
}

@media (max-width: 576px) {
    .page-header h1 {
        font-size: 1.8rem;
    }

    .page-header p {
        font-size: 1rem;
    }

    .order-table th:nth-child(4), /* Дата сдачи */
    .order-table td:nth-child(4) {
        display: none;
    }

    .order-table th:nth-child(8), /* Завершено */
    .order-table td:nth-child(8) {
        display: none;
    }

    .btn-modern {
        width: 100%;
        justify-content: center;
    }
}

/* Стили для пустого состояния */
.no-data {
    text-align: center;
    padding: 60px 20px;
    color: #9ca3af;
}

.no-data p {
    margin: 0;
    font-size: 1.1rem;
}

/* Улучшенные стили для графика */
.chart-improved {
    border-radius: 12px;
    padding: 10px;
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Заголовок страницы -->
    <div class="page-header">
        <h1>📋 Список заказов</h1>
        <p>Управление и отслеживание всех заказов</p>
    </div>

    <!-- Основная сетка: график + таблица -->
    <div class="dashboard-grid">
        <!-- График статусов оплаты -->
        <div class="card-modern chart-card">
            <div class="card-modern-header">
                <h5 class="card-modern-title">
                    📊 Статистика заказов
                </h5>
            </div>
            <div class="card-modern-body">
                <div class="chart-container">
                    <canvas id="paymentStatusChart" class="chart-improved"></canvas>
                </div>
            </div>
        </div>

        <!-- Таблица заказов -->
        <div class="card-modern table-card">
            <div class="card-modern-header">
                <h5 class="card-modern-title">
                    📦 Активные заказы
                </h5>
                {% if user.groups.all.0.name == 'Менеджеры' or user.is_superuser %}
                <a href="{% url 'orders:order_create' %}" class="btn-modern">
                    <i class="bi bi-plus-circle"></i>
                    Добавить заказ
                </a>
                {% endif %}
            </div>
            <div class="card-modern-body">
                {% if page_obj %}
                <div class="table-responsive">
                    <table class="order-table">
                        <thead>
                            <tr>
                                <th>
                                    <a href="?sort=order_name&order={% if current_sort == 'order_name' and current_order == 'asc' %}desc{% else %}asc{% endif %}" class="sort-link">
                                        Заказ
                                        {% if current_sort == 'order_name' %}
                                            {% if current_order == 'asc' %}↑{% else %}↓{% endif %}
                                        {% endif %}
                                    </a>
                                </th>
                                <th class="date-cell">
                                    <a href="?sort=created&order={% if current_sort == 'created' and current_order == 'asc' %}desc{% else %}asc{% endif %}" class="sort-link">
                                        Создан
                                        {% if current_sort == 'created' %}
                                            {% if current_order == 'asc' %}↑{% else %}↓{% endif %}
                                        {% endif %}
                                    </a>
                                </th>
                                <th class="date-cell">
                                    <a href="?sort=deadline&order={% if current_sort == 'deadline' and current_order == 'asc' %}desc{% else %}asc{% endif %}" class="sort-link">
                                        Сдача
                                        {% if current_sort == 'deadline' %}
                                            {% if current_order == 'asc' %}↑{% else %}↓{% endif %}
                                        {% endif %}
                                    </a>
                                </th>
                                <th>Статус</th>
                                <th>
                                    <a href="?sort=paid&order={% if current_sort == 'paid' and current_order == 'asc' %}desc{% else %}asc{% endif %}" class="sort-link">
                                        Оплата
                                        {% if current_sort == 'paid' %}
                                            {% if current_order == 'asc' %}↑{% else %}↓{% endif %}
                                        {% endif %}
                                    </a>
                                </th>
                                <th>
                                    <a href="?sort=installation_status&order={% if current_sort == 'installation_status' and current_order == 'asc' %}desc{% else %}asc{% endif %}" class="sort-link">
                                        Установка
                                        {% if current_sort == 'installation_status' %}
                                        {% if current_order == 'asc' %}↑{% else %}↓{% endif %}
                                        {% endif %}
                                    </a>
                                </th>
                                <th>
                                    <a href="?sort=is_completed&order={% if current_sort == 'is_completed' and current_order == 'asc' %}desc{% else %}asc{% endif %}" class="sort-link">
                                        Завершено
                                        {% if current_sort == 'is_completed' %}
                                        {% if current_order == 'asc' %}↑{% else %}↓{% endif %}
                                        {% endif %}
                                    </a>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in page_obj %}
                            <tr class="{% if order.is_completed %}completed-order{% endif %}"
                                onclick="window.location='{% url 'orders:order_detail' order.id %}';"
                                style="cursor: pointer;">
                                <td>
                                    <div class="order-name">{{ order.order_name|truncatechars:25 }}</div>
                                    <div class="customer-name">{{ order.customer_name|truncatechars:20 }}</div>
                                </td>
                                <td class="date-cell">{{ order.created|date:"d.m.Y" }}</td>
                                <td class="date-cell">{{ order.deadline|date:"d.m.Y" }}</td>
                                <td>
                                    {% with deadline_status=order.get_deadline_status %}
                                    <span class="deadline-status" style="background: {{ deadline_status.bg_color }}; color: {{ deadline_status.text_color }};">
                                        {{ deadline_status.icon }}
                                    </span>
                                    {% endwith %}
                                </td>
                                <td>
                                    {% if order.paid == 'fully_paid' %}
                                        <span class="paid-status paid-fully" title="Полностью оплачено">✓ Оплачено</span>
                                    {% elif order.paid == 'partially_paid' %}
                                        <span class="paid-status paid-partially" title="Частично оплачено">⏳ Частично</span>
                                    {% else %}
                                        <span class="paid-status paid-none" title="Не оплачено">✗ Не оплачено</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if order.installation_status == 'installed' %}
                                    <span class="installation-status installed">✓ Установлено</span>
                                    {% else %}
                                    <span class="installation-status not-installed">✗ Не установлено</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if order.is_completed %}
                                    <span class="completed-badge">✓ Завершено</span>
                                    {% else %}
                                    <span style="color: #6b7280; font-size: 0.8rem;">В работе</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Пагинация -->
                <div style="margin-top: 25px;">
                    {% include "pagination.html" %}
                </div>
                {% else %}
                <div class="no-data">
                    <p>📭 Заказы не найдены</p>
                    {% if user.groups.all.0.name == 'Менеджеры' or user.is_superuser %}
                    <a href="{% url 'orders:order_create' %}" class="btn-modern" style="margin-top: 15px;">
                        <i class="bi bi-plus-circle"></i>
                        Создать первый заказ
                    </a>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // График статусов оплаты с улучшенным стилем
    const ctx = document.getElementById('paymentStatusChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: {{ status_labels_json|safe }},
            datasets: [{
                data: {{ status_data_json|safe }},
                backgroundColor: [
                    'rgba(102, 126, 234, 0.8)',
                    'rgba(247, 183, 49, 0.8)',
                    'rgba(118, 75, 162, 0.8)',
                    'rgba(34, 197, 94, 0.8)',
                    'rgba(239, 68, 68, 0.8)'
                ],
                borderColor: [
                    'rgba(102, 126, 234, 1)',
                    'rgba(247, 183, 49, 1)',
                    'rgba(118, 75, 162, 1)',
                    'rgba(34, 197, 94, 1)',
                    'rgba(239, 68, 68, 1)'
                ],
                borderWidth: 2,
                borderRadius: 8,
                spacing: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '60%',
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        font: {
                            family: "'Inter', sans-serif",
                            size: 11
                        },
                        color: '#2c3e50',
                        padding: 15,
                        usePointStyle: true
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(44, 62, 80, 0.9)',
                    titleFont: {
                        family: "'Inter', sans-serif"
                    },
                    bodyFont: {
                        family: "'Inter', sans-serif"
                    },
                    padding: 12,
                    cornerRadius: 8
                }
            },
            animation: {
                animateScale: true,
                animateRotate: true
            }
        }
    });

    // Добавляем плавную прокрутку при клике на строки таблицы
    const tableRows = document.querySelectorAll('.order-table tbody tr');
    tableRows.forEach(row => {
        row.addEventListener('click', function(e) {
            e.preventDefault();
            const href = this.getAttribute('onclick').match(/'(.*?)'/)[1];
            window.location.href = href;
        });

        // Эффект при наведении
        row.addEventListener('mouseenter', function() {
            this.style.transition = 'all 0.3s ease';
        });
    });
});
</script>
{% endblock %}


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\orders\templates\orders\order\pdf.html
============================================================


<html>
<body>
  <h1>Мебель</h1>
  <p>
    Входной no. {{ order.id }}<br>
    <span class="secondary">
      {{ order.created|date:"M d, Y" }}
    </span>
  </p>
  <h3>Информация по заказу</h3>
  <p>
    {{ order.first_name }} {{ order.last_name }}<br>
    {{ order.address }}<br>
    {{ order.postal_code }}, {{ order.city }}
  </p>
  <h3>Items bought</h3>
  <table>
    <thead>
      <tr>
        <th>Material</th>
        <th>Price</th>
        <th>Quantity</th>
        <th>Cost</th>
      </tr>
    </thead>
    <tbody>
      {% for item in order.items.all %}
        <tr class="row{% cycle "1" "2" %}">
          <td>{{ item.material.name }}</td>
          <td class="num">${{ item.price }}</td>
          <td class="num">{{ item.quantity }}</td>
          <td class="num">${{ item.get_cost }}</td>
        </tr>
      {% endfor %}
      <tr class="total">
        <td colspan="3">Total</td>
        <td class="num">${{ order.get_total_cost }}</td>
      </tr>
    </tbody>
  </table>

  <span class="{% if order.paid %}paid{% else %}pending{% endif %}">
    {% if order.paid %}Paid{% else %}Pending payment{% endif %}
  </span>
</body>
</html>


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\orders\templates\orders\order\write_off_modal.html
============================================================

<div class="modal-header">
    <h5 class="modal-title" id="writeOffModalLabel">Списание материалов по заказу #{{ order.id }}</h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<form id="writeOffForm" method="post" action="{% url 'orders:order_write_off' order.id %}">
    <div class="modal-body">
        <p>Укажите количество для списания по каждому материалу.</p>
        <p class="text-danger"><strong>Внимание:</strong> Можно списать только зарезервированное количество.</p>

        {% csrf_token %}
        {% include "includes/form_errors.html" %}

        <div class="table-responsive">
            <table class="table table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>Материал</th>
                        <th>Зарезервировано<br><small>(для этого заказа)</small></th>
                        <th>На складе<br><small>(общий баланс)</small></th>
                        <th>Кол-во к списанию</th>
                    </tr>
                </thead>
                <tbody>
                    {% for field in form %}
                    {% with material_data=field.field.material_data %}
                    <tr>
                        <td>{{ field.label }}</td>
                        <td class="text-center">{{ material_data.reserved }}</td>
                        <td class="text-center">{{ material_data.balance }}</td>
                        <td>
                            {{ field }}
                            <div class="form-text">Макс.: {{ material_data.reserved }}</div>
                        </td>
                    </tr>
                    {% endwith %}
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- История операций -->
        <div class="mt-4">
            <div class="card">
                <div class="card-header">
                    <h5>📊 История операций</h5>
                </div>
                <div class="card-body">
                    {% if operation_history %}
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Дата</th>
                                    <th>Тип операции</th>
                                    <th>Количество</th>
                                    <th>Примечание</th>
                                    <th>Пользователь</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for op in operation_history %}
                                <tr>
                                    <td>{{ op.timestamp|date:"d.m.Y H:i" }}</td>
                                    <td>
                                        <span class="badge {% if op.type == 'receipt' %}bg-success{% else %}bg-danger{% endif %}">
                                            {% if op.type == 'receipt' %}Поступление{% else %}Списание{% endif %}
                                        </span>
                                    </td>
                                    <td>{{ op.quantity }} шт.</td>
                                    <td>{{ op.notes|default:"-" }}</td>
                                    <td>{{ op.user|default:"Система" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted text-center">Операций пока нет</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
        <button type="submit" class="btn btn-primary">Подтвердить списание</button>
    </div>
</form>

<script>
$(document).ready(function(){
    // Валидация на стороне клиента
    $('#writeOffForm').on('submit', function(e){
        let isValid = true;
        let errorMessage = '';

        $('input[type="number"]').each(function() {
            const max = parseInt($(this).attr('max')) || 0;
            const val = parseInt($(this).val()) || 0;
            const balance = parseInt($(this).data('balance')) || 0;
            const materialName = $(this).closest('tr').find('td:first').text().trim();

            if (val < 0) {
                errorMessage += '• ' + materialName + ': количество не может быть отрицательным\n';
                isValid = false;
            }
            if (val > max) {
                errorMessage += '• ' + materialName + ': нельзя списать больше чем осталось списать (' + max + ')\n';
                isValid = false;
            }
            if (val > balance) {
                errorMessage += '• ' + materialName + ': нельзя списать больше чем есть на складе (' + balance + ')\n';
                isValid = false;
            }
        });

        if (!isValid) {
            e.preventDefault();
            alert('Ошибка в данных:\n' + errorMessage);
        }
    });

    // Автофокус на первое поле при открытии
    $('input[type="number"]').first().focus();
});
</script>


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\orders\templates\pagination.html
============================================================

<div class="pagination">
  <span class="step-links">
    {% if page_obj.has_previous %}
      <a href="?page=1">&laquo; first</a>
      <a href="?page={{ page_obj.previous_page_number }}">previous</a>
    {% endif %}

    <span class="current">
      Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
    </span>

    {% if page_obj.has_next %}
      <a href="?page={{ page_obj.next_page_number }}">next</a>
      <a href="?page={{ page_obj.paginator.num_pages }}">last &raquo;</a>
    {% endif %}
  </span>
</div>

<style>
.pagination {
  margin: 20px 0;
  text-align: center;
}
.pagination a {
  color: #333;
  padding: 5px 10px;
  text-decoration: none;
  border: 1px solid #ddd;
  margin: 0 2px;
}
.pagination a:hover {
  background-color: #f5f5f5;
}
.pagination .current {
  padding: 5px 10px;
  font-weight: bold;
}
</style>


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\orders\templatetags\order_extras.py
============================================================

from django import template
from mebel.models import Material

register = template.Library()

@register.filter
def get_material_price(material_id):
    """Возвращает цену материала по его ID"""
    try:
        material = Material.objects.get(id=material_id)
        return material.price
    except Material.DoesNotExist:
        return 0

@register.filter
def subtract(value, arg):
    """Вычитает arg из value"""
    try:
        return int(value) - int(arg)
    except (ValueError, TypeError):
        return value

@register.filter
def multiply(value, arg):
    """Умножает value на arg"""
    try:
        return float(value) * float(arg)
    except (ValueError, TypeError):
        return 0


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\orders\admin.py
============================================================

import csv
import datetime
from django.http import HttpResponse
from django.contrib import admin
from django.urls import reverse
from django.utils.safestring import mark_safe
from .models import Order, OrderItem


def export_to_csv(modeladmin, request, queryset):
    opts = modeladmin.model._meta
    content_disposition = f'attachment; filename={opts.verbose_name}.csv'
    response = HttpResponse(content_type='text/csv')
    response['Content-Disposition'] = content_disposition
    writer = csv.writer(response)

    # Обновляем поля для экспорта
    fields = [
        field for field in opts.get_fields()
        if not field.many_to_many and not field.one_to_many
           and field.name not in ['blueprint', 'visualization']  # Исключаем бинарные поля
    ]

    # Write a first row with header information
    writer.writerow([field.verbose_name for field in fields])

    # Write data rows
    for obj in queryset:
        data_row = []
        for field in fields:
            value = getattr(obj, field.name)
            if isinstance(value, datetime.datetime):
                value = value.strftime('%d/%m/%Y')
            data_row.append(value)
        writer.writerow(data_row)

    return response


class OrderItemInLine(admin.TabularInline):
    model = OrderItem
    raw_id_fields = ['material']


def order_detail(obj):
    url = reverse('orders:admin_order_detail', args=[obj.id])
    return mark_safe(f'<a href="{url}">View</a>')


def order_pdf(obj):
    url = reverse('orders:admin_order_pdf', args=[obj.id])
    return mark_safe(f'<a href="{url}">PDF</a>')


order_pdf.short_description = 'Invoice'


def display_blueprint(obj):
    if obj.blueprint:
        return mark_safe(f'<img src="{obj.blueprint.url}" width="100" height="100" />')
    return "Нет чертежа"


def display_visualization(obj):
    if obj.visualization:
        return mark_safe(f'<img src="{obj.visualization.url}" width="100" height="100" />')
    return "Нет визуализации"


@admin.register(Order)
class OrderAdmin(admin.ModelAdmin):
    # Обновляем список отображаемых полей
    list_display = [
        'id', 'order_name', 'customer_name', 'category', 'deadline',
        'address', 'transferred_amount', 'discount',
        'paid', 'created', 'updated',
        order_detail, order_pdf
    ]

    list_filter = ['paid', 'created', 'updated', 'category', 'deadline']

    # Добавляем поиск по названию заказа и имени заказчика
    search_fields = ['order_name', 'customer_name']

    inlines = [OrderItemInLine]
    actions = [export_to_csv]

    # Поля для формы редактирования
    fieldsets = (
        ('Основная информация', {
            'fields': ('order_name', 'customer_name', 'address',
                       'category', 'discount', 'deadline')
        }),
        ('Финансовая информация', {
            'fields': ('transferred_amount', 'paid')
        }),
        ('Изображения', {
            'fields': ('blueprint', 'visualization', 'display_blueprint', 'display_visualization'),
            'classes': ('collapse',)
        }),
        ('Системная информация', {
            'fields': ('created', 'updated'),
            'classes': ('collapse',)
        }),
    )

    # Делаем поля только для чтения
    readonly_fields = ['created', 'updated', 'display_blueprint', 'display_visualization']

    # Добавляем вычисляемые поля для отображения изображений
    def display_blueprint(self, obj):
        return display_blueprint(obj)

    display_blueprint.short_description = 'Чертеж'

    def display_visualization(self, obj):
        return display_visualization(obj)

    display_visualization.short_description = 'Визуализация'

    def save_model(self, request, obj, form, change):
        # Сначала сохраняем объект
        super().save_model(request, obj, form, change)
        # Затем обновляем статус оплаты
        obj.update_payment_status()
        obj.save(update_fields=['paid'])

    def save_related(self, request, form, formsets, change):
        super().save_related(request, form, formsets, change)
        # После сохранения связанных объектов обновляем статус оплаты
        form.instance.update_payment_status()
        form.instance.save(update_fields=['paid'])


# Обновляем описание для экспорта
export_to_csv.short_description = 'Export to CSV'


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\orders\apps.py
============================================================

from django.apps import AppConfig


class OrdersConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'orders'

class OrdersConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'orders'

    def ready(self):
        # Импортируем и регистрируем сигналы
        import orders.signals


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\orders\forms.py
============================================================

from mebel.models import Material
from django import forms
from .models import Order, OrderItem
from mebel.models import Material
from django import forms
from .models import Order, OrderItem
from django.utils import timezone
from datetime import timedelta


class OrderItemForm(forms.ModelForm):
    material = forms.ModelChoiceField(
        queryset=Material.objects.all(),
        widget=forms.Select(attrs={
            'class': 'form-select',
            'style': 'min-width: 200px;'
        })
    )
    quantity = forms.IntegerField(
        min_value=0,
        initial=1,
        widget=forms.NumberInput(attrs={
            'class': 'form-control',
            'style': 'max-width: 100px;'
        })
    )

    class Meta:
        model = OrderItem
        fields = ['material', 'quantity']


class WriteOffForm(forms.Form):
    def __init__(self, *args, **kwargs):
        order_items = kwargs.pop('order_items')
        super().__init__(*args, **kwargs)

        for item in order_items:
            field_name = f'material_{item.id}'
            # Максимум можно списать остаток (исходное количество минус уже списанное)
            max_value = item.quantity - item.written_off

            self.fields[field_name] = forms.IntegerField(
                label=f'{item.material.name} (Макс.: {max_value})',
                min_value=0,
                max_value=max_value,  # ← Исправлено!
                initial=0,
                required=False,
                widget=forms.NumberInput(attrs={
                    'class': 'form-control',
                    'data-material-id': item.material.id,
                    'data-reserved': max_value,  # ← Обновляем для отображения
                    'data-balance': item.material.balance
                })
            )
            self.fields[field_name].material_data = {
                'material_id': item.material.id,
                'reserved': max_value,  # ← Обновляем
                'balance': item.material.balance
            }



class OrderForm(forms.ModelForm):
    def __init__(self, *args, **kwargs):
        self.is_edit = kwargs.pop('is_edit', False)
        super().__init__(*args, **kwargs)

        # Настраиваем поле deadline в зависимости от режима (создание/редактирование)
        if 'deadline' in self.fields:
            if self.is_edit:
                # Для редактирования - убираем ограничение min
                self.fields['deadline'].widget.attrs.pop('min', None)
            else:
                # Для создания - устанавливаем минимальную дату (сегодня)
                self.fields['deadline'].widget.attrs['min'] = timezone.now().date().isoformat()

    class Meta:
        model = Order
        fields = ['order_name', 'customer_name', 'address', 'transferred_amount',
                  'discount', 'category', 'deadline', 'blueprint', 'visualization',
                  'installation_status', 'installation_photo']
        widgets = {
            'order_name': forms.TextInput(attrs={'class': 'form-control'}),
            'customer_name': forms.TextInput(attrs={'class': 'form-control'}),
            'address': forms.TextInput(attrs={'class': 'form-control'}),
            'transferred_amount': forms.NumberInput(attrs={'class': 'form-control'}),
            'discount': forms.NumberInput(attrs={'class': 'form-control'}),
            'category': forms.Select(attrs={'class': 'form-select'}),
            'deadline': forms.DateInput(
                attrs={
                    'class': 'form-control',
                    'type': 'date',
                    # Минимальная дата будет установлена в __init__
                }
            ),
            'blueprint': forms.FileInput(attrs={'class': 'form-control'}),
            'visualization': forms.FileInput(attrs={'class': 'form-control'}),
            'installation_status': forms.Select(attrs={'class': 'form-select'}),
            'installation_photo': forms.FileInput(attrs={'class': 'form-control'}),
        }
        labels = {
            'order_name': 'Название',
            'customer_name': 'Имя заказчика',
            'address': 'Адрес',
            'transferred_amount': 'Перечисленные средства',
            'discount': 'Скидка (%)',
            'category': 'Категория',
            'deadline': 'Дата сдачи',
            'blueprint': 'Чертеж общего вида',
            'visualization': 'Проектный вид',
            'installation_status': 'Монтаж',
            'installation_photo': 'Фотография монтажа'
        }


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\orders\models.py
============================================================

from django.db import models
from mebel.models import Material
from django.utils import timezone
from decimal import Decimal
from django.urls import reverse
from datetime import timedelta


class Order(models.Model):
    class PaymentStatus(models.TextChoices):
        NOT_PAID = 'not_paid', 'Не оплачено'
        PARTIALLY_PAID = 'partially_paid', 'Оплачено частично'
        FULLY_PAID = 'fully_paid', 'Оплачено полностью'

    class InstallationStatus(models.TextChoices):
        NOT_INSTALLED = 'not_installed', 'Не смонтировано'
        INSTALLED = 'installed', 'Смонтировано'

    class CategoryChoices(models.TextChoices):
        BLOKS = 'blocks', 'Блоки'
        AGREGATS = 'agregats', 'Агрегаты'
        MODULES = 'modules', 'Модули'
        OTHER = 'other', 'другое'

    order_name = models.CharField(max_length=50, verbose_name='Название')
    customer_name = models.CharField(max_length=50, verbose_name='Имя заказчика')
    address = models.CharField(max_length=250)
    transferred_amount = models.DecimalField(max_digits=10, decimal_places=2, default=0,
                                             verbose_name='Перечисленные средства')
    discount = models.PositiveIntegerField(default=0, verbose_name='Скидка (%)')
    category = models.CharField(
        max_length=20,
        choices=CategoryChoices.choices,
        default=CategoryChoices.OTHER,
        verbose_name='Категория'
    )
    deadline = models.DateField(
        default=timezone.now() + timedelta(days=1),  # Завтра по умолчанию
        verbose_name='Дата сдачи'
    )
    blueprint = models.ImageField(upload_to='blueprints/%Y/%m/%d/', blank=True, null=True, verbose_name='Чертеж')
    visualization = models.ImageField(upload_to='visualizations/%Y/%m/%d/', blank=True, null=True,
                                      verbose_name='Визуализация')
    created = models.DateTimeField(auto_now_add=True)
    updated = models.DateTimeField(auto_now=True)
    paid = models.CharField(
        max_length=20,
        choices=PaymentStatus.choices,
        default=PaymentStatus.NOT_PAID,
        verbose_name='Статус оплаты'
    )
    # Новые поля
    installation_status = models.CharField(
        max_length=20,
        choices=InstallationStatus.choices,
        default=InstallationStatus.NOT_INSTALLED,
        verbose_name='Монтаж'
    )
    installation_photo = models.ImageField(
        upload_to='installation_photos/%Y/%m/%d/',
        blank=True,
        null=True,
        verbose_name='Фото монтажа'
    )
    is_completed = models.BooleanField(default=False, verbose_name='Завершено')

    class Meta:
        ordering = ['-created']
        indexes = [
            models.Index(fields=['-created']),
        ]

    def __str__(self):
        return f'Order {self.id}'

    def get_write_off_url(self):
        return reverse('orders:order_write_off', args=[self.id])

    def get_total_cost(self):
        if not self.pk:
            return Decimal('0.00')
        materials_cost = sum(item.get_cost() for item in self.items.all())
        discount_decimal = Decimal(str(self.discount)) / Decimal('100')
        discount_multiplier = Decimal('1') - discount_decimal
        return materials_cost * Decimal('2') * discount_multiplier

    def get_deadline_status(self):
        """Возвращает статус сдачи заказа"""

        if self.is_completed:
            return {
                'status': 'закрыт',
                'class': 'success',
                'icon': '✅'
            }

        today = timezone.now().date()
        days_until_deadline = (self.deadline - today).days

        if days_until_deadline < 0:
            return {
                'status': 'просрочен',
                'class': 'danger',
                'icon': '❌'
            }
        elif days_until_deadline <= 14:  # Менее 2 недель
            return {
                'status': 'прогнозируется срыв',
                'class': 'warning',
                'icon': '⚠️'
            }
        else:
            return {
                'status': 'в работе',
                'class': 'success',
                'icon': '🛠️'
            }

    def update_payment_status(self):
        total_cost = self.get_total_cost()
        transferred = Decimal(str(self.transferred_amount))

        if transferred >= total_cost:
            self.paid = self.PaymentStatus.FULLY_PAID
        elif transferred > Decimal('0'):
            self.paid = self.PaymentStatus.PARTIALLY_PAID
        else:
            self.paid = self.PaymentStatus.NOT_PAID

    def update_completion_status(self):
        """Обновляет статус завершения заказа"""
        self.is_completed = (
            self.paid == self.PaymentStatus.FULLY_PAID and
            self.installation_status == self.InstallationStatus.INSTALLED
        )
    def save(self, *args, **kwargs):
        self.update_payment_status()
        self.update_completion_status()
        super().save(*args, **kwargs)



class OrderItem(models.Model):
    order = models.ForeignKey(Order,
                              related_name='items',
                              on_delete=models.CASCADE)
    material = models.ForeignKey(Material,
                                related_name='order_items',
                                on_delete=models.CASCADE)
    price = models.DecimalField(max_digits=10,
                                decimal_places=2)
    quantity = models.PositiveIntegerField(default=1)
    written_off = models.PositiveIntegerField(default=0)
    operation_history = models.JSONField(default=list, blank=True)

    def __str__(self):
        return str(self.id)

    def get_cost(self):
        return self.price * self.quantity

    from datetime import datetime

    def add_operation_to_history(self, operation_type, quantity, user, notes=None):
        """Добавляет операцию в историю"""
        operation = {
            'type': operation_type,
            'quantity': quantity,
            'user': user.username,
            'timestamp': timezone.now().isoformat(),  # Сохраняем как ISO строку
            'notes': notes
        }
        self.operation_history.append(operation)
        # Ограничиваем историю последними 10 операциями
        if len(self.operation_history) > 10:
            self.operation_history = self.operation_history[-10:]
        self.save(update_fields=['operation_history'])


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\orders\signals.py
============================================================

from .models import OrderItem, Order
from django.db.models.signals import post_save, post_delete
from django.dispatch import receiver
from django.db.models import Sum


# orders/signals.py - УНИФИЦИРОВАННАЯ ЛОГИКА
@receiver([post_save, post_delete], sender=OrderItem)
def update_material_reserve(sender, instance, **kwargs):
    material = instance.material
    total_reserved = OrderItem.objects.filter(
        material=material
    ).aggregate(total=Sum('quantity'))['total'] or 0

    if material.reserved != total_reserved:
        material.reserved = total_reserved
        material.lack = max(0, total_reserved - material.balance)
        material.save(update_fields=['reserved', 'lack'])

# Новый сигнал для обновления статуса завершения при изменении заказа
@receiver(post_save, sender=Order)
def update_order_completion_status(sender, instance, **kwargs):
    """Обновляет статус завершения при изменении заказа"""
    instance.update_completion_status()
    # Сохраняем только если статус изменился
    if instance.pk:
        Order.objects.filter(pk=instance.pk).update(is_completed=instance.is_completed)


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\orders\tests.py
============================================================

from django.test import TestCase

# Create your tests here.


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\orders\urls.py
============================================================

from django.urls import path
from . import views


app_name = 'orders'

urlpatterns = [
    path('list/', views.order_list, name='order_list'),
    path('create/', views.order_create, name='order_create'),
    path('<int:order_id>/', views.order_detail, name='order_detail'),
    path('<int:order_id>/edit/', views.order_edit, name='order_edit'),
    path('admin/order/<int:order_id>/', views.admin_order_detail, name='admin_order_detail'),
    path('admin/order/<int:order_id>/pdf/', views.admin_order_pdf, name='admin_order_pdf'),
    path('<int:order_id>/write_off/', views.order_write_off, name='order_write_off'),
]


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\orders\views.py
============================================================

from django.shortcuts import render, get_object_or_404
from django.contrib.admin.views.decorators import staff_member_required
from django.conf import settings
from django.http import HttpResponse
from django.template.loader import render_to_string
# Добавьте эти импорты в начало views.py
from django.utils.safestring import mark_safe
import weasyprint
from .models import OrderItem, Order
from .forms import OrderForm, OrderItemForm, WriteOffForm
from mebel.models import Material
from django.shortcuts import render, redirect
from django.contrib.auth.decorators import login_required
from django.core.paginator import Paginator
from django.views.decorators.http import require_http_methods
from django.contrib import messages
from django import forms
from django.forms import inlineformset_factory
from .models import Order, OrderItem
from .forms import OrderItemForm
from django.db.models import Sum, F
from django.db import transaction
from collections import defaultdict
from django.utils import timezone
from django.utils import timezone
from datetime import datetime
from warehouse.utils import managers_required, mto_required
import dateutil.parser
from django.db.models import Count
import json
from django.utils.safestring import mark_safe
from mebel.models import MaterialOperation

# Добавьте это в начале файла, после импортов
OrderItemFormSet = inlineformset_factory(
    Order,
    OrderItem,
    form=OrderItemForm,
    extra=1,
    can_delete=True,
    fields=['material', 'quantity']
)

@mto_required
@require_http_methods(["GET", "POST"])
def order_write_off(request, order_id):
    order = get_object_or_404(Order, id=order_id)
    order_items = order.items.all().select_related('material')

    if request.method == 'POST':
        form = WriteOffForm(request.POST, order_items=order_items)
        if form.is_valid():
            for item in order_items:
                field_name = f'material_{item.id}'
                quantity_to_write_off = form.cleaned_data.get(field_name, 0)

                if quantity_to_write_off > 0:
                    material = item.material

                    # Рассчитываем доступное для списания количество
                    # Максимум можно списать: минимум из (остаток_для_списания, баланс_на_складе)
                    available_to_write_off = min(
                        item.quantity - item.written_off,  # ← Осталось списать по заказу
                        material.balance,  # ← Доступно на складе
                        quantity_to_write_off  # ← Запрошенное количество
                    )

                    if available_to_write_off > 0:
                        # Уменьшаем баланс на складе
                        material.balance -= available_to_write_off
                        # Увеличиваем списанное количество (НЕ уменьшаем исходное quantity!)
                        item.written_off += available_to_write_off

                        # Добавляем операцию в историю
                        notes = form.cleaned_data.get('notes', '')
                        MaterialOperation.objects.create(
                            material=material,
                            operation_type='write_off',
                            quantity=available_to_write_off,
                            notes=notes,
                            user=request.user
                        )

                        # Сохраняем в историю элемента заказа
                        item.add_operation_to_history(
                            'write_off',
                            available_to_write_off,
                            request.user,
                            notes
                        )

                        # Сохраняем изменения
                        material.save()
                        item.save()

            messages.success(request, 'Материалы успешно списаны со склада.')
            return redirect('orders:order_detail', order_id=order.id)
    else:
        form = WriteOffForm(order_items=order_items)

    # Получаем историю операций для отображения
    operation_history = []
    for item in order_items:
        for op in item.operation_history:
            # Преобразуем строку в datetime объект
            timestamp = op.get('timestamp')
            if isinstance(timestamp, str):
                try:
                    timestamp = dateutil.parser.isoparse(timestamp)
                except (ValueError, TypeError):
                    timestamp = None

            operation_history.append({
                'material': item.material.name,
                'type': op.get('type', ''),
                'quantity': op.get('quantity', 0),
                'user': op.get('user', ''),
                'timestamp': timestamp,  # ← Теперь это datetime объект
                'notes': op.get('notes', '')
            })

    # Сортируем по времени (новые сверху)
    operation_history.sort(key=lambda x: x['timestamp'] or timezone.now(), reverse=True)

    return render(request, 'orders/order/write_off_modal.html', {
        'order': order,
        'form': form,
        'operation_history': operation_history[:10]  # Последние 10 операций
    })
from django.db.models import Sum, F, DecimalField
from django.db.models.functions import Coalesce


@login_required
def order_list(request):
    sort_by = request.GET.get('sort', '-created')
    order = request.GET.get('order', 'desc')

    # Получаем базовый queryset
    orders = Order.objects.all()

    # Для вычисляемых полей применяем сортировку на уровне Python
    if sort_by == 'total_cost':
        # Преобразуем queryset в список для сортировки
        orders_list = list(orders)
        # Сортируем по вычисляемому полю total_cost
        if order == 'asc':
            orders_list.sort(key=lambda x: x.get_total_cost())
        else:
            orders_list.sort(key=lambda x: x.get_total_cost(), reverse=True)

        # Создаем paginator для отсортированного списка
        paginator = Paginator(orders_list, 10)
        page_number = request.GET.get('page')
        page_obj = paginator.get_page(page_number)
    else:
        # Для обычных полей применяем сортировку на уровне БД
        if order == 'asc':
            if sort_by.startswith('-'):
                sort_by = sort_by[1:]
        else:
            if not sort_by.startswith('-'):
                sort_by = '-' + sort_by

        orders = orders.order_by(sort_by)
        paginator = Paginator(orders, 10)
        page_number = request.GET.get('page')
        page_obj = paginator.get_page(page_number)

    # Данные для графика
    status_stats = Order.objects.values('paid').annotate(count=Count('id')).order_by('paid')

    status_labels = []
    status_data = []
    background_colors = []
    border_colors = []

    # Цвета для каждого статуса
    color_map = {
        'not_paid': ('rgba(255, 99, 132, 0.2)', 'rgba(255, 99, 132, 1)'),
        'partially_paid': ('rgba(54, 162, 235, 0.2)', 'rgba(54, 162, 235, 1)'),
        'fully_paid': ('rgba(75, 192, 192, 0.2)', 'rgba(75, 192, 192, 1)')
    }

    for stat in status_stats:
        status_label = dict(Order.PaymentStatus.choices).get(stat['paid'])
        status_labels.append(status_label)
        status_data.append(stat['count'])

        # Получаем цвета из color_map
        bg_color, border_color = color_map.get(stat['paid'], ('rgba(0, 0, 0, 0.2)', 'rgba(0, 0, 0, 1)'))
        background_colors.append(bg_color)
        border_colors.append(border_color)

    # Конвертируем в JSON
    status_labels_json = mark_safe(json.dumps(status_labels))
    status_data_json = mark_safe(json.dumps(status_data))
    background_colors_json = mark_safe(json.dumps(background_colors))
    border_colors_json = mark_safe(json.dumps(border_colors))

    return render(request, 'orders/order/list.html', {
        'page_obj': page_obj,
        'current_sort': sort_by.lstrip('-'),
        'current_order': order,
        'status_labels_json': status_labels_json,
        'status_data_json': status_data_json,
        'background_colors_json': background_colors_json,
        'border_colors_json': border_colors_json
    })


@managers_required
def order_create(request):
    if request.method == 'POST':
        form = OrderForm(request.POST, request.FILES)  # Добавьте request.FILES
        formset = OrderItemFormSet(request.POST, prefix='items')

        # Удаляем пустые формы из formset
        if form.is_valid() and formset.is_valid():
            # Фильтруем формы, удаляя пустые
            forms_to_save = [
                form for form in formset
                if form.cleaned_data and not form.cleaned_data.get('DELETE', False)
                   and form.cleaned_data.get('material') and form.cleaned_data.get('quantity')
            ]

            if forms_to_save:
                order = form.save()
                for item_form in forms_to_save:
                    material = item_form.cleaned_data['material']
                    quantity = item_form.cleaned_data['quantity']

                    OrderItem.objects.create(
                        order=order,
                        material=material,
                        quantity=quantity,
                        price=material.price
                    )

                # Обновляем статус оплаты после создания всех OrderItem
                order.update_payment_status()
                order.save(update_fields=['paid'])

                return redirect('orders:order_detail', order.id)
            else:
                # Если нет ни одного материала, показываем ошибку
                form.add_error(None, 'Добавьте хотя бы один материал в заказ')
    else:
        form = OrderForm()
        formset = OrderItemFormSet(prefix='items')

    materials = Material.objects.all()
    material_prices = {m.id: str(m.price) for m in materials}

    return render(request, 'orders/order/create.html', {
        'form': form,
        'formset': formset,
        'materials': materials,
        'material_prices_json': json.dumps(material_prices),
        'total_price': 0.00,
    })

from django.utils.safestring import mark_safe

def display_blueprint(obj):
    if obj.blueprint:
        return mark_safe(f'<img src="{obj.blueprint.url}" width="100" height="100" />')
    return "Нет чертежа"

def display_visualization(obj):
    if obj.visualization:
        return mark_safe(f'<img src="{obj.visualization.url}" width="100" height="100" />')
    return "Нет визуализации"

def display_installation_photo(obj):
    if obj.installation_photo:
        return mark_safe(f'<img src="{obj.installation_photo.url}" width="100" height="100" />')
    return "Нет фото установки"

@staff_member_required
def admin_order_detail(request, order_id):
    order = get_object_or_404(Order, id=order_id)
    return render(request, 'admin/orders/order/detail.html', {
        'order': order,
        'display_blueprint': display_blueprint(order),
        'display_visualization': display_visualization(order)
    })
@login_required
def order_detail(request, order_id):
    order = get_object_or_404(Order, id=order_id)
    return render(request, 'orders/order/detail.html', {
        'order': order,
        'display_installation_photo': display_installation_photo(order)
    })


@managers_required
@require_http_methods(["GET", "POST"])
def order_edit(request, order_id):
    order = get_object_or_404(Order, id=order_id)

    # Создаем inline formset factory
    OrderItemFormSet = inlineformset_factory(
        Order,
        OrderItem,
        form=OrderItemForm,
        extra=1,
        can_delete=True,
        fields=['material', 'quantity']
    )

    if request.method == 'POST':
        # Передаем is_edit=True для формы редактирования
        form = OrderForm(request.POST, request.FILES, instance=order, is_edit=True)
        formset = OrderItemFormSet(request.POST, instance=order, prefix='items')

        if form.is_valid() and formset.is_valid():
            try:
                # Сохраняем основную информацию заказа
                order = form.save(commit=False)

                # Используем транзакцию для обеспечения целостности данных
                with transaction.atomic():
                    order.save()

                    # Создаем словарь для агрегации данных по материалам
                    materials_dict = defaultdict(lambda: {
                        'quantity': 0,
                        'written_off': 0,
                        'operation_history': []
                    })

                    # Собираем данные из форм
                    for form_in_formset in formset:
                        if form_in_formset.cleaned_data and not form_in_formset.cleaned_data.get('DELETE', False):
                            material = form_in_formset.cleaned_data['material']
                            quantity = form_in_formset.cleaned_data['quantity']

                            # Если материал уже есть в словаре, суммируем значения
                            if material.id in materials_dict:
                                materials_dict[material.id]['quantity'] += quantity
                                # Для существующих записей сохраняем историю операций
                                if form_in_formset.instance.pk:
                                    materials_dict[material.id]['written_off'] = form_in_formset.instance.written_off
                                    materials_dict[material.id][
                                        'operation_history'] = form_in_formset.instance.operation_history
                            else:
                                # Для новых материалов используем переданные значения
                                materials_dict[material.id] = {
                                    'quantity': quantity,
                                    'written_off': form_in_formset.instance.written_off if form_in_formset.instance.pk else 0,
                                    'operation_history': form_in_formset.instance.operation_history if form_in_formset.instance.pk else []
                                }

                    # Удаляем все существующие элементы заказа
                    OrderItem.objects.filter(order=order).delete()

                    # Создаем новые элементы заказа с агрегированными данными
                    for material_id, data in materials_dict.items():
                        material = Material.objects.get(id=material_id)
                        OrderItem.objects.create(
                            order=order,
                            material=material,
                            quantity=data['quantity'],
                            price=material.price,
                            written_off=data['written_off'],
                            operation_history=data['operation_history']
                        )

                    # Обновляем резерв материалов
                    for material_id in materials_dict:
                        material = Material.objects.get(id=material_id)
                        material.update_reserved_quantity()

                    # Обновляем статус оплаты после изменения items
                    order.update_payment_status()
                    order.save(update_fields=['paid'])

                    messages.success(request, 'Заказ успешно обновлен.')
                    return redirect('orders:order_detail', order_id=order.id)

            except Exception as e:
                messages.error(request, f'Ошибка при сохранении: {e}')
        else:
            messages.error(request, 'Пожалуйста, исправьте ошибки в форме.')
    else:
        form = OrderForm(instance=order, is_edit=True)
        formset = OrderItemFormSet(instance=order, prefix='items')

    return render(request, 'orders/order/edit.html', {
        'form': form,
        'formset': formset,
        'order': order,
    })

@login_required
def admin_order_pdf(request, order_id):
    order = get_object_or_404(Order, id=order_id)
    html = render_to_string('orders/order/pdf.html',
                            {'order': order})
    response = HttpResponse(content_type='application/pdf')
    response['Content-Disposition'] = f'filename=order_{order.id}.pdf'
    weasyprint.HTML(string=html).write_pdf(response,
        stylesheets=[weasyprint.CSS(
            settings.STATIC_ROOT / 'css/pdf.css')])
    return response


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\orders\__init__.py
============================================================



============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\templates\includes\form_errors.html
============================================================

<!-- Для вывода ошибок формы -->
{% if form.errors or form.non_field_errors %}
<div class="alert alert-danger mt-3">
    <h6 class="alert-heading">Пожалуйста, исправьте ошибки:</h6>
    <ul class="mb-0">
        {% for field in form %}
        {% for error in field.errors %}
        <li><strong>{{ field.label }}:</strong> {{ error }}</li>
        {% endfor %}
        {% endfor %}
        {% for error in form.non_field_errors %}
        <li>{{ error }}</li>
        {% endfor %}
    </ul>
</div>
{% endif %}

<!-- Для вывода сообщений Django ТОЛЬКО на странице списка материалов -->
{% if messages and request.path == '/materials' %}
<div class="mt-3">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
</div>
{% endif %}


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\templates\includes\modal.html
============================================================

<!-- templates/includes/modal_simple.html -->
<div class="modal fade" id="{{ modal_id|default:'defaultModal' }}"
     tabindex="-1"
     aria-labelledby="{{ modal_id|default:'defaultModal' }}Label"
     aria-hidden="true">

    <div class="modal-dialog {{ modal_size|default:'' }}">
        <div class="modal-content">
            <!-- Контент будет загружен через AJAX -->
        </div>
    </div>
</div>

<script>
// Скрипт для AJAX-загрузки контента
$(document).ready(function(){
    $('#{{ modal_id|default:"defaultModal" }}').on('show.bs.modal', function (event) {
        var modal = $(this);
        var ajaxUrl = "{{ modal_ajax_url|default:'#' }}";

        if(ajaxUrl !== '#') {
            $.ajax({
                url: ajaxUrl,
                context: document.body,
                success: function(response) {
                    modal.find('.modal-content').html(response);
                },
                error: function() {
                    modal.find('.modal-content').html(
                        '<div class="modal-header">' +
                        '<h5 class="modal-title">Ошибка</h5>' +
                        '<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>' +
                        '</div>' +
                        '<div class="modal-body">' +
                        '<p class="text-danger">Не удалось загрузить содержимое.</p>' +
                        '</div>'
                    );
                }
            });
        }
    });
});
</script>


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\templates\includes\pagination.html
============================================================

<!-- Пагинация для ListView -->
{% if is_paginated %}
<nav aria-label="Page navigation" class="mt-4">
    <ul class="pagination justify-content-center">

        <!-- Кнопка "Назад" -->
        {% if page_obj.has_previous %}
        <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.urlencode %}&{{ request.GET.urlencode }}{% endif %}" aria-label="Previous">
                &laquo;
            </a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <span class="page-link">&laquo;</span>
        </li>
        {% endif %}

        <!-- Номера страниц -->
        {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
            <li class="page-item active">
                <span class="page-link">{{ num }}</span>
            </li>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
            <li class="page-item">
                <a class="page-link" href="?page={{ num }}{% if request.GET.urlencode %}&{{ request.GET.urlencode }}{% endif %}">{{ num }}</a>
            </li>
            {% endif %}
        {% endfor %}

        <!-- Кнопка "Вперед" -->
        {% if page_obj.has_next %}
        <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.urlencode %}&{{ request.GET.urlencode }}{% endif %}" aria-label="Next">
                &raquo;
            </a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <span class="page-link">&raquo;</span>
        </li>
        {% endif %}

    </ul>
</nav>
{% endif %}


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\templates\403.html
============================================================

{% extends "mebel/base.html" %}

{% block title %}Доступ запрещен{% endblock %}

{% block content %}
    <h1>Ошибка 403: Доступ запрещен</h1>
    <p>У вашей учетной записи недостаточно прав для просмотра этой страницы.</p>
    <a href="{% url 'mebel:main_dashboard' %}" class="btn btn-primary">Вернуться на главную</a>
{% endblock %}


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\warehouse\templates\base.html
============================================================

<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}Warehouse{% endblock %}</title>
    <!-- Подключение глобального CSS -->
    <link rel="stylesheet" href="{% static 'css/base.css' %}">
    {% block extra_css %}{% endblock %}  <!-- Для стилей приложений -->
</head>
<body>
    <header>...</header>
    <main>
        {% block content %}{% endblock %}
    </main>
    <footer>...</footer>
    <!-- Глобальные скрипты -->
    <script src="{% static 'js/main.js' %}"></script>
    {% block extra_js %}{% endblock %}
</body>
</html>


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\warehouse\asgi.py
============================================================

"""
ASGI config for warehouse project.

It exposes the ASGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/4.2/howto/deployment/asgi/
"""

import os

from django.core.asgi import get_asgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'warehouse.settings')

application = get_asgi_application()


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\warehouse\celery.py
============================================================

import os
from celery import Celery

# задать стандартный модуль настроек Django
# для программы 'celery'.

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'warehouse.settings')

app = Celery('warehouse')
app.config_from_object('django.conf:settings', namespace='CELERY')
app.autodiscover_tasks()


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\warehouse\settings.py
============================================================

import os
from pathlib import Path
from dotenv import load_dotenv

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent

# Загружаем переменные из .env
load_dotenv()

# Секретный ключ
SECRET_KEY = os.getenv('SECRET_KEY')

# Конфигурация сервера электронной почты
EMAIL_HOST = 'smtp.gmail.com'
EMAIL_HOST_USER = 'trofimov3388@gmail.com'
EMAIL_HOST_PASSWORD = os.getenv('GG_PASSWORD')
EMAIL_PORT = 587
EMAIL_USE_TLS = True

# Режим отладки
DEBUG = os.getenv('DEBUG') == 'True'

STATIC_URL = '/static/'
STATIC_ROOT = os.path.join(BASE_DIR, 'staticfiles')
STATICFILES_DIRS = [os.path.join(BASE_DIR, 'static')]

# Настройки БД
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': os.getenv('DB_NAME'),
        'USER': os.getenv('DB_USER'),
        'PASSWORD': os.getenv('DB_PASSWORD'),
        'HOST': os.getenv('DB_HOST'),
        'PORT': os.getenv('DB_PORT'),
    }
}

CSRF_TRUSTED_ORIGINS = [
    'http://31.130.155.228:8000',
    'http://24warehouse.ru',
    'http://www.24warehouse.ru',
    'http://31.130.155.228',
]

ALLOWED_HOSTS = ['24warehouse.ru', 'www.24warehouse.ru', '31.130.155.228', 'localhost', '127.0.0.1']

LOGIN_REDIRECT_URL = 'mebel:main_dashboard'
LOGIN_URL = 'account:login'
LOGOUT_URL = 'account:logout'

# Application definition

INSTALLED_APPS = [
    'account.apps.AccountConfig',
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'mebel.apps.MebelConfig',
    'orders.apps.OrdersConfig',
    'rest_framework',
]

# Security settings
CSRF_COOKIE_SECURE = False
SESSION_COOKIE_SECURE = False
SECURE_BROWSER_XSS_FILTER = True
SECURE_CONTENT_TYPE_NOSNIFF = True

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'warehouse.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [BASE_DIR / 'templates'],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages', #Отключить при длительных запросах. Корзина включается повсюду
            ],
        },
    },
]

WSGI_APPLICATION = 'warehouse.wsgi.application'


# Password validation
# https://docs.djangoproject.com/en/4.2/ref/settings/#auth-password-validators

AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]


# Internationalization

#CELERY_BROKER_URL = 'amqp://guest:guest@localhost:15672//'

# https://docs.djangoproject.com/en/4.2/topics/i18n/

LANGUAGE_CODE = 'en-us'

TIME_ZONE = 'UTC'

USE_I18N = True

USE_TZ = True

MEDIA_URL = '/media/'
MEDIA_ROOT = os.path.join(BASE_DIR, 'media')

ORDERCART_SESSION_ID = 'ordercart'


# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/4.2/howto/static-files/


# Default primary key field type
# https://docs.djangoproject.com/en/4.2/ref/settings/#default-auto-field

DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\warehouse\urls.py
============================================================

from django.contrib import admin
from django.urls import path, include
from django.conf import settings
from django.conf.urls.static import static
from django.conf.urls import handler403


urlpatterns = [
    path('admin/', admin.site.urls),
    path('account/', include('account.urls',namespace='account')),
    path('orders/', include('orders.urls', namespace='orders')),
    path('', include('mebel.urls', namespace='mebel')),

]

handler403 = 'account.views.custom_permission_denied_view'

if settings.DEBUG:
    urlpatterns += static(settings.MEDIA_URL,
                          document_root=settings.MEDIA_ROOT)



============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\warehouse\utils.py
============================================================

from django.contrib.auth.decorators import login_required
from django.http import HttpResponseForbidden

def group_required(*group_names):
    """Требует членства пользователя хотя бы в одной из переданных групп."""
    def decorator(view_func):
        @login_required
        def _wrapped_view(request, *args, **kwargs):
            if request.user.is_superuser:
                return view_func(request, *args, **kwargs)
            if not request.user.groups.filter(name__in=group_names).exists():
                return HttpResponseForbidden("У вас нет прав для выполнения этого действия.")
            return view_func(request, *args, **kwargs)
        return _wrapped_view
    return decorator

# Конкретные декораторы для наших групп
def managers_required(view_func):
    return group_required('Менеджеры')(view_func)

def mto_required(view_func):
    return group_required('Отдел МТО')(view_func)


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\warehouse\wsgi.py
============================================================

"""
WSGI config for warehouse project.

It exposes the WSGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/4.2/howto/deployment/wsgi/
"""

import os

from django.core.wsgi import get_wsgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'warehouse.settings')

application = get_wsgi_application()


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\warehouse\__init__.py
============================================================

# импортировать celery
from .celery import app as celery_app


__all__ = ['celery_app']


============================================================
: C:\Users\Dmitriy\PycharmProjects\trofimovGI\warehouse\manage.py
============================================================

#!/usr/bin/env python
"""Django's command-line utility for administrative tasks."""
import os
import sys


def main():
    """Run administrative tasks."""
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'warehouse.settings')
    try:
        from django.core.management import execute_from_command_line
    except ImportError as exc:
        raise ImportError(
            "Couldn't import Django. Are you sure it's installed and "
            "available on your PYTHONPATH environment variable? Did you "
            "forget to activate a virtual environment?"
        ) from exc
    execute_from_command_line(sys.argv)


if __name__ == '__main__':
    main()


