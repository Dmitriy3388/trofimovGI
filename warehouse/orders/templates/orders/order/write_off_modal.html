<div class="modal-header">
    <h5 class="modal-title" id="writeOffModalLabel">–°–ø–∏—Å–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –ø–æ –∑–∞–∫–∞–∑—É #{{ order.id }}</h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<form id="writeOffForm" method="post" action="{% url 'orders:order_write_off' order.id %}">
    <div class="modal-body">
        <p>–£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è –ø–æ –∫–∞–∂–¥–æ–º—É –º–∞—Ç–µ—Ä–∏–∞–ª—É.</p>
        <p class="text-danger"><strong>–í–Ω–∏–º–∞–Ω–∏–µ:</strong> –ú–æ–∂–Ω–æ —Å–ø–∏—Å–∞—Ç—å —Ç–æ–ª—å–∫–æ –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ.</p>

        {% csrf_token %}
        {% include "includes/form_errors.html" %}

        <div class="table-responsive">
            <table class="table table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>–ú–∞—Ç–µ—Ä–∏–∞–ª</th>
                        <th>–ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ<br><small>(–¥–ª—è —ç—Ç–æ–≥–æ –∑–∞–∫–∞–∑–∞)</small></th>
                        <th>–ù–∞ —Å–∫–ª–∞–¥–µ<br><small>(–æ–±—â–∏–π –±–∞–ª–∞–Ω—Å)</small></th>
                        <th>–ö–æ–ª-–≤–æ –∫ —Å–ø–∏—Å–∞–Ω–∏—é</th>
                    </tr>
                </thead>
                <tbody>
                    {% for field in form %}
                    {% with material_data=field.field.material_data %}
                    <tr>
                        <td>{{ field.label }}</td>
                        <td class="text-center">{{ material_data.reserved }}</td>
                        <td class="text-center">{{ material_data.balance }}</td>
                        <td>
                            {{ field }}
                            <div class="form-text">–ú–∞–∫—Å.: {{ material_data.reserved }}</div>
                        </td>
                    </tr>
                    {% endwith %}
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π -->
        <div class="mt-4">
            <div class="card">
                <div class="card-header">
                    <h5>üìä –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</h5>
                </div>
                <div class="card-body">
                    {% if operation_history %}
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>–î–∞—Ç–∞</th>
                                    <th>–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏</th>
                                    <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                                    <th>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</th>
                                    <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for op in operation_history %}
                                <tr>
                                    <td>{{ op.timestamp|date:"d.m.Y H:i" }}</td>
                                    <td>
                                        <span class="badge {% if op.type == 'receipt' %}bg-success{% else %}bg-danger{% endif %}">
                                            {% if op.type == 'receipt' %}–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ{% else %}–°–ø–∏—Å–∞–Ω–∏–µ{% endif %}
                                        </span>
                                    </td>
                                    <td>{{ op.quantity }} —à—Ç.</td>
                                    <td>{{ op.notes|default:"-" }}</td>
                                    <td>{{ op.user|default:"–°–∏—Å—Ç–µ–º–∞" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted text-center">–û–ø–µ—Ä–∞—Ü–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        <button type="submit" class="btn btn-primary">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Å–ø–∏—Å–∞–Ω–∏–µ</button>
    </div>
</form>

<script>
$(document).ready(function(){
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞
    $('#writeOffForm').on('submit', function(e){
        let isValid = true;
        let errorMessage = '';

        $('input[type="number"]').each(function() {
            const max = parseInt($(this).attr('max')) || 0;
            const val = parseInt($(this).val()) || 0;
            const balance = parseInt($(this).data('balance')) || 0;
            const materialName = $(this).closest('tr').find('td:first').text().trim();

            if (val < 0) {
                errorMessage += '‚Ä¢ ' + materialName + ': –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º\n';
                isValid = false;
            }
            if (val > max) {
                errorMessage += '‚Ä¢ ' + materialName + ': –Ω–µ–ª—å–∑—è —Å–ø–∏—Å–∞—Ç—å –±–æ–ª—å—à–µ —á–µ–º –æ—Å—Ç–∞–ª–æ—Å—å —Å–ø–∏—Å–∞—Ç—å (' + max + ')\n';
                isValid = false;
            }
            if (val > balance) {
                errorMessage += '‚Ä¢ ' + materialName + ': –Ω–µ–ª—å–∑—è —Å–ø–∏—Å–∞—Ç—å –±–æ–ª—å—à–µ —á–µ–º –µ—Å—Ç—å –Ω–∞ —Å–∫–ª–∞–¥–µ (' + balance + ')\n';
                isValid = false;
            }
        });

        if (!isValid) {
            e.preventDefault();
            alert('–û—à–∏–±–∫–∞ –≤ –¥–∞–Ω–Ω—ã—Ö:\n' + errorMessage);
        }
    });

    // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–µ—Ä–≤–æ–µ –ø–æ–ª–µ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
    $('input[type="number"]').first().focus();
});
</script>