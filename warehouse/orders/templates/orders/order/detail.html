{% extends "mebel/base.html" %}
{% load static %}
{% load order_extras %}
{% block title %}–ó–∞–∫–∞–∑ #{{ order.id }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-6">
        {% if order.blueprint %}
            <img src="{{ order.blueprint.url }}" class="img-fluid" alt="–ß–µ—Ä—Ç–µ–∂">
        {% endif %}
    </div>
    <div class="col-md-6">
        {% if order.visualization %}
            <img src="{{ order.visualization.url }}" class="img-fluid" alt="–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è">
        {% endif %}
    </div>
</div>
<div class="container mt-4">
  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∫–Ω–æ–ø–∫–∞–º–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>–ó–∞–∫–∞–∑ #{{ order.id }}</h1>
    <div>
        {% if user.groups.all.0.name == '–ú–µ–Ω–µ–¥–∂–µ—Ä—ã' or user.is_superuser %}
            <a href="{% url 'orders:order_edit' order.id %}" class="btn btn-warning me-2">
                <i class="bi bi-pencil"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–∫–∞–∑
            </a>
        {% endif %}

        {% if user.groups.all.0.name == '–û—Ç–¥–µ–ª –ú–¢–û' or user.is_superuser %}
            {% if order.items.exists %}
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#writeOffModal">
                <i class="bi bi-box-arrow-right"></i> –°–ø–∏—Å–∞—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã
            </button>
            {% endif %}
        {% endif %}
    </div>
  </div>

  <!-- –°–æ–æ–±—â–µ–Ω–∏—è –æ–± —É—Å–ø–µ—Ö–µ/–æ—à–∏–±–∫–∞—Ö -->
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}

  <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ -->
    <div class="row">
        <div class="col-md-6">
            <p><strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong><br>{{ order.order_name }}</p>
            <p><strong>–ò–º—è –∑–∞–∫–∞–∑—á–∏–∫–∞:</strong><br>{{ order.customer_name }}</p>
            <p><strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong><br>{{ order.get_category_display }}</p>
        </div>
        <div class="col-md-6">
            <p><strong>–ê–¥—Ä–µ—Å:</strong><br>{{ order.address }}</p>
            <p><strong>–ü–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞:</strong><br>{{ order.transferred_amount }} —Ä—É–±.</p>
            <p><strong>–°–∫–∏–¥–∫–∞:</strong><br>{{ order.discount }}%</p>
        </div>
    </div>

    <div class="col-md-6">
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title mb-0">üìä –°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞</h5>
        </div>
        <div class="card-body">
          <p><strong>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</strong> {{ order.created|date:"d.m.Y H:i" }}</p>
          <p><strong>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:</strong> {{ order.updated|date:"d.m.Y H:i" }}</p>
          <p>
            <strong>–°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã:</strong>
            <span class="badge
              {% if order.paid == 'fully_paid' %}bg-success
              {% elif order.paid == 'partially_paid' %}bg-warning
              {% else %}bg-danger{% endif %}">
              {{ order.get_paid_display }}
            </span>
          </p>
          <p><strong>ID –∑–∞–∫–∞–∑–∞:</strong> {{ order.id }}</p>
        </div>
      </div>
    </div>
        <!-- –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ –±–ª–æ–∫–∞ —Å —Å—Ç–∞—Ç—É—Å–æ–º –æ–ø–ª–∞—Ç—ã -->
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">üìÖ –°—Ä–æ–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</h5>
            </div>
            <div class="card-body">
                <p><strong>–î–∞—Ç–∞ —Å–¥–∞—á–∏:</strong> {{ order.deadline|date:"d.m.Y" }}</p>
                <p>
                    <strong>–°—Ç–∞—Ç—É—Å:</strong>
                    {% with deadline_status=order.get_deadline_status %}
                    <span class="badge bg-{{ deadline_status.class }}">
                        {{ deadline_status.icon }} {{ deadline_status.status }}
                    </span>
                    {% endwith %}
                </p>
                {% with days_until=order.deadline|timeuntil %}
                <p><strong>–û—Å—Ç–∞–ª–æ—Å—å:</strong> {{ days_until }}</p>
                {% endwith %}
            </div>
        </div>
    </div>
  </div>

  <!-- –ü–æ–∑–∏—Ü–∏–∏ –∑–∞–∫–∞–∑–∞ -->
  <div class="card mb-4">
      <div class="card-header">
          <h5 class="card-title mb-0">üì¶ –ü–æ–∑–∏—Ü–∏–∏ –∑–∞–∫–∞–∑–∞</h5>
      </div>
      <div class="card-body">
          <div class="table-responsive">
              <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>–ú–∞—Ç–µ—Ä–∏–∞–ª</th>
                            <th class="text-center">–¶–µ–Ω–∞ –∑–∞ —à—Ç.</th>
                            <th class="text-center">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ –∑–∞–∫–∞–∑—É</th>
                            <th class="text-center">–ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ</th>
                            <th class="text-center">–ë–∞–ª–∞–Ω—Å –Ω–∞ —Å–∫–ª–∞–¥–µ</th>
                            <th class="text-center">–°–ø–∏—Å–∞–Ω–æ</th>
                            <th class="text-end">–°—Ç–æ–∏–º–æ—Å—Ç—å</th>
                        </tr>
                    </thead>
                  <tbody>
                      {% for item in order.items.all %}
                        <tr>
                            <td>
                                <strong>{{ item.material.name }}</strong>
                                <br>
                                <small class="text-muted">–ö–∞—Ç–µ–≥–æ—Ä–∏—è: {{ item.material.category.name }}</small>
                            </td>
                            <td class="text-center">{{ item.price }} —Ä—É–±.</td>
                            <td class="text-center">{{ item.quantity }} —à—Ç.</td>
                            <td class="text-center">
                                <span class="badge bg-info">
                                    {{ item.material.reserved }} —à—Ç.
                                </span>
                            </td>
                            <td class="text-center">
                                <span class="badge {% if item.material.balance > 0 %}bg-success{% else %}bg-danger{% endif %}">
                                    {{ item.material.balance }} —à—Ç.
                                </span>
                            </td>
                            <td class="text-center">
                                <span class="badge {% if item.written_off > 0 %}bg-success{% else %}bg-secondary{% endif %}">
                                    {{ item.written_off }} —à—Ç. (–æ—Å—Ç–∞—Ç–æ–∫: {{ item.quantity|subtract:item.written_off }} —à—Ç.)
                                </span>
                            </td>
                            <td class="text-end"><strong>{{ item.get_cost }} —Ä—É–±.</strong></td>
                        </tr>
                      {% empty %}
                      <tr>
                          <td colspan="7" class="text-center text-muted py-4"> <!-- –ò–∑–º–µ–Ω–∏–ª–∏ colspan –Ω–∞ 7 -->
                              –í –∑–∞–∫–∞–∑–µ –Ω–µ—Ç –ø–æ–∑–∏—Ü–∏–π
                          </td>
                      </tr>
                      {% endfor %}
                  </tbody>
                  <tfoot class="table-group-divider">
                      <tr>
                          <td colspan="6" class="text-end"><strong>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</strong></td> <!-- –ò–∑–º–µ–Ω–∏–ª–∏ colspan –Ω–∞ 6 -->
                          <td class="text-end"><strong class="fs-5">{{ order.get_total_cost }} —Ä—É–±.</strong></td>
                      </tr>
                  </tfoot>
              </table>
          </div>
      </div>
  </div>

  <!-- –ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ -->
  <div class="d-flex justify-content-between">
    <a href="{% url 'orders:order_list' %}" class="btn btn-secondary">
      <i class="bi bi-arrow-left"></i> –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É –∑–∞–∫–∞–∑–æ–≤
    </a>
  </div>
</div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
  {% with modal_id="writeOffModal" modal_size="modal-xl" modal_ajax_url=order.get_write_off_url %}
  {% include "includes/modal.html" %}
  {% endwith %}

  <style>
    .card {
      box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
      border: 1px solid rgba(0, 0, 0, 0.125);
    }
    .card-header {
      background-color: #f8f9fa;
      border-bottom: 1px solid rgba(0, 0, 0, 0.125);
    }
    .table th {
      font-weight: 600;
      background-color: #f8f9fa;
    }
    .badge {
      font-size: 0.85em;
    }
    .alert {
      margin-bottom: 20px;
    }
  </style>
{% endblock %}

{% block domready %}
<!-- JS –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
<script>
    $(document).ready(function(){
        $('#writeOffModal').on('show.bs.modal', function (event) {
            var modal = $(this);
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ä–º—É —Å–ø–∏—Å–∞–Ω–∏—è –≤ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            $.ajax({
                url: "{% url 'orders:order_write_off' order.id %}",
                context: document.body,
                success: function(response) {
                    modal.find('.modal-content').html(response);
                },
                error: function() {
                    modal.find('.modal-content').html(
                        '<div class="modal-header">' +
                        '<h5 class="modal-title">–û—à–∏–±–∫–∞</h5>' +
                        '<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>' +
                        '</div>' +
                        '<div class="modal-body">' +
                        '<p class="text-danger">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ä–º—É —Å–ø–∏—Å–∞–Ω–∏—è.</p>' +
                        '</div>'
                    );
                }
            });
        });

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        $('#writeOffModal').on('hidden.bs.modal', function () {
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
            location.reload();
        });
    });
</script>
{% endblock %}