{% extends "mebel/base.html" %}
{% load static %}
{% load order_extras %}
{% block title %}–ó–∞–∫–∞–∑ #{{ order.id }}{% endblock %}

{% block extra_css %}
<style>
/* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π */
.image-modal {
    display: none;
    position: fixed;
    z-index: 1050;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.9);
    overflow: auto;
}

.image-modal-content {
    margin: auto;
    display: block;
    max-width: 90%;
    max-height: 90%;
    margin-top: 2%;
    animation: zoom 0.3s;
}

@keyframes zoom {
    from {transform: scale(0.8); opacity: 0;}
    to {transform: scale(1); opacity: 1;}
}

.close-modal {
    position: absolute;
    top: 15px;
    right: 35px;
    color: #fff;
    font-size: 40px;
    font-weight: bold;
    cursor: pointer;
    z-index: 1060;
}

.close-modal:hover {
    color: #ccc;
}

.image-controls {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1060;
}

.download-btn {
    background-color: #007bff;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    transition: background-color 0.3s;
}

.download-btn:hover {
    background-color: #0056b3;
}

.image-card {
    position: relative;
    cursor: pointer;
    transition: transform 0.3s;
}

.image-card:hover {
    transform: scale(1.02);
}

.image-card img {
    transition: opacity 0.3s;
}

.image-card:hover img {
    opacity: 0.9;
}

.image-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s;
}

.image-card:hover .image-overlay {
    opacity: 1;
}

.zoom-icon {
    color: white;
    font-size: 2rem;
    background: rgba(0, 0, 0, 0.7);
    border-radius: 50%;
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
}
</style>
{% endblock %}

{% block content %}
<!-- –ë–ª–æ–∫ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ - –û–ë–ù–û–í–õ–ï–ù–û -->
<div class="row mb-4">
    <div class="col-md-4">
        {% if order.blueprint %}
        <div class="card image-card" onclick="openImageModal('{{ order.blueprint.url }}', '–ß–µ—Ä—Ç–µ–∂ –∑–∞–∫–∞–∑–∞ #{{ order.id }}')">
            <div class="card-header">
                <h6 class="card-title mb-0">üìê –ß–µ—Ä—Ç–µ–∂</h6>
            </div>
            <div class="card-body text-center position-relative">
                <img src="{{ order.blueprint.url }}" class="img-fluid rounded" alt="–ß–µ—Ä—Ç–µ–∂" style="max-height: 200px;">
                <div class="image-overlay">
                    <div class="zoom-icon">
                        <i class="bi bi-search"></i>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    <div class="col-md-4">
        {% if order.visualization %}
        <div class="card image-card" onclick="openImageModal('{{ order.visualization.url }}', '–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–∫–∞–∑–∞ #{{ order.id }}')">
            <div class="card-header">
                <h6 class="card-title mb-0">üé® –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è</h6>
            </div>
            <div class="card-body text-center position-relative">
                <img src="{{ order.visualization.url }}" class="img-fluid rounded" alt="–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è" style="max-height: 200px;">
                <div class="image-overlay">
                    <div class="zoom-icon">
                        <i class="bi bi-search"></i>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    <div class="col-md-4">
        {% if order.installation_photo %}
        <div class="card image-card" onclick="openImageModal('{{ order.installation_photo.url }}', '–§–æ—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–∫–∞–∑–∞ #{{ order.id }}')">
            <div class="card-header">
                <h6 class="card-title mb-0">üì∏ –§–æ—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–∫–∏</h6>
            </div>
            <div class="card-body text-center position-relative">
                <img src="{{ order.installation_photo.url }}" class="img-fluid rounded" alt="–§–æ—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–∫–∏" style="max-height: 200px;">
                <div class="image-overlay">
                    <div class="zoom-icon">
                        <i class="bi bi-search"></i>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">üì∏ –§–æ—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–∫–∏</h6>
            </div>
            <div class="card-body text-center text-muted">
                <i class="bi bi-camera" style="font-size: 3rem;"></i>
                <p class="mt-2 mb-0">–§–æ—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ</p>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<div class="container mt-4">
  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∫–Ω–æ–ø–∫–∞–º–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>–ó–∞–∫–∞–∑ #{{ order.id }}</h1>
    <div>
        {% if user.groups.all.0.name == '–ú–µ–Ω–µ–¥–∂–µ—Ä—ã' or user.is_superuser %}
            <a href="{% url 'orders:order_edit' order.id %}" class="btn btn-warning me-2">
                <i class="bi bi-pencil"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–∫–∞–∑
            </a>
        {% endif %}

        {% if user.groups.all.0.name == '–û—Ç–¥–µ–ª –ú–¢–û' or user.is_superuser %}
            {% if order.items.exists %}
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#writeOffModal">
                <i class="bi bi-box-arrow-right"></i> –°–ø–∏—Å–∞—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã
            </button>
            {% endif %}
        {% endif %}
    </div>
  </div>

  <!-- –°–æ–æ–±—â–µ–Ω–∏—è –æ–± —É—Å–ø–µ—Ö–µ/–æ—à–∏–±–∫–∞—Ö -->
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}

  <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ -->
    <div class="row">
        <div class="col-md-6">
            <p><strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong><br>{{ order.order_name }}</p>
            <p><strong>–ò–º—è –∑–∞–∫–∞–∑—á–∏–∫–∞:</strong><br>{{ order.customer_name }}</p>
            <p><strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong><br>{{ order.get_category_display }}</p>
        </div>
        <div class="col-md-6">
            <p><strong>–ê–¥—Ä–µ—Å:</strong><br>{{ order.address }}</p>
            <p><strong>–ü–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞:</strong><br>{{ order.transferred_amount }} —Ä—É–±.</p>
            <p><strong>–°–∫–∏–¥–∫–∞:</strong><br>{{ order.discount }}%</p>
        </div>
    </div>

    <div class="col-md-6">
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title mb-0">üìä –°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞</h5>
        </div>
        <div class="card-body">
          <p><strong>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</strong> {{ order.created|date:"d.m.Y H:i" }}</p>
          <p><strong>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:</strong> {{ order.updated|date:"d.m.Y H:i" }}</p>
          <p>
            <strong>–°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã:</strong>
            <span class="badge
              {% if order.paid == 'fully_paid' %}bg-success
              {% elif order.paid == 'partially_paid' %}bg-warning
              {% else %}bg-danger{% endif %}">
              {{ order.get_paid_display }}
            </span>
          </p>
                <p>
                    <strong>–°—Ç–∞—Ç—É—Å —É—Å—Ç–∞–Ω–æ–≤–∫–∏:</strong>
                    <span class="badge
                    {% if order.installation_status == 'installed' %}bg-success
                    {% else %}bg-secondary{% endif %}">
                        {{ order.get_installation_status_display }}
                    </span>
                </p>
                <p>
                    <strong>–ó–∞–≤–µ—Ä—à–µ–Ω–æ:</strong>
                    <span class="badge
                    {% if order.is_completed %}bg-success
                    {% else %}bg-secondary{% endif %}">
                        {% if order.is_completed %}–î–∞{% else %}–ù–µ—Ç{% endif %}
                    </span>
                </p>
          <p><strong>ID –∑–∞–∫–∞–∑–∞:</strong> {{ order.id }}</p>
        </div>
      </div>
    </div>
        <!-- –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ –±–ª–æ–∫–∞ —Å —Å—Ç–∞—Ç—É—Å–æ–º –æ–ø–ª–∞—Ç—ã -->
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">üìÖ –°—Ä–æ–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</h5>
            </div>
            <div class="card-body">
                <p><strong>–î–∞—Ç–∞ —Å–¥–∞—á–∏:</strong> {{ order.deadline|date:"d.m.Y" }}</p>
                <p>
                    <strong>–°—Ç–∞—Ç—É—Å:</strong>
                    {% with deadline_status=order.get_deadline_status %}
                    <span class="badge bg-{{ deadline_status.class }}">
                        {{ deadline_status.icon }} {{ deadline_status.status }}
                    </span>
                    {% endwith %}
                </p>
                {% with days_until=order.deadline|timeuntil %}
                <p><strong>–û—Å—Ç–∞–ª–æ—Å—å:</strong> {{ days_until }}</p>
                {% endwith %}
            </div>
        </div>
    </div>
  </div>

  <!-- –ü–æ–∑–∏—Ü–∏–∏ –∑–∞–∫–∞–∑–∞ -->
  <div class="card mb-4">
      <div class="card-header">
          <h5 class="card-title mb-0">üì¶ –ü–æ–∑–∏—Ü–∏–∏ –∑–∞–∫–∞–∑–∞</h5>
      </div>
      <div class="card-body">
          <div class="table-responsive">
              <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>–ú–∞—Ç–µ—Ä–∏–∞–ª</th>
                            <th class="text-center">–¶–µ–Ω–∞ –∑–∞ —à—Ç.</th>
                            <th class="text-center">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ –∑–∞–∫–∞–∑—É</th>
                            <th class="text-center">–ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ</th>
                            <th class="text-center">–ë–∞–ª–∞–Ω—Å –Ω–∞ —Å–∫–ª–∞–¥–µ</th>
                            <th class="text-center">–°–ø–∏—Å–∞–Ω–æ</th>
                            <th class="text-end">–°—Ç–æ–∏–º–æ—Å—Ç—å</th>
                        </tr>
                    </thead>
                  <tbody>
                      {% for item in order.items.all %}
                        <tr>
                            <td>
                                <strong>{{ item.material.name }}</strong>
                                <br>
                                <small class="text-muted">–ö–∞—Ç–µ–≥–æ—Ä–∏—è: {{ item.material.category.name }}</small>
                            </td>
                            <td class="text-center">{{ item.price }} —Ä—É–±.</td>
                            <td class="text-center">{{ item.quantity }} —à—Ç.</td>
                            <td class="text-center">
                                <span class="badge bg-info">
                                    {{ item.material.reserved }} —à—Ç.
                                </span>
                            </td>
                            <td class="text-center">
                                <span class="badge {% if item.material.balance > 0 %}bg-success{% else %}bg-danger{% endif %}">
                                    {{ item.material.balance }} —à—Ç.
                                </span>
                            </td>
                            <td class="text-center">
                                <span class="badge {% if item.written_off > 0 %}bg-success{% else %}bg-secondary{% endif %}">
                                    {{ item.written_off }} —à—Ç. (–æ—Å—Ç–∞—Ç–æ–∫: {{ item.quantity|subtract:item.written_off }} —à—Ç.)
                                </span>
                            </td>
                            <td class="text-end"><strong>{{ item.get_cost }} —Ä—É–±.</strong></td>
                        </tr>
                      {% empty %}
                      <tr>
                          <td colspan="7" class="text-center text-muted py-4"> <!-- –ò–∑–º–µ–Ω–∏–ª–∏ colspan –Ω–∞ 7 -->
                              –í –∑–∞–∫–∞–∑–µ –Ω–µ—Ç –ø–æ–∑–∏—Ü–∏–π
                          </td>
                      </tr>
                      {% endfor %}
                  </tbody>
                  <tfoot class="table-group-divider">
                      <tr>
                          <td colspan="6" class="text-end"><strong>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</strong></td> <!-- –ò–∑–º–µ–Ω–∏–ª–∏ colspan –Ω–∞ 6 -->
                          <td class="text-end"><strong class="fs-5">{{ order.get_total_cost }} —Ä—É–±.</strong></td>
                      </tr>
                  </tfoot>
              </table>
          </div>
      </div>
  </div>

  <!-- –ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ -->
  <div class="d-flex justify-content-between">
    <a href="{% url 'orders:order_list' %}" class="btn btn-secondary">
      <i class="bi bi-arrow-left"></i> –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É –∑–∞–∫–∞–∑–æ–≤
    </a>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
<div id="imageModal" class="image-modal">
    <span class="close-modal" onclick="closeImageModal()">&times;</span>
    <img class="image-modal-content" id="modalImage">
    <div class="image-controls">
        <button class="download-btn" onclick="downloadImage()">
            <i class="bi bi-download"></i> –°–∫–∞—á–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        </button>
    </div>
</div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
  {% with modal_id="writeOffModal" modal_size="modal-xl" modal_ajax_url=order.get_write_off_url %}
  {% include "includes/modal.html" %}
  {% endwith %}

  <style>
    .card {
      box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
      border: 1px solid rgba(0, 0, 0, 0.125);
    }
    .card-header {
      background-color: #f8f9fa;
      border-bottom: 1px solid rgba(0, 0, 0, 0.125);
    }
    .table th {
      font-weight: 600;
      background-color: #f8f9fa;
    }
    .badge {
      font-size: 0.85em;
    }
    .alert {
      margin-bottom: 20px;
    }
  </style>
{% endblock %}

{% block domready %}
<!-- JS –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
<script>

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    let currentImageUrl = '';
    let currentImageTitle = '';

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
    function openImageModal(imageUrl, imageTitle) {
        currentImageUrl = imageUrl;
        currentImageTitle = imageTitle;

        const modal = document.getElementById('imageModal');
        const modalImg = document.getElementById('modalImage');

        modal.style.display = 'block';
        modalImg.src = imageUrl;
        modalImg.alt = imageTitle;

        // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É —Ñ–æ–Ω–æ–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.body.style.overflow = 'hidden';
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    function closeImageModal() {
        const modal = document.getElementById('imageModal');
        modal.style.display = 'none';

        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.body.style.overflow = 'auto';
    }

    // –§—É–Ω–∫—Ü–∏—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    function downloadImage() {
        if (!currentImageUrl) return;

        // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
        const link = document.createElement('a');
        link.href = currentImageUrl;

        // –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –∏–∑ URL
        const fileName = currentImageUrl.split('/').pop() || 'image';
        link.download = fileName;

        // –ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ –∫–ª–∏–∫–∞–µ–º –ø–æ —Å—Å—ã–ª–∫–µ
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    document.getElementById('imageModal').addEventListener('click', function(event) {
        if (event.target === this) {
            closeImageModal();
        }
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∫–ª–∞–≤–∏—à–µ–π ESC
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeImageModal();
        }
    });

    $(document).ready(function(){
        $('#writeOffModal').on('show.bs.modal', function (event) {
            var modal = $(this);
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ä–º—É —Å–ø–∏—Å–∞–Ω–∏—è –≤ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            $.ajax({
                url: "{% url 'orders:order_write_off' order.id %}",
                context: document.body,
                success: function(response) {
                    modal.find('.modal-content').html(response);
                },
                error: function() {
                    modal.find('.modal-content').html(
                        '<div class="modal-header">' +
                        '<h5 class="modal-title">–û—à–∏–±–∫–∞</h5>' +
                        '<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>' +
                        '</div>' +
                        '<div class="modal-body">' +
                        '<p class="text-danger">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ä–º—É —Å–ø–∏—Å–∞–Ω–∏—è.</p>' +
                        '</div>'
                    );
                }
            });
        });

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        $('#writeOffModal').on('hidden.bs.modal', function () {
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
            location.reload();
        });
    });
</script>
{% endblock %}