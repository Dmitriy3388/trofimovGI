{% extends "mebel/base.html" %}
{% load static %}
{% load order_extras %}
{% block title %}–ó–∞–∫–∞–∑ #{{ order.id }}{% endblock %}

{% block extra_css %}
<style>
.order-detail-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}

.page-header {
    text-align: center;
    margin-bottom: 40px;
}

.page-header h1 {
    color: #2c3e50;
    font-weight: 700;
    font-size: 2.5rem;
    margin-bottom: 10px;
}

.page-header p {
    color: #6b7280;
    font-size: 1.2rem;
}

.card-modern {
    background: white;
    border-radius: 16px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.08);
    border: none;
    overflow: hidden;
    margin-bottom: 25px;
}



.card-modern-title {
    color: white;
    font-weight: 600;
    margin: 0;
    font-size: 1.3rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

.card-modern-header {
    /* –£–±—Ä–∞—Ç—å background - –±—É–¥–µ—Ç –∏–∑ cards.css */
    color: white;  /* ‚Üê –î–û–ë–ê–í–ò–¢–¨ –≠–¢–£ –°–¢–†–û–ö–£ */
    padding: 20px 25px;
    border-bottom: 1px solid #e2e8f0;
}

.card-modern-body {
    padding: 25px;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ç—Ä–æ–∫ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π 11 */
.detail-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 15px 0;
    border-bottom: 1px solid #e2e8f0;
}

.detail-row:last-child {
    border-bottom: none;
}

.detail-label {
    font-weight: 600;
    color: #2c3e50;
    min-width: 200px;
}

.detail-value {
    color: #4b5563;
    text-align: right;
    flex: 1;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π */
.image-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    margin-bottom: 30px;
}

@media (max-width: 992px) {
    .image-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 768px) {
    .image-grid {
        grid-template-columns: 1fr;
    }
}

.image-card-modern {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 3px 10px rgba(0,0,0,0.08);
    transition: all 0.3s;
    cursor: pointer;
    height: 100%;
}

.image-card-modern:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.12);
}

.image-card-header {
    background: linear-gradient(135deg, #4361ee, #3a0ca3 100%);
    color: white;
    padding: 15px 20px;
    border-bottom: 1px solid #e2e8f0;
}

.image-card-title {
    color: white;
    font-weight: 600;
    margin: 0;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 8px;
}

.image-card-body {
    padding: 20px;
    text-align: center;
    height: 200px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    position: relative;
}

.image-card-body img {
    max-width: 100%;
    max-height: 160px;
    border-radius: 8px;
    transition: transform 0.3s;
}

.image-card-modern:hover .image-card-body img {
    transform: scale(1.05);
}

.image-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s;
    border-radius: 8px;
}

.image-card-modern:hover .image-overlay {
    opacity: 1;
}

.zoom-icon {
    color: white;
    font-size: 2rem;
    background: rgba(0, 0, 0, 0.7);
    border-radius: 50%;
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.no-image {
    color: #9ca3af;
    text-align: center;
}

.no-image-icon {
    font-size: 3rem;
    margin-bottom: 10px;
    color: #d1d5db;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ */
.table-modern {
    width: 100%;
    border-collapse: collapse;
}

.table-modern thead th {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    color: #2c3e50;
    font-weight: 600;
    padding: 15px;
    text-align: left;
    border-bottom: 2px solid #e2e8f0;
}

.table-modern tbody td {
    padding: 15px;
    border-bottom: 1px solid #f1f5f9;
    color: #4b5563;
}

.table-modern tbody tr:hover {
    background-color: #f8fafc;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –±–µ–π–¥–∂–µ–π */
.badge-modern {
    padding: 6px 12px;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.85rem;
}

.badge-success-modern {
    background: linear-gradient(135deg, #4ade80, #16a34a);
    color: white;
}

.badge-warning-modern {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    color: white;
}

.badge-danger-modern {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
}

.badge-info-modern {
    background: linear-gradient(135deg, #60a5fa, #3b82f6);
    color: white;
}

.badge-secondary-modern {
    background: linear-gradient(135deg, #9ca3af, #6b7280);
    color: white;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
.btn-modern {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 12px 30px;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
}

.btn-modern:hover {
    background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    color: white;
    text-decoration: none;
}

.btn-warning-modern {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
}

.btn-warning-modern:hover {
    background: linear-gradient(135deg, #e6900a 0%, #c46a05 100%);
}

.btn-outline-modern {
    background: transparent;
    border: 2px solid #667eea;
    color: #667eea;
}

.btn-outline-modern:hover {
    background: #667eea;
    color: white;
}

/* –î–µ–π—Å—Ç–≤–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ */
.card-actions {
    display: flex;
    gap: 12px;
    padding: 20px;
    background: #f8fafc;
    border-top: 1px solid #e2e8f0;
}

/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π */
.image-modal {
    display: none;
    position: fixed;
    z-index: 1050;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.9);
    overflow: auto;
}

.image-modal-content {
    margin: auto;
    display: block;
    max-width: 90%;
    max-height: 90%;
    margin-top: 2%;
    animation: zoom 0.3s;
}

@keyframes zoom {
    from {transform: scale(0.8); opacity: 0;}
    to {transform: scale(1); opacity: 1;}
}

.close-modal {
    position: absolute;
    top: 15px;
    right: 35px;
    color: #fff;
    font-size: 40px;
    font-weight: bold;
    cursor: pointer;
    z-index: 1060;
}

.close-modal:hover {
    color: #ccc;
}

.image-controls {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1060;
}

.download-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 8px;
}

.download-btn:hover {
    background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

/* –ê–Ω–∏–º–∞—Ü–∏–∏ */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.card-modern {
    animation: fadeInUp 0.6s ease-out;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 768px) {
    .order-detail-container {
        padding: 15px;
    }

    .page-header h1 {
        font-size: 2rem;
    }

    .detail-row {
        flex-direction: column;
        gap: 5px;
    }

    .detail-label {
        min-width: auto;
    }

    .detail-value {
        text-align: left;
    }

    .card-actions {
        flex-direction: column;
    }

    .btn-modern {
        width: 100%;
        justify-content: center;
    }

    .table-modern {
        font-size: 0.9rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="order-detail-container">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
    <div class="page-header">
        <h1>üìã –ó–∞–∫–∞–∑ #{{ order.id }}</h1>
        <p>–î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ</p>
    </div>

    <!-- –ë–ª–æ–∫ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ -->
    <div class="image-grid">
        <!-- –ß–µ—Ä—Ç–µ–∂ -->
        <div class="image-card-modern" onclick="openImageModal('{% if order.blueprint %}{{ order.blueprint.url }}{% endif %}', '–ß–µ—Ä—Ç–µ–∂ –∑–∞–∫–∞–∑–∞ #{{ order.id }}')">
            <div class="image-card-header">
                <h6 class="image-card-title">üìê –ß–µ—Ä—Ç–µ–∂</h6>
            </div>
            <div class="image-card-body">
                {% if order.blueprint %}
                <img src="{{ order.blueprint.url }}" alt="–ß–µ—Ä—Ç–µ–∂">
                <div class="image-overlay">
                    <div class="zoom-icon">
                        <i class="bi bi-search"></i>
                    </div>
                </div>
                {% else %}
                <div class="no-image">
                    <div class="no-image-icon">
                        <i class="bi bi-file-earmark"></i>
                    </div>
                    <p>–ß–µ—Ä—Ç–µ–∂ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è -->
        <div class="image-card-modern" onclick="openImageModal('{% if order.visualization %}{{ order.visualization.url }}{% endif %}', '–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–∫–∞–∑–∞ #{{ order.id }}')">
            <div class="image-card-header">
                <h6 class="image-card-title">üé® –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è</h6>
            </div>
            <div class="image-card-body">
                {% if order.visualization %}
                <img src="{{ order.visualization.url }}" alt="–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è">
                <div class="image-overlay">
                    <div class="zoom-icon">
                        <i class="bi bi-search"></i>
                    </div>
                </div>
                {% else %}
                <div class="no-image">
                    <div class="no-image-icon">
                        <i class="bi bi-image"></i>
                    </div>
                    <p>–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- –§–æ—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ -->
        <div class="image-card-modern" onclick="openImageModal('{% if order.installation_photo %}{{ order.installation_photo.url }}{% endif %}', '–§–æ—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–∫–∞–∑–∞ #{{ order.id }}')">
            <div class="image-card-header">
                <h6 class="image-card-title">üì∏ –§–æ—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–∫–∏</h6>
            </div>
            <div class="image-card-body">
                {% if order.installation_photo %}
                <img src="{{ order.installation_photo.url }}" alt="–§–æ—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–∫–∏">
                <div class="image-overlay">
                    <div class="zoom-icon">
                        <i class="bi bi-search"></i>
                    </div>
                </div>
                {% else %}
                <div class="no-image">
                    <div class="no-image-icon">
                        <i class="bi bi-camera"></i>
                    </div>
                    <p>–§–æ—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ -->
    <div class="row">
        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
        <div class="col-md-6">
            <div class="card-modern">
                <div class="card-modern-header">
                    <h5 class="card-modern-title">üìù –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>
                </div>
                <div class="card-modern-body">
                    <div class="detail-row">
                        <span class="detail-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞:</span>
                        <span class="detail-value">{{ order.order_name }}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">–ò–º—è –∑–∞–∫–∞–∑—á–∏–∫–∞:</span>
                        <span class="detail-value">{{ order.customer_name }}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</span>
                        <span class="detail-value">{{ order.get_category_display }}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">–ê–¥—Ä–µ—Å:</span>
                        <span class="detail-value">{{ order.address }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
        <div class="col-md-6">
            <div class="card-modern">
                <div class="card-modern-header">
                    <h5 class="card-modern-title">üí∞ –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>
                </div>
                <div class="card-modern-body">
                    <div class="detail-row">
                        <span class="detail-label">–ü–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞:</span>
                        <span class="detail-value">{{ order.transferred_amount }} —Ä—É–±.</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">–°–∫–∏–¥–∫–∞:</span>
                        <span class="detail-value">{{ order.discount }}%</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</span>
                        <span class="detail-value"><strong class="text-primary">{{ order.get_total_cost }} —Ä—É–±.</strong></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç—É—Å—ã –∏ —Å—Ä–æ–∫–∏ -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card-modern">
                <div class="card-modern-header">
                    <h5 class="card-modern-title">üìä –°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞</h5>
                </div>
                <div class="card-modern-body">
                    <div class="detail-row">
                        <span class="detail-label">–°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã:</span>
                        <span class="detail-value">
                            <span class="badge-modern
                                {% if order.paid == 'fully_paid' %}badge-success-modern
                                {% elif order.paid == 'partially_paid' %}badge-warning-modern
                                {% else %}badge-danger-modern{% endif %}">
                                {{ order.get_paid_display }}
                            </span>
                        </span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">–°—Ç–∞—Ç—É—Å —É—Å—Ç–∞–Ω–æ–≤–∫–∏:</span>
                        <span class="detail-value">
                            <span class="badge-modern
                                {% if order.installation_status == 'installed' %}badge-success-modern
                                {% else %}badge-secondary-modern{% endif %}">
                                {{ order.get_installation_status_display }}
                            </span>
                        </span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">–ó–∞–≤–µ—Ä—à–µ–Ω–æ:</span>
                        <span class="detail-value">
                            <span class="badge-modern
                                {% if order.is_completed %}badge-success-modern
                                {% else %}badge-secondary-modern{% endif %}">
                                {% if order.is_completed %}–î–∞{% else %}–ù–µ—Ç{% endif %}
                            </span>
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card-modern">
                <div class="card-modern-header">
                    <h5 class="card-modern-title">üìÖ –°—Ä–æ–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</h5>
                </div>
                <div class="card-modern-body">
                    <div class="detail-row">
                        <span class="detail-label">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</span>
                        <span class="detail-value">{{ order.created|date:"d.m.Y H:i" }}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">–î–∞—Ç–∞ —Å–¥–∞—á–∏:</span>
                        <span class="detail-value">{{ order.deadline|date:"d.m.Y" }}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">–°—Ç–∞—Ç—É—Å —Å—Ä–æ–∫–æ–≤:</span>
                        <span class="detail-value">
                            {% with deadline_status=order.get_deadline_status %}
                            <span class="badge-modern badge-{{ deadline_status.class }}-modern">
                                {{ deadline_status.icon }} {{ deadline_status.status }}
                            </span>
                            {% endwith %}
                        </span>
                    </div>
                    {% with days_until=order.deadline|timeuntil %}
                    <div class="detail-row">
                        <span class="detail-label">–û—Å—Ç–∞–ª–æ—Å—å:</span>
                        <span class="detail-value">{{ days_until }}</span>
                    </div>
                    {% endwith %}
                </div>
            </div>
        </div>
    </div>

    <!-- –ü–æ–∑–∏—Ü–∏–∏ –∑–∞–∫–∞–∑–∞ -->
    <div class="card-modern mt-4">
        <div class="card-modern-header">
            <h5 class="card-modern-title">üì¶ –ü–æ–∑–∏—Ü–∏–∏ –∑–∞–∫–∞–∑–∞</h5>
        </div>
        <div class="card-modern-body">
            {% if order.items.exists %}
            <div class="table-responsive">
                <table class="table-modern">
                    <thead>
                        <tr>
                            <th>–ú–∞—Ç–µ—Ä–∏–∞–ª</th>
                            <th class="text-center">–¶–µ–Ω–∞ –∑–∞ —à—Ç.</th>
                            <th class="text-center">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                            <th class="text-center">–ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ</th>
                            <th class="text-center">–ë–∞–ª–∞–Ω—Å –Ω–∞ —Å–∫–ª–∞–¥–µ</th>
                            <th class="text-center">–°–ø–∏—Å–∞–Ω–æ</th>
                            <th class="text-end">–°—Ç–æ–∏–º–æ—Å—Ç—å</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in order.items.all %}
                        <tr>
                            <td>
                                <strong>{{ item.material.name }}</strong>
                                <br>
                                <small class="text-muted">–ö–∞—Ç–µ–≥–æ—Ä–∏—è: {{ item.material.category.name }}</small>
                            </td>
                            <td class="text-center">{{ item.price }} —Ä—É–±.</td>
                            <td class="text-center">{{ item.quantity }} —à—Ç.</td>
                            <td class="text-center">
                                <span class="badge-modern badge-info-modern">
                                    {{ item.material.reserved }} —à—Ç.
                                </span>
                            </td>
                            <td class="text-center">
                                <span class="badge-modern
                                    {% if item.material.balance > 0 %}badge-success-modern
                                    {% else %}badge-danger-modern{% endif %}">
                                    {{ item.material.balance }} —à—Ç.
                                </span>
                            </td>
                            <td class="text-center">
                                <span class="badge-modern
                                    {% if item.written_off > 0 %}badge-success-modern
                                    {% else %}badge-secondary-modern{% endif %}">
                                    {{ item.written_off }} —à—Ç.
                                </span>
                                <br>
                                <small class="text-muted">–û—Å—Ç–∞—Ç–æ–∫: {{ item.quantity|subtract:item.written_off }} —à—Ç.</small>
                            </td>
                            <td class="text-end"><strong>{{ item.get_cost }} —Ä—É–±.</strong></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="6" class="text-end"><strong>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</strong></td>
                            <td class="text-end">
                                <span class="fs-5 text-primary fw-bold">{{ order.get_total_cost }} —Ä—É–±.</span>
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            {% else %}
            <div class="text-center py-4">
                <p class="text-muted">–í –∑–∞–∫–∞–∑–µ –Ω–µ—Ç –ø–æ–∑–∏—Ü–∏–π</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- –î–µ–π—Å—Ç–≤–∏—è -->
    <div class="card-actions">
        <a href="{% url 'orders:order_list' %}" class="btn-modern btn-outline-modern">
            <i class="bi bi-arrow-left"></i>
            –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É
        </a>

        {% if user.groups.all.0.name == '–ú–µ–Ω–µ–¥–∂–µ—Ä—ã' or user.is_superuser %}
        <a href="{% url 'orders:order_edit' order.id %}" class="btn-modern btn-warning-modern">
            <i class="bi bi-pencil-square"></i>
            –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–∫–∞–∑
        </a>
        {% endif %}

        {% if user.groups.all.0.name == '–û—Ç–¥–µ–ª –ú–¢–û' or user.is_superuser %}
            {% if order.items.exists %}
            <button type="button" class="btn-modern" data-bs-toggle="modal" data-bs-target="#writeOffModal">
                <i class="bi bi-box-arrow-right"></i>
                –°–ø–∏—Å–∞—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã
            </button>
            {% endif %}
        {% endif %}
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
<div id="imageModal" class="image-modal">
    <span class="close-modal" onclick="closeImageModal()">&times;</span>
    <img class="image-modal-content" id="modalImage">
    <div class="image-controls">
        <button class="download-btn" onclick="downloadImage()">
            <i class="bi bi-download"></i> –°–∫–∞—á–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        </button>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ -->
{% with modal_id="writeOffModal" modal_size="modal-xl" modal_ajax_url=order.get_write_off_url %}
{% include "includes/modal.html" %}
{% endwith %}
{% endblock %}

{% block domready %}
<script>
    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    let currentImageUrl = '';
    let currentImageTitle = '';

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
    function openImageModal(imageUrl, imageTitle) {
        if (!imageUrl || imageUrl.includes('undefined')) return;

        currentImageUrl = imageUrl;
        currentImageTitle = imageTitle;

        const modal = document.getElementById('imageModal');
        const modalImg = document.getElementById('modalImage');

        modal.style.display = 'block';
        modalImg.src = imageUrl;
        modalImg.alt = imageTitle;

        // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É —Ñ–æ–Ω–æ–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.body.style.overflow = 'hidden';
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    function closeImageModal() {
        const modal = document.getElementById('imageModal');
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    // –§—É–Ω–∫—Ü–∏—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    function downloadImage() {
        if (!currentImageUrl) return;

        const link = document.createElement('a');
        link.href = currentImageUrl;
        const fileName = currentImageUrl.split('/').pop() || 'image';
        link.download = fileName;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    document.getElementById('imageModal').addEventListener('click', function(event) {
        if (event.target === this) {
            closeImageModal();
        }
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∫–ª–∞–≤–∏—à–µ–π ESC
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeImageModal();
        }
    });

    // AJAX –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–ø–∏—Å–∞–Ω–∏—è
    $(document).ready(function(){
        $('#writeOffModal').on('show.bs.modal', function (event) {
            var modal = $(this);
            $.ajax({
                url: "{% url 'orders:order_write_off' order.id %}",
                success: function(response) {
                    modal.find('.modal-content').html(response);
                },
                error: function() {
                    modal.find('.modal-content').html(
                        '<div class="modal-header">' +
                        '<h5 class="modal-title">–û—à–∏–±–∫–∞</h5>' +
                        '<button type="button" class="btn-close" data-bs-dismiss="modal"></button>' +
                        '</div>' +
                        '<div class="modal-body">' +
                        '<p class="text-danger">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ä–º—É —Å–ø–∏—Å–∞–Ω–∏—è.</p>' +
                        '</div>'
                    );
                }
            });
        });

        $('#writeOffModal').on('hidden.bs.modal', function () {
            location.reload();
        });
    });
</script>
{% endblock %}