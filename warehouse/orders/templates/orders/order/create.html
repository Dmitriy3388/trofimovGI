{% extends "mebel/base.html" %}
{% load order_extras %}

{% block title %}Создание Заказа{% endblock %}

{% block content %}
  <h1>Создание Заказа</h1>

  <form method="post" class="order-form">
      {% csrf_token %}
      {% include "includes/form_errors.html" with form=form %}

      <!-- Обработка ошибок formsets -->
      {% if formset.errors %}
      <div class="alert alert-danger">
          <h6>Ошибки в позициях заказа:</h6>
          {{ formset.non_form_errors }}
          {% for form in formset %}
              {% if form.errors %}
              <div class="mb-2">
                  <strong>Позиция {{ forloop.counter }}:</strong>
                  <ul class="mb-0">
                      {% for field, errors in form.errors.items %}
                      <li>{{ field }}: {{ errors|striptags }}</li>
                      {% endfor %}
                  </ul>
              </div>
              {% endif %}
          {% endfor %}
      </div>
      {% endif %}

      <div class="order-info">
          <h3>Информация по заказу</h3>
          {{ form.as_p }}
      </div>

      <div class="materials-section">
          <h3>Комплектующие</h3>
          {{ formset.management_form }}

      <table class="materials-table">
        <thead>
          <tr>
            <th>Материал</th>
            <th>Количество</th>
            <th>Цена</th>
            <th>Удалить?</th>
          </tr>
        </thead>
        <tbody id="materials-tbody">
          {% for form in formset %}
          <tr class="material-form">
            <td>{{ form.material }}</td>
            <td>{{ form.quantity }}</td>
            <td class="price-cell" data-material-id="{{ form.material.value }}">
              {% if form.material.value %}
                <span class="price-placeholder">{{ form.material.value|get_material_price }} руб.</span>
              {% else %}
                —
              {% endif %}
            </td>
            <td>{% if form.DELETE %}{{ form.DELETE }}{% endif %}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <button type="button" id="add-more" class="btn">+ Добавить Материал</button>
    </div>

    <div class="total-price">
      <strong>Цена Заказа: </strong><span id="total-price">0</span> руб.
    </div>

    <input type="submit" value="Создать Заказ" class="submit-btn">
  </form>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Преобразуем Python словарь в JavaScript объект
        const materialPrices = JSON.parse('{{ material_prices_json|escapejs }}');

        // Получаем элемент управления formset
        const totalFormsInput = document.getElementById('id_items-TOTAL_FORMS');
        let formCount = parseInt(totalFormsInput.value);

        // Функция для добавления новой строки
        document.getElementById('add-more').addEventListener('click', function() {
            // Находим первую строку для клонирования
            const formRow = document.querySelector('.material-form');
            if (!formRow) return;

            // Клонируем строку
            const newRow = formRow.cloneNode(true);

            // Обновляем имена полей в новой строке
            const newRowHtml = newRow.innerHTML.replace(
                /items-\d+-/g,
                `items-${formCount}-`
            );
            newRow.innerHTML = newRowHtml;

            // Очищаем значения полей
            newRow.querySelectorAll('input, select').forEach(function(input) {
                if (input.name.includes('material') || input.name.includes('quantity')) {
                    input.value = '';
                }
                if (input.type === 'checkbox' && input.name.includes('DELETE')) {
                    input.checked = false;
                }
            });

            // Обновляем отображение цены
            const priceCell = newRow.querySelector('.price-cell');
            priceCell.innerHTML = '<span class="price-placeholder">—</span>';
            priceCell.dataset.materialId = '';
            priceCell.dataset.price = '0';

            // Добавляем новую строку в таблицу
            document.getElementById('materials-tbody').appendChild(newRow);

            // Увеличиваем счетчик форм
            formCount++;
            totalFormsInput.value = formCount;

            // Добавляем обработчики событий для новой строки
            addEventListenersToRow(newRow);
        });

        // Функция добавления обработчиков событий к строке
        function addEventListenersToRow(row) {
            const materialSelect = row.querySelector('select[name*="-material"]');
            const quantityInput = row.querySelector('input[name*="-quantity"]');

            if (materialSelect) {
                materialSelect.addEventListener('change', function() {
                    updateRowPrice(row);
                });
            }

            if (quantityInput) {
                quantityInput.addEventListener('input', updateTotal);
            }
        }

        // Функция обновления цены для конкретной строки
        function updateRowPrice(row) {
            const materialSelect = row.querySelector('select[name*="-material"]');
            const priceCell = row.querySelector('.price-cell');

            if (materialSelect && materialSelect.value) {
                const price = materialPrices[materialSelect.value] || '0.00';
                priceCell.innerHTML = `<span class="price-placeholder">${price} руб.</span>`;
                priceCell.dataset.price = price;
                priceCell.dataset.materialId = materialSelect.value;

                // Обновляем общую сумму
                updateTotal();
            } else {
                priceCell.innerHTML = '<span class="price-placeholder">—</span>';
                priceCell.dataset.price = '0';
                updateTotal();
            }
        }

        // Функция обновления общей суммы
        function updateTotal() {
            let total = 0;

            document.querySelectorAll('tr.material-form').forEach(row => {
                const priceCell = row.querySelector('.price-cell');
                const quantityInput = row.querySelector('input[name*="-quantity"]');

                if (priceCell && quantityInput) {
                    const price = parseFloat(priceCell.dataset.price || 0);
                    const quantity = parseFloat(quantityInput.value || 0);
                    total += price * quantity;
                }
            });

            document.getElementById('total-price').textContent = total.toFixed(2);
        }

        // Инициализация цен и обработчиков событий при загрузке
        document.querySelectorAll('tr.material-form').forEach(row => {
            addEventListenersToRow(row);
            updateRowPrice(row);
        });

        // Обновляем общую сумму при загрузке
        updateTotal();
    });
  </script>

  <style>
  .materials-table {
    width: 100%;
    margin: 20px 0;
    border-collapse: collapse;
  }
  .materials-table th, .materials-table td {
    padding: 8px;
    border: 1px solid #ddd;
    text-align: left;
  }
  .btn {
    padding: 5px 10px;
    background: #4CAF50;
    color: white;
    border: none;
    cursor: pointer;
    margin-top: 10px;
  }
  .total-price {
    margin: 20px 0;
    font-size: 1.2em;
  }
  </style>
{% endblock %}