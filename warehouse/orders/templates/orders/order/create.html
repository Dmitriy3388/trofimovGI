{% extends "mebel/base.html" %}
{% load order_extras %}

{% block title %}Создание Заказа{% endblock %}

{% block content %}
<h1>Создание Заказа</h1>

<form method="post" class="order-form" enctype="multipart/form-data">
    {% csrf_token %}
    {% include "includes/form_errors.html" with form=form %}

    <!-- Обработка ошибок formsets -->
    {% if formset.errors %}
    <div class="alert alert-danger">
        <h6>Ошибки в позициях заказа:</h6>
        {{ formset.non_form_errors }}
        {% for form in formset %}
            {% if form.errors %}
            <div class="mb-2">
                <strong>Позиция {{ forloop.counter }}:</strong>
                <ul class="mb-0">
                    {% for field, errors in form.errors.items %}
                    <li>{{ field }}: {{ errors|striptags }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        {% endfor %}
    </div>
    {% endif %}

    <!-- Загрузка изображений -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="form-group">
                <label for="{{ form.blueprint.id_for_label }}">{{ form.blueprint.label }}</label>
                {{ form.blueprint }}
                {% if form.blueprint.errors %}
                <div class="text-danger small">{{ form.blueprint.errors }}</div>
                {% endif %}
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label for="{{ form.visualization.id_for_label }}">{{ form.visualization.label }}</label>
                {{ form.visualization }}
                {% if form.visualization.errors %}
                <div class="text-danger small">{{ form.visualization.errors }}</div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Информация о заказе -->
    <div class="order-info mb-4">
        <h3>Информация по заказу</h3>
            <!-- В разделе "Информация о заказе" добавляем поле -->
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="{{ form.order_name.id_for_label }}">{{ form.order_name.label }}</label>
                        {{ form.order_name }}
                        {% if form.order_name.errors %}
                            <div class="text-danger small">{{ form.order_name.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="form-group">
                        <label for="{{ form.customer_name.id_for_label }}">{{ form.customer_name.label }}</label>
                        {{ form.customer_name }}
                        {% if form.customer_name.errors %}
                            <div class="text-danger small">{{ form.customer_name.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="{{ form.deadline.id_for_label }}">{{ form.deadline.label }}</label>
                        {{ form.deadline }}
                        {% if form.deadline.errors %}
                            <div class="text-danger small">{{ form.deadline.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="form-group">
                        <label for="{{ form.category.id_for_label }}">{{ form.category.label }}</label>
                        {{ form.category }}
                        {% if form.category.errors %}
                            <div class="text-danger small">{{ form.category.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="form-group">
                        <label for="{{ form.installation_status.id_for_label }}">{{ form.installation_status.label }}</label>
                        {{ form.installation_status }}
                        {% if form.installation_status.errors %}
                            <div class="text-danger small">{{ form.installation_status.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="{{ form.transferred_amount.id_for_label }}">{{ form.transferred_amount.label }}</label>
                    {{ form.transferred_amount }}
                    {% if form.transferred_amount.errors %}
                    <div class="text-danger small">{{ form.transferred_amount.errors }}</div>
                    {% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.discount.id_for_label }}">{{ form.discount.label }}</label>
                    {{ form.discount }}
                    {% if form.discount.errors %}
                    <div class="text-danger small">{{ form.discount.errors }}</div>
                    {% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.category.id_for_label }}">{{ form.category.label }}</label>
                    {{ form.category }}
                    {% if form.category.errors %}
                    <div class="text-danger small">{{ form.category.errors }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Материалы -->
    <div class="materials-section mb-4">
        <h3>Комплектующие</h3>
        {{ formset.management_form }}

        <table class="materials-table">
            <thead>
                <tr>
                    <th>Материал</th>
                    <th>Количество</th>
                    <th>Цена</th>
                    <th>Удалить?</th>
                </tr>
            </thead>
            <tbody id="materials-tbody">
                {% for form in formset %}
                <tr class="material-form">
                    <td>{{ form.material }}</td>
                    <td>{{ form.quantity }}</td>
                    <td class="price-cell" data-material-id="{{ form.material.value }}">
                        {% if form.material.value %}
                        <span class="price-placeholder">{{ form.material.value|get_material_price }} руб.</span>
                        {% else %}
                        ---
                        {% endif %}
                    </td>
                    <td>{% if form.DELETE %}{{ form.DELETE }}{% endif %}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <button type="button" id="add-more" class="btn">+ Добавить Материал</button>
    </div>

    <div class="total-price mb-4">
        <strong>Цена Заказа: </strong><span id="total-price">0</span> руб.
        <br>
        <small class="text-muted">(Стоимость материалов × 2 × (1 - скидка/100))</small>
    </div>

    <input type="submit" value="Создать Заказ" class="submit-btn">
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Преобразуем Python словарь в JavaScript объект
    const materialPrices = JSON.parse('{{ material_prices_json|escapejs }}');

    // Получаем элемент управления formset
    const totalFormsInput = document.getElementById('id_items-TOTAL_FORMS');
    let formCount = parseInt(totalFormsInput.value);

    // Функция для добавления новой строки
    document.getElementById('add-more').addEventListener('click', function() {
        // Находим первую строку для клонирования
        const formRow = document.querySelector('.material-form');
        if (!formRow) return;

        // Клонируем строку
        const newRow = formRow.cloneNode(true);

        // Обновляем имена полей в новой строке
        const newRowHtml = newRow.innerHTML.replace(
            /items-\d+-/g,
            `items-${formCount}-`
        );
        newRow.innerHTML = newRowHtml;

        // Очищаем значения полей
        newRow.querySelectorAll('input, select').forEach(function(input) {
            if (input.name.includes('material') || input.name.includes('quantity')) {
                input.value = '';
            }
            if (input.type === 'checkbox' && input.name.includes('DELETE')) {
                input.checked = false;
            }
        });

        // Обновляем отображение цены
        const priceCell = newRow.querySelector('.price-cell');
        priceCell.innerHTML = '<span class="price-placeholder">---</span>';
        priceCell.dataset.materialId = '';
        priceCell.dataset.price = '0';

        // Добавляем новую строку в таблицу
        document.getElementById('materials-tbody').appendChild(newRow);

        // Увеличиваем счетчик форм
        formCount++;
        totalFormsInput.value = formCount;

        // Добавляем обработчики событий для новой строки
        addEventListenersToRow(newRow);
    });

    // Функция добавления обработчиков событий к строке
    function addEventListenersToRow(row) {
        const materialSelect = row.querySelector('select[name*="-material"]');
        const quantityInput = row.querySelector('input[name*="-quantity"]');

        if (materialSelect) {
            materialSelect.addEventListener('change', function() {
                updateRowPrice(row);
            });
        }

        if (quantityInput) {
            quantityInput.addEventListener('input', updateTotal);
        }
    }

    // Функция обновления цены для конкретной строки
    function updateRowPrice(row) {
        const materialSelect = row.querySelector('select[name*="-material"]');
        const priceCell = row.querySelector('.price-cell');

        if (materialSelect && materialSelect.value) {
            const price = materialPrices[materialSelect.value] || '0.00';
            priceCell.innerHTML = `<span class="price-placeholder">${price} руб.</span>`;
            priceCell.dataset.price = price;
            priceCell.dataset.materialId = materialSelect.value;

            // Обновляем общую сумму
            updateTotal();
        } else {
            priceCell.innerHTML = '<span class="price-placeholder">---</span>';
            priceCell.dataset.price = '0';
            updateTotal();
        }
    }

// Функция обновления общей суммы
function updateTotal() {
    let materialsTotal = 0;

    document.querySelectorAll('tr.material-form').forEach(row => {
        const priceCell = row.querySelector('.price-cell');
        const quantityInput = row.querySelector('input[name*="-quantity"]');

        if (priceCell && quantityInput) {
            const price = parseFloat(priceCell.dataset.price || 0);
            const quantity = parseFloat(quantityInput.value || 0);
            materialsTotal += price * quantity;
        }
    });

    // Получаем значение скидки
    const discountInput = document.getElementById('{{ form.discount.id_for_label }}');
    const discount = parseFloat(discountInput.value || 0);

    // Рассчитываем итоговую стоимость: материалы * 2 * (1 - discount/100)
    const totalPrice = materialsTotal * 2 * (1 - discount / 100);

    document.getElementById('total-price').textContent = totalPrice.toFixed(2);
}

    // Инициализация цен и обработчиков событий при загрузке
    document.querySelectorAll('tr.material-form').forEach(row => {
        addEventListenersToRow(row);
        updateRowPrice(row);
    });

    // Добавляем обработчик для поля скидки
    const discountInput = document.getElementById('{{ form.discount.id_for_label }}');
    if (discountInput) {
        discountInput.addEventListener('input', updateTotal);
    }

    // Обновляем общую сумму при загрузке
    updateTotal();
});
</script>

<style>
.materials-table {
    width: 100%;
    margin: 20px 0;
    border-collapse: collapse;
}
.materials-table th, .materials-table td {
    padding: 8px;
    border: 1px solid #ddd;
    text-align: left;
}
.btn {
    padding: 5px 10px;
    background: #4CAF50;
    color: white;
    border: none;
    cursor: pointer;
    margin-top: 10px;
}
.total-price {
    margin: 20px 0;
    font-size: 1.2em;
}
.form-group {
    margin-bottom: 15px;
}

/* Добавляем в существующие стили */
.badge.bg-danger { background-color: #dc3545 !important; }
.badge.bg-warning { background-color: #ffc107 !important; color: #000 !important; }
.badge.bg-success { background-color: #28a745 !important; }
</style>
{% endblock %}