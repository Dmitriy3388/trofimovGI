{% extends "mebel/base.html" %}
{% load static %}

{% block title %}Order List{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<h1>Список заказов</h1>

<table class="order-list">
    <thead>
        <tr>
            <th>Имя заказа</th>
            <th>Дата создания</th>
            <th>Цена</th>
            <th>Оплата</th>
        </tr>
    </thead>
    <tbody>
        {% for order in page_obj %}
        <tr class="clickable-row" data-href="{% url 'orders:order_detail' order.id %}">
            <td>{{ order.first_name }} {{ order.last_name }}</td>
            <td>{{ order.created|date:"d.m.Y H:i" }}</td>
            <td>${{ order.get_total_cost }}</td>
            <td>
            {% if order.paid == 'fully_paid' %}
            <span style="color: green; font-weight: bold;">✓ Оплачено</span>
            {% elif order.paid == 'partially_paid' %}
            <span style="color: orange; font-weight: bold;">⏳ Оплачено частично</span>
            {% else %}
            <span style="color: red; font-weight: bold;">✗ Не оплачено</span>
            {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Пагинация -->
{% include "pagination.html" %}

<!-- График статусов оплаты -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title">Статистика заказов по статусам оплаты</h5>
    </div>
    <div class="card-body">
        <div style="height: 300px;"> <!-- Контейнер с фиксированной высотой -->
            <canvas id="paymentStatusChart"></canvas>
        </div>
    </div>
</div>

<style>
    .order-list {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
    }
    .order-list th, .order-list td {
        padding: 10px;
        border: 1px solid #ddd;
        text-align: left;
    }
    .clickable-row {
        cursor: pointer;
    }
    .clickable-row:hover {
        background-color: #f5f5f5;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const rows = document.querySelectorAll('.clickable-row');
        rows.forEach(row => {
            row.addEventListener('click', function() {
                window.location.href = this.dataset.href;
            });
        });

        // График статусов оплаты
        const ctx = document.getElementById('paymentStatusChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: {{ status_labels_json|safe }},
                datasets: [{
                    label: 'Количество заказов',
                    data: {{ status_data_json|safe }},
                    backgroundColor: {{ background_colors_json|safe }},
                    borderColor: {{ border_colors_json|safe }},
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    });
</script>
{% endblock %}