{% extends "mebel/base.html" %}
{% load static %}

{% block title %}–°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
/* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
.dashboard-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}

.page-header {
    text-align: center;
    margin-bottom: 30px;
}

.page-header h1 {
    color: #2c3e50;
    font-weight: 700;
    font-size: 2.5rem;
    margin-bottom: 10px;
}

.page-header p {
    color: #6b7280;
    font-size: 1.2rem;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ */
.card-modern {
    background: white;
    border-radius: 16px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.08);
    border: none;
    overflow: hidden;
    margin-bottom: 25px;
}

.card-modern-header {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    padding: 20px 25px;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.card-modern-title {
    color: #2c3e50;
    font-weight: 600;
    margin: 0;
    font-size: 1.3rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

/* –°–µ—Ç–∫–∞ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ –∏ —Ç–∞–±–ª–∏—Ü—ã */
.dashboard-grid {
    display: grid;
    grid-template-columns: 350px 1fr;
    gap: 25px;
    margin-bottom: 30px;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ */
.chart-card {
    height: fit-content;
}

.chart-container {
    position: relative;
    height: 280px;
    width: 100%;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã */
.table-card {
    min-height: 500px;
}

.table-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.btn-modern {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
}

.btn-modern:hover {
    background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    color: white;
    text-decoration: none;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã */
.order-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 12px;
    overflow: hidden;
    font-size: 0.85rem;
}

.order-table thead {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.order-table th {
    color: white;
    font-weight: 600;
    padding: 15px 12px;
    text-align: left;
    border: none;
    font-size: 0.9rem;
    white-space: nowrap;
    position: relative;
}

.order-table th a.sort-link {
    color: white !important;
    text-decoration: none;
    display: block;
    padding: 2px 0;
    transition: opacity 0.3s;
}

.order-table th a.sort-link:hover {
    opacity: 0.8;
    text-decoration: underline;
}

.order-table tbody tr {
    border-bottom: 1px solid #f1f5f9;
    transition: all 0.3s;
    cursor: pointer;
}

.order-table tbody tr:hover {
    background-color: #f8fafc;
    transform: translateX(5px);
}

.order-table tbody tr.completed-order {
    background-color: #f0f9f0;
    border-left: 4px solid #10b981;
}

.order-table td {
    padding: 12px;
    vertical-align: middle;
    border: none;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ –æ–ø–ª–∞—Ç—ã */
.paid-status {
    font-weight: bold;
    padding: 6px 10px;
    border-radius: 20px;
    font-size: 0.75rem;
    white-space: nowrap;
    display: inline-block;
    text-align: center;
    min-width: 60px;
}

.paid-fully {
    background: #d1fae5;
    color: #065f46;
    border: 1px solid #a7f3d0;
}

.paid-partially {
    background: #fef3c7;
    color: #92400e;
    border: 1px solid #fcd34d;
}

.paid-none {
    background: #fee2e2;
    color: #991b1b;
    border: 1px solid #fca5a5;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ —Å–¥–∞—á–∏ */
.deadline-status {
    font-size: 0.75rem;
    white-space: nowrap;
    padding: 6px 10px;
    border-radius: 20px;
    font-weight: 500;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ */
.installation-status {
    font-weight: bold;
    padding: 6px 10px;
    border-radius: 20px;
    font-size: 0.75rem;
    white-space: nowrap;
}

.installed {
    background: #d1fae5;
    color: #065f46;
}

.not-installed {
    background: #f3f4f6;
    color: #6b7280;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ */
.completed-badge {
    background: #d1fae5 !important;
    color: #065f46 !important;
    border: 1px solid #10b981;
    padding: 6px 12px;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.75rem;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Å—É–º–º */
.price-cell {
    font-family: 'Courier New', monospace;
    font-weight: 600;
    text-align: right;
    color: #2c3e50;
    font-size: 0.9rem;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –¥–∞—Ç */
.date-cell {
    white-space: nowrap;
    font-size: 0.8rem;
    color: #6b7280;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –Ω–∞–∑–≤–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞ */
.order-name {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 4px;
}

.customer-name {
    font-size: 0.8rem;
    color: #6b7280;
}

/* –ê–Ω–∏–º–∞—Ü–∏–∏ */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.card-modern {
    animation: fadeInUp 0.6s ease-out;
}

.dashboard-grid > *:nth-child(1) { animation-delay: 0.1s; }
.dashboard-grid > *:nth-child(2) { animation-delay: 0.2s; }

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 1200px) {
    .dashboard-grid {
        grid-template-columns: 1fr;
        gap: 20px;
    }

    .chart-card {
        order: 2;
    }

    .table-card {
        order: 1;
    }
}

@media (max-width: 992px) {
    .dashboard-container {
        padding: 15px;
    }

    .order-table th:nth-child(3), /* –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è */
    .order-table td:nth-child(3) {
        display: none;
    }
}

@media (max-width: 768px) {
    .dashboard-container {
        padding: 10px;
    }

    .page-header h1 {
        font-size: 2rem;
    }

    .card-modern-header {
        padding: 15px 20px;
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
    }

    .table-header {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
    }

    .order-table {
        font-size: 0.75rem;
    }

    .order-table th,
    .order-table td {
        padding: 10px 8px;
    }

    .order-table th:nth-child(7), /* –û–ø–ª–∞—Ç–∞ */
    .order-table td:nth-child(7) {
        display: none;
    }

    .chart-container {
        height: 250px;
    }
}

@media (max-width: 576px) {
    .page-header h1 {
        font-size: 1.8rem;
    }

    .page-header p {
        font-size: 1rem;
    }

    .order-table th:nth-child(4), /* –î–∞—Ç–∞ —Å–¥–∞—á–∏ */
    .order-table td:nth-child(4) {
        display: none;
    }

    .order-table th:nth-child(8), /* –ó–∞–≤–µ—Ä—à–µ–Ω–æ */
    .order-table td:nth-child(8) {
        display: none;
    }

    .btn-modern {
        width: 100%;
        justify-content: center;
    }
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –ø—É—Å—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è */
.no-data {
    text-align: center;
    padding: 60px 20px;
    color: #9ca3af;
}

.no-data p {
    margin: 0;
    font-size: 1.1rem;
}

/* –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ */
.chart-improved {
    border-radius: 12px;
    padding: 10px;
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
    <div class="page-header">
        <h1>üìã –°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤</h1>
        <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∑–∞–∫–∞–∑–æ–≤</p>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–∞—è —Å–µ—Ç–∫–∞: –≥—Ä–∞—Ñ–∏–∫ + —Ç–∞–±–ª–∏—Ü–∞ -->
    <div class="dashboard-grid">
        <!-- –ì—Ä–∞—Ñ–∏–∫ —Å—Ç–∞—Ç—É—Å–æ–≤ –æ–ø–ª–∞—Ç—ã -->
        <div class="card-modern chart-card">
            <div class="card-modern-header">
                <h5 class="card-modern-title">
                    üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–∫–∞–∑–æ–≤
                </h5>
            </div>
            <div class="card-modern-body">
                <div class="chart-container">
                    <canvas id="paymentStatusChart" class="chart-improved"></canvas>
                </div>
            </div>
        </div>

        <!-- –¢–∞–±–ª–∏—Ü–∞ –∑–∞–∫–∞–∑–æ–≤ -->
        <div class="card-modern table-card">
            <div class="card-modern-header">
                <h5 class="card-modern-title">
                    üì¶ –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã
                </h5>
                {% if user.groups.all.0.name == '–ú–µ–Ω–µ–¥–∂–µ—Ä—ã' or user.is_superuser %}
                <a href="{% url 'orders:order_create' %}" class="btn-modern">
                    <i class="bi bi-plus-circle"></i>
                    –î–æ–±–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑
                </a>
                {% endif %}
            </div>
            <div class="card-modern-body">
                {% if page_obj %}
                <div class="table-responsive">
                    <table class="order-table">
                        <thead>
                            <tr>
                                <th>
                                    <a href="?sort=order_name&order={% if current_sort == 'order_name' and current_order == 'asc' %}desc{% else %}asc{% endif %}" class="sort-link">
                                        –ó–∞–∫–∞–∑
                                        {% if current_sort == 'order_name' %}
                                            {% if current_order == 'asc' %}‚Üë{% else %}‚Üì{% endif %}
                                        {% endif %}
                                    </a>
                                </th>
                                <th class="date-cell">
                                    <a href="?sort=created&order={% if current_sort == 'created' and current_order == 'asc' %}desc{% else %}asc{% endif %}" class="sort-link">
                                        –°–æ–∑–¥–∞–Ω
                                        {% if current_sort == 'created' %}
                                            {% if current_order == 'asc' %}‚Üë{% else %}‚Üì{% endif %}
                                        {% endif %}
                                    </a>
                                </th>
                                <th class="date-cell">
                                    <a href="?sort=deadline&order={% if current_sort == 'deadline' and current_order == 'asc' %}desc{% else %}asc{% endif %}" class="sort-link">
                                        –°–¥–∞—á–∞
                                        {% if current_sort == 'deadline' %}
                                            {% if current_order == 'asc' %}‚Üë{% else %}‚Üì{% endif %}
                                        {% endif %}
                                    </a>
                                </th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>
                                    <a href="?sort=paid&order={% if current_sort == 'paid' and current_order == 'asc' %}desc{% else %}asc{% endif %}" class="sort-link">
                                        –û–ø–ª–∞—Ç–∞
                                        {% if current_sort == 'paid' %}
                                            {% if current_order == 'asc' %}‚Üë{% else %}‚Üì{% endif %}
                                        {% endif %}
                                    </a>
                                </th>
                                <th>
                                    <a href="?sort=installation_status&order={% if current_sort == 'installation_status' and current_order == 'asc' %}desc{% else %}asc{% endif %}" class="sort-link">
                                        –£—Å—Ç–∞–Ω–æ–≤–∫–∞
                                        {% if current_sort == 'installation_status' %}
                                        {% if current_order == 'asc' %}‚Üë{% else %}‚Üì{% endif %}
                                        {% endif %}
                                    </a>
                                </th>
                                <th>
                                    <a href="?sort=is_completed&order={% if current_sort == 'is_completed' and current_order == 'asc' %}desc{% else %}asc{% endif %}" class="sort-link">
                                        –ó–∞–≤–µ—Ä—à–µ–Ω–æ
                                        {% if current_sort == 'is_completed' %}
                                        {% if current_order == 'asc' %}‚Üë{% else %}‚Üì{% endif %}
                                        {% endif %}
                                    </a>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in page_obj %}
                            <tr class="{% if order.is_completed %}completed-order{% endif %}"
                                onclick="window.location='{% url 'orders:order_detail' order.id %}';"
                                style="cursor: pointer;">
                                <td>
                                    <div class="order-name">{{ order.order_name|truncatechars:25 }}</div>
                                    <div class="customer-name">{{ order.customer_name|truncatechars:20 }}</div>
                                </td>
                                <td class="date-cell">{{ order.created|date:"d.m.Y" }}</td>
                                <td class="date-cell">{{ order.deadline|date:"d.m.Y" }}</td>
                                <td>
                                    {% with deadline_status=order.get_deadline_status %}
                                    <span class="deadline-status" style="background: {{ deadline_status.bg_color }}; color: {{ deadline_status.text_color }};">
                                        {{ deadline_status.icon }}
                                    </span>
                                    {% endwith %}
                                </td>
                                <td>
                                    {% if order.paid == 'fully_paid' %}
                                        <span class="paid-status paid-fully" title="–ü–æ–ª–Ω–æ—Å—Ç—å—é –æ–ø–ª–∞—á–µ–Ω–æ">‚úì –û–ø–ª–∞—á–µ–Ω–æ</span>
                                    {% elif order.paid == 'partially_paid' %}
                                        <span class="paid-status paid-partially" title="–ß–∞—Å—Ç–∏—á–Ω–æ –æ–ø–ª–∞—á–µ–Ω–æ">‚è≥ –ß–∞—Å—Ç–∏—á–Ω–æ</span>
                                    {% else %}
                                        <span class="paid-status paid-none" title="–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ">‚úó –ù–µ –æ–ø–ª–∞—á–µ–Ω–æ</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if order.installation_status == 'installed' %}
                                    <span class="installation-status installed">‚úì –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ</span>
                                    {% else %}
                                    <span class="installation-status not-installed">‚úó –ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if order.is_completed %}
                                    <span class="completed-badge">‚úì –ó–∞–≤–µ—Ä—à–µ–Ω–æ</span>
                                    {% else %}
                                    <span style="color: #6b7280; font-size: 0.8rem;">–í —Ä–∞–±–æ—Ç–µ</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
                <div style="margin-top: 25px;">
                    {% include "pagination.html" %}
                </div>
                {% else %}
                <div class="no-data">
                    <p>üì≠ –ó–∞–∫–∞–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                    {% if user.groups.all.0.name == '–ú–µ–Ω–µ–¥–∂–µ—Ä—ã' or user.is_superuser %}
                    <a href="{% url 'orders:order_create' %}" class="btn-modern" style="margin-top: 15px;">
                        <i class="bi bi-plus-circle"></i>
                        –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑
                    </a>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // –ì—Ä–∞—Ñ–∏–∫ —Å—Ç–∞—Ç—É—Å–æ–≤ –æ–ø–ª–∞—Ç—ã —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º —Å—Ç–∏–ª–µ–º
    const ctx = document.getElementById('paymentStatusChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: {{ status_labels_json|safe }},
            datasets: [{
                data: {{ status_data_json|safe }},
                backgroundColor: [
                    'rgba(102, 126, 234, 0.8)',
                    'rgba(247, 183, 49, 0.8)',
                    'rgba(118, 75, 162, 0.8)',
                    'rgba(34, 197, 94, 0.8)',
                    'rgba(239, 68, 68, 0.8)'
                ],
                borderColor: [
                    'rgba(102, 126, 234, 1)',
                    'rgba(247, 183, 49, 1)',
                    'rgba(118, 75, 162, 1)',
                    'rgba(34, 197, 94, 1)',
                    'rgba(239, 68, 68, 1)'
                ],
                borderWidth: 2,
                borderRadius: 8,
                spacing: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '60%',
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        font: {
                            family: "'Inter', sans-serif",
                            size: 11
                        },
                        color: '#2c3e50',
                        padding: 15,
                        usePointStyle: true
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(44, 62, 80, 0.9)',
                    titleFont: {
                        family: "'Inter', sans-serif"
                    },
                    bodyFont: {
                        family: "'Inter', sans-serif"
                    },
                    padding: 12,
                    cornerRadius: 8
                }
            },
            animation: {
                animateScale: true,
                animateRotate: true
            }
        }
    });

    // –î–æ–±–∞–≤–ª—è–µ–º –ø–ª–∞–≤–Ω—É—é –ø—Ä–æ–∫—Ä—É—Ç–∫—É –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
    const tableRows = document.querySelectorAll('.order-table tbody tr');
    tableRows.forEach(row => {
        row.addEventListener('click', function(e) {
            e.preventDefault();
            const href = this.getAttribute('onclick').match(/'(.*?)'/)[1];
            window.location.href = href;
        });

        // –≠—Ñ—Ñ–µ–∫—Ç –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
        row.addEventListener('mouseenter', function() {
            this.style.transition = 'all 0.3s ease';
        });
    });
});
</script>
{% endblock %}